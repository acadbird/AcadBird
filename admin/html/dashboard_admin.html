<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AcadBird Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
<link rel="stylesheet" href="../style/dashboard_admin.css">
</head>
<body>
    <div class="page-wrapper">
        <div class="navbar">
            <div>
                <div class="logo">
                    <img src="../../main/img/AcadBird - White no text.png" alt="AcadBird Logo" class="logo-img" />
                    <img src="../../main/img/AcadBird - White Text.png" class="logo-text-img" alt="AcadBird Text">
                </div>
                <img src="../../main/img/sunhill.png" alt="AcadBird" class="middle-logo" />
                <div class="nav-icons">
                    <a href="notification_admin.html" target="_blank" title="Notifications">
                        <i class="fas fa-bell icon"></i>
                    </a>
                    <a href="help_admin.html" target="_blank" title="Help">
                        <i class="fas fa-question-circle icon"></i>
                    </a>
                    <a href="settings_admin.html" target="_blank" title="Settings">
                        <div class="account-menu">
                            <i class="fas fa-user-circle icon"></i>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="secondary-header">
           <div>
               <nav class="nav-menu">
                    <a href="dashboard_admin.html" class="nav-item active">Dashboard</a>
                    <a href="classes-management.html" class="nav-item">Class Management</a>
                    <a href="teacher-management.html" class="nav-item">Teacher Management</a>
                    <a href="calendar.html" class="nav-item">Calendar</a>
                    <a href="settings_admin.html" class="nav-item">Settings</a>

               </nav>
           </div>
        </div>
        
        <div class="separator"></div>

        <div class="main-content">
            
            <div class="left-panel">

                <div class="card admin-card">
                    <h2>Admin 1</h2>
                    <div>
                        <div>
                            <span>Sunhill</span>
                        </div>
                    </div>
                </div>

                    <h3 class="metric-title">Data Dashboard</h3>
                    
                    <div class="metric-card metric-card-green">
  <p id="classesCount">0</p>
  <p>Classes</p>
</div>
<div class="metric-card metric-card-blue">
  <p id="parentsCount">0</p>
  <p>Parents</p>
</div>
<div class="metric-card metric-card-orange">
  <p id="teachersCount">0</p>
  <p>Teachers</p>
</div>

                </a>

                
                
                </div>

            <div class="right-panel">

                <div style="display: flex; flex-direction: column; gap: 24px;">

                    <a href="/full-calendar-view" class="calendar-widget" onclick="handleCalendarClick(event)">
                        <span style="z-index: 10;"></span>

                        <div class="calendar-header">
                            <div>
                                <span>2025</span>
                                <div>
                                    <i class="fas fa-arrow-circle-left"></i>
                                    <span>March</span>
                                    <i class="fas fa-arrow-circle-right"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="calendar-grid">
                            <div>Sun</div>
                            <div>Mon</div>
                            <div>Tue</div>
                            <div>Wed</div>
                            <div>Thu</div>
                            <div>Fri</div>
                            <div>Sat</div>

                            <div class="prev-next-month">23</div>
                            <div class="prev-next-month">24</div>
                            <div class="prev-next-month">25</div>
                            <div class="prev-next-month">26</div>
                            <div class="prev-next-month">27</div>
                            <div class="prev-next-month">28</div>
                            <div class="prev-next-month today">1</div> <div>2</div>
                            <div>3</div>
                            <div>4</div>
                            <div>5</div>
                            <div>6</div>
                            <div>7</div>
                            <div>8</div>

                            <div>9</div>
                            <div>10</div>
                            <div>11</div>
                            <div class="event-day-group">
                                <div class="event-day">12</div>
                                <div class="tooltip">
                                    <p>Events on March 12</p>
                                    <div class="tooltip-event-list">
                                        <div class="tooltip-event">
                                            <span class="tooltip-dot tooltip-dot-green"></span>
                                            <span>Parent-Teacher Meeting</span>
                                            <span>(2:00 PM)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>13</div>
                            <div>14</div>
                            <div>15</div>
                            
                            <div>16</div>
                            <div>17</div>
                            <div>18</div>
                            <div class="active-day-group">
                                <div class="active-day">19</div>
                                <div class="tooltip">
                                    <p>Events on March 19</p>
                                    <div class="tooltip-event-list">
                                        <div class="tooltip-event">
                                            <span class="tooltip-dot tooltip-dot-yellow"></span>
                                            <span>Staff Meeting</span>
                                            <span>(9:00 AM)</span>
                                        </div>
                                        <div class="tooltip-event">
                                            <span class="tooltip-dot tooltip-dot-red"></span>
                                            <span>Deadline 1</span>
                                            <span>(5:00 PM)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>20</div>
                            <div>21</div>
                            <div>22</div>
                            
                            <div>23</div>
                            <div>24</div>
                            <div>25</div>
                            <div class="event-day-group">
                                <div class="event-day">26</div>
                                <div class="tooltip">
                                    <p>Events on March 26</p>
                                    <div class="tooltip-event-list">
                                        <div class="tooltip-event">
                                            <span class="tooltip-dot tooltip-dot-red"></span>
                                            <span>Project Submission</span>
                                            <span>(11:59 PM)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>27</div>
                            <div>28</div>
                            <div>29</div>
                            
                            <div>30</div>
                            <div>31</div>
                            <div class="prev-next-month">1</div>
                            <div class="prev-next-month">2</div>
                            <div class="prev-next-month">3</div>
                            <div class="prev-next-month">4</div>
                            <div class="prev-next-month">5</div>
                        </div>
                    </a>

                    <div class="visualizations-grid">
                        
                        <div class="user-pie-chart-card">
                            <h3>User Roles Distribution</h3>
                            <div class="pie-chart-container">
                                <div class="background"></div>
                                <div class="chart-slice" style="background: conic-gradient(#fbbd23 0% 20%, #115e59 20% 100%);"></div>
                                <div class="center-hole"></div>
                            </div>
                            <div class="pie-chart-legend">
                                <div>
                                    <div class="legend-item">
                                        <span class="legend-dot legend-dot-yellow"></span>
                                        <span>Parents (20%)</span>
                                    </div>
                                    <div class="legend-item">
                                        <span class="legend-dot legend-dot-teal"></span>
                                        <span>Teachers/Admin (80%)</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="logs-bar-chart-card">
    <h3>Logs Posted This Week</h3>
    <!-- Dropdown will be inserted here by JavaScript -->
    <!-- Week display will be inserted here by JavaScript -->
    <div class="logs-list">
        <!-- Content will be dynamically generated -->
    </div>
</div>
                    </div>
                </div>

                <div class="bottom-row-grid">
                    
                    <div class="active-classes-card">
                        <h3>Most Active Classes (Last 7 Days)</h3>
                        <div class="class-activity-list">
                            <div class="class-activity-item">
                                <div class="class-name-group">
                                    <i class="fas fa-book"></i>
                                    <span>Grade 1 - Maple</span>
                                </div>
                                <div class="class-bar-group">
                                    <div class="class-bar" style="width: 100px;"></div>
                                    <span class="class-count">120</span>
                                </div>
                            </div>
                            <div class="class-activity-item">
                                <div class="class-name-group">
                                    <i class="fas fa-book"></i>
                                    <span>Kinder - Rose</span>
                                </div>
                                <div class="class-bar-group">
                                    <div class="class-bar" style="width: 85px;"></div>
                                    <span class="class-count">105</span>
                                </div>
                            </div>
                            <div class="class-activity-item">
                                <div class="class-name-group">
                                    <i class="fas fa-book"></i>
                                    <span>Grade 5 - Oak</span>
                                </div>
                                <div class="class-bar-group">
                                    <div class="class-bar" style="width: 60px;"></div>
                                    <span class="class-count">80</span>
                                </div>
                            </div>
                            <div class="class-activity-item">
                                <div class="class-name-group">
                                    <i class="fas fa-book"></i>
                                    <span>Grade 2 - Pine</span>
                                </div>
                                <div class="class-bar-group">
                                    <div class="class-bar" style="width: 40px;"></div>
                                    <span class="class-count">60</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="resources-card">
                        <div>
                            <h3>Resources Used</h3>
                            <p>350</p>
                            <p>Total uploaded files this month</p>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
<script type="module">
  // Import Firebase SDK (v9+ modular style)
  import { 
    initializeApp 
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";

  import { 
    getFirestore, collection, getDocs, query, where, Timestamp 
  } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  // TODO: replace with your Firebase config
   const firebaseConfig = {
    apiKey: "AIzaSyB7gwN-3GVlJ-a_MTBxqVnc7Oltq5wSvHQ",
    authDomain: "acadbird-379e3.firebaseapp.com",
    projectId: "acadbird-379e3",
    storageBucket: "acadbird-379e3.firebasestorage.app",
    messagingSenderId: "575491576951",
    appId: "1:575491576951:web:70f86aba1e33b871f8a272",
    measurementId: "G-N6Z672SXWJ"
  };


  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Fetch Classes Count from "classroom" collection
  async function getClassesCount() {
    const snapshot = await getDocs(collection(db, "classrooms"));
    document.getElementById("classesCount").innerText = snapshot.size;
  }

  // Fetch Parents Count from "users" collection
  async function getParentsCount() {
    const q = query(collection(db, "users"), where("role", "==", "parent"));
    const snapshot = await getDocs(q);
    document.getElementById("parentsCount").innerText = snapshot.size;
  }

  // Fetch Teachers Count from "users" collection
  async function getTeachersCount() {
    const q = query(collection(db, "users"), where("role", "==", "teacher"));
    const snapshot = await getDocs(q);
    document.getElementById("teachersCount").innerText = snapshot.size;
  }

  // Fetch role counts (Parents, Teachers, Admin)
async function getUserRoleDistribution() {
  const usersSnapshot = await getDocs(collection(db, "users"));
  let parents = 0, teachers = 0, admins = 0;

  usersSnapshot.forEach(doc => {
    const role = doc.data().role;
    if (role === "parent") parents++;
    else if (role === "teacher") teachers++;
    else if (role === "admin") admins++;
  });

  const total = parents + teachers + admins;
  if (total === 0) return;

  const parentPercent = ((parents / total) * 100).toFixed(1);
  const teacherAdminPercent = (((teachers + admins) / total) * 100).toFixed(1);

  // Update chart dynamically
  document.querySelector(".chart-slice").style.background =
    `conic-gradient(#fbbd23 0% ${parentPercent}%, #115e59 ${parentPercent}% 100%)`;

  // Update legend labels
  document.querySelector(".legend-dot-yellow").nextElementSibling.textContent =
    `Parents (${parentPercent}%)`;
  document.querySelector(".legend-dot-teal").nextElementSibling.textContent =
    `Teachers/Admin (${teacherAdminPercent}%)`;
}

async function getClassroomNames() {
    const snapshot = await getDocs(collection(db, "classrooms"));
    let map = {};
    snapshot.forEach(doc => {
      map[doc.id] = doc.data().classroomName || "Unnamed Class";
    });
    return map;
  }

  // === Fetch activities last 7 days ===
 // === Fetch activities last 7 days ===
async function getMostActiveClasses() {
  const sevenDaysAgo = Timestamp.fromDate(
    new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
  );

  const q = query(collection(db, "activity"), where("created_at", ">", sevenDaysAgo));
  const snapshot = await getDocs(q);

  // Keep track of unique activityNo per classroom
  let classActivities = {};

  snapshot.forEach(doc => {
    const data = doc.data();
    const classId = data.classroomID;
    const activityNo = data.activityNo;

    if (!classActivities[classId]) {
      classActivities[classId] = new Set();
    }
    classActivities[classId].add(activityNo); // ensures uniqueness
  });

  // Convert to array with counts = size of Set
  let result = Object.entries(classActivities).map(([id, set]) => ({
    classroomID: id,
    classroomName: "", // will map later
    count: set.size
  }));

  // Get classroom names
  const classMap = await getClassroomNames();
  result.forEach(item => {
    item.classroomName = classMap[item.classroomID] || item.classroomID;
  });

  // Sort by activity count
  result.sort((a, b) => b.count - a.count);

  // Render to DOM
  const listEl = document.querySelector(".class-activity-list");
  listEl.innerHTML = "";

  result.forEach(item => {
    const div = document.createElement("div");
    div.classList.add("class-activity-item");
    div.innerHTML = `
      <div class="class-name-group">
        <i class="fas fa-book"></i>
        <span>${item.classroomName}</span>
      </div>
      <div class="class-bar-group">
        <div class="class-bar" style="width:${item.count * 20}px;"></div>
        <span class="class-count">${item.count}</span>
      </div>
    `;
    listEl.appendChild(div);
  });
}

// Fetch Logs Posted This Week with filtering (counting unique activityNo)
async function getLogsThisWeek(weekOffset = 0) {
  const now = new Date();
  const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
  
  // Calculate start of week (Monday)
  const startOfWeek = new Date(now);
  startOfWeek.setDate(now.getDate() - currentDay + (currentDay === 0 ? -6 : 1));
  startOfWeek.setHours(0, 0, 0, 0);
  
  // Apply week offset
  startOfWeek.setDate(startOfWeek.getDate() + (weekOffset * 7));
  
  // End of week (Sunday)
  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(startOfWeek.getDate() + 6);
  endOfWeek.setHours(23, 59, 59, 999);

  const startTimestamp = Timestamp.fromDate(startOfWeek);
  const endTimestamp = Timestamp.fromDate(endOfWeek);

  const q = query(
    collection(db, "activity"), 
    where("created_at", ">=", startTimestamp),
    where("created_at", "<=", endTimestamp)
  );
  
  const snapshot = await getDocs(q);

  // Group by day of week and track unique activityNo
  const dayCounts = {
    'Mon': new Set(),
    'Tue': new Set(),
    'Wed': new Set(),
    'Thu': new Set(),
    'Fri': new Set()
  };

  snapshot.forEach(doc => {
    const data = doc.data();
    const activityDate = data.created_at.toDate();
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const dayName = dayNames[activityDate.getDay()];
    
    // Only count weekdays Mon-Fri and track unique activityNo
    if (dayCounts.hasOwnProperty(dayName) && data.activityNo) {
      dayCounts[dayName].add(data.activityNo);
    }
  });

  // Convert Sets to counts
  const dayCountsResult = {
    'Mon': dayCounts['Mon'].size,
    'Tue': dayCounts['Tue'].size,
    'Wed': dayCounts['Wed'].size,
    'Thu': dayCounts['Thu'].size,
    'Fri': dayCounts['Fri'].size
  };

  // Update the DOM
  updateLogsChart(dayCountsResult, startOfWeek);
}

function updateLogsChart(dayCounts, weekStart) {
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
  const logsList = document.querySelector('.logs-list');
  
  // Find max count for percentage calculation
  const maxCount = Math.max(...Object.values(dayCounts));
  
  logsList.innerHTML = days.map(day => {
    const count = dayCounts[day];
    const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
    
    return `
      <div class="log-item">
        <span>${day}</span>
        <div class="log-bar-container">
          <div class="log-bar" style="width: ${percentage}%;"></div>
          <span class="log-count">${count}</span>
        </div>
      </div>
    `;
  }).join('');

  // Update week display
  updateWeekDisplay(weekStart);
}

function updateWeekDisplay(weekStart) {
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  
  const options = { month: 'short', day: 'numeric' };
  const weekDisplay = document.querySelector('.week-display');
  
  if (!weekDisplay) {
    // Create week display if it doesn't exist
    const logsCard = document.querySelector('.logs-bar-chart-card h3');
    const weekDisplayEl = document.createElement('div');
    weekDisplayEl.className = 'week-display';
    weekDisplayEl.style.cssText = 'font-size: 12px; color: #666; margin-top: 5px;';
    logsCard.parentNode.insertBefore(weekDisplayEl, logsCard.nextSibling);
  }
  
  document.querySelector('.week-display').textContent = 
    `Week of ${weekStart.toLocaleDateString('en-US', options)} - ${weekEnd.toLocaleDateString('en-US', options)}`;
}

// Create week filter dropdown
function createWeekFilter() {
  const logsHeader = document.querySelector('.logs-bar-chart-card h3');
  const dropdown = document.createElement('select');
  dropdown.className = 'week-filter';
  dropdown.style.cssText = `
    margin-left: 10px;
    padding: 2px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    font-size: 12px;
  `;
  
  dropdown.innerHTML = `
    <option value="0">This Week</option>
    <option value="-1">Last Week</option>
    <option value="-2">2 Weeks Ago</option>
    <option value="-3">3 Weeks Ago</option>
  `;
  
  dropdown.addEventListener('change', (e) => {
    getLogsThisWeek(parseInt(e.target.value));
  });
  
  logsHeader.parentNode.insertBefore(dropdown, logsHeader.nextSibling);
}

// Add this CSS for the dropdown (you can add to your CSS file)
const style = document.createElement('style');
style.textContent = `
  .week-filter {
    cursor: pointer;
  }
  .week-filter:focus {
    outline: none;
    border-color: #3b82f6;
  }
  .week-display {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
  }
`;
document.head.appendChild(style);

// Fetch total uploaded resources from "topicContent" collection
async function getResourcesUsed() {
  const snapshot = await getDocs(collection(db, "topicContent"));
  const totalResources = snapshot.size;

  // Update the DOM
  const resourcesCard = document.querySelector('.resources-card p:first-of-type');
  if (resourcesCard) {
    resourcesCard.textContent = totalResources;
  }
}

// Run after Firebase is initialized
getResourcesUsed();


// Initialize logs functionality
createWeekFilter();
getLogsThisWeek(0); // Load current week by default
// Also update your existing function calls to include the new logs function
// Remove or comment out the static logs HTML since we're generating dynamically

  // === Run ===
  getMostActiveClasses();


// Run after counts
getUserRoleDistribution();

  // Run all
  getClassesCount();
  getParentsCount();
  getTeachersCount();
</script>

</body>
</html>