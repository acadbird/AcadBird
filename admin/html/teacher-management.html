    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AcadBird Admin - Teacher Management</title>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
        <link rel="stylesheet" href="../style/teacher-management.css" />
    </head>
    <body>
        <div class="page-wrapper">
            <!-- Navbar -->
            <div class="navbar">
                <div class="navbar-container">
                    <div class="logo">
                        <img src="../../main/img/AcadBird - White no text.png" alt="AcadBird" class="logo-img" />
                        <img src="../../main/img/AcadBird - White Text.png" class="logo-text-img" alt="AcadBird Text">
                    </div>
                <img src="../../main/img/sunhill.png" alt="AcadBird" class="middle-logo" />
                    <div class="nav-icons">
                        <a href="notification_admin.html" title="Notifications">
                            <i class="fas fa-bell icon"></i>
                        </a>
                        <a href="help_admin.html" title="Help">
                            <i class="fas fa-question-circle icon"></i>
                        </a>
                        <a href="settings_admin.html" title="Settings">
                            <div class="account-menu">
                                <i class="fas fa-user-circle icon"></i>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Secondary Header -->
            <div class="secondary-header">
            <div class="secondary-header-container">
                <nav class="nav-menu">
                        <a href="dashboard_admin.html" class="nav-item">Dashboard</a>
                        <a href="classes-management.html" class="nav-item">Class Management</a> 
                        <a href="teacher-management.html" class="nav-item active">Teacher Management</a>
                        <a href="calendar.html" class="nav-item">Calendar</a>
                        <a href="settings_admin.html" class="nav-item">Settings</a>
                </nav>
            </div>
            </div>
            
            <div class="separator"></div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="admin-card">
                        <h2>Admin 1</h2>
                        <div>
                            <span>Sunhill Academy</span>
                        </div>
                    </div>

                    <div class="metrics-container">
                        <h3 class="metric-title">Teacher Metrics</h3>
                        
                        <div class="metric-card metric-card-green">
                            <p id="metric-active-teachers">5</p>
                            <p>Active Teachers</p>
                        </div>
                        <div class="metric-card metric-card-blue">
                            <p id="metric-total-teachers">7</p>
                            <p>Total Teachers</p>
                        </div>
                        <div class="metric-card metric-card-orange">
                            <p id="metric-unassigned-teachers">2</p>
                            <p>Available for Classes</p>
                        </div>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="content-area">
                    <div class="teacher-directory">
                        <h2>Teacher Directory üßë‚Äçüè´</h2>
                        
                        <div class="controls-container">
                            <div class="search-container">
                                <input type="text" id="search-input" class="search-input" placeholder="Search by Teacher Name or Email">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            
                            <div class="filters-container">
                                <select id="filter-status" class="filter-select">
                                    <option value="">Filter by Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Archived">Archived</option>
                                </select>
                                
                                <button id="add-teacher-btn" class="add-teacher-btn">
                                    <i class="fas fa-user-plus"></i> Add Teacher
                                </button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="teachers-table">
                                <thead>
                                    <tr>
                                        <th>Teacher Name</th>
                                        <th>Email</th>
                                        <th>Classes Taught</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="teachers-table-body">
                                    <!-- Teachers will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination-container">
                            <p class="pagination-info">Showing all <span id="pagination-total">7</span> teachers</p>
                        </div>
                    </div>
                    
                    <div class="quick-action-card" id="quick-add-teacher">
                        <h3 class="quick-action-title">Quick Action</h3>
                        <div class="quick-action-content">
                            <i class="fas fa-plus-circle"></i>
                            <p>Add New Teacher</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Teacher Modal -->
        <!-- Add/Edit Teacher Modal -->
<div id="teacher-modal" class="modal">
    <div class="modal-content large">
        <button class="close-button" id="close-teacher-modal">&times;</button>
        <h2 class="modal-title" id="teacher-modal-title">Add New Teacher ‚ûï</h2>
        
        <form id="teacher-form">
            <input type="hidden" id="teacher-id">
            
            <div class="form-row">
                <div class="form-group">
                    <label for="teacher-first-name">First Name:</label>
                    <input type="text" id="teacher-first-name" name="firstName" placeholder="Enter first name" required>
                </div>
                
                <div class="form-group">
                    <label for="teacher-last-name">Last Name:</label>
                    <input type="text" id="teacher-last-name" name="lastName" placeholder="Enter last name" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="teacher-email">Email Address:</label>
                <input type="email" id="teacher-email" name="email" placeholder="Enter email address" required>
            </div>

           
            
            <div class="form-group">
                <label>Classes Taught (Select all that apply):</label>
                <div class="multi-select-container" id="classes-taught-multiselect">
                    <!-- Classes will be populated by JavaScript -->
                </div>
                <p class="form-note">Classes assigned here will update the *unassigned* status in Class Management.</p>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancel-teacher">Cancel</button>
                <button type="submit" class="btn btn-primary" id="teacher-form-submit-btn">Add Teacher</button>
            </div>
        </form>
    </div>
</div>
        <!-- Archive Confirmation Modal -->
        <div id="archive-confirmation-modal" class="modal confirmation-modal">
            <div class="modal-content">
                <button class="close-button" id="close-archive-modal">&times;</button>
                <h2 class="modal-title">Archive Teacher</h2>
                
                <p class="confirmation-message">Are you sure you want to archive <span id="archive-teacher-name" class="font-bold"></span>?</p>
                <p class="confirmation-warning">Archived teachers will no longer appear in active lists but can be restored later.</p>
                
                <div class="confirmation-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-archive">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirm-archive-btn">Archive Teacher</button>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div id="delete-confirmation-modal" class="modal confirmation-modal">
            <div class="modal-content">
                <button class="close-button" id="close-delete-modal">&times;</button>
                <h2 class="modal-title">Confirm Deletion</h2>
                
                <p class="confirmation-message">Are you sure you want to delete <span id="delete-teacher-name" class="font-bold"></span>?</p>
                <p class="confirmation-warning">This action cannot be undone.</p>
                
                <div class="confirmation-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-delete">Cancel</button>
                    <button type="button" class="btn btn-delete" id="confirm-delete-btn">Delete Teacher</button>
                </div>
            </div>
        </div>

        <script type="module">
import { 
    getFirestore, collection, getDocs, query, where, doc, getDoc, addDoc, setDoc, updateDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { 
    getAuth, createUserWithEmailAndPassword 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB7gwN-3GVlJ-a_MTBxqVnc7Oltq5wSvHQ",
    authDomain: "acadbird-379e3.firebaseapp.com",
    projectId: "acadbird-379e3",
    storageBucket: "acadbird-379e3.firebasestorage.app",
    messagingSenderId: "575491576951",
    appId: "1:575491576951:web:70f86aba1e33b871f8a272",
    measurementId: "G-N6Z672SXWJ"
  };


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
const auth = getAuth(app);
    // =========================================================================================
    // DATA STRUCTURES
    // =========================================================================================

    // Sample Class Data
    const allClasses = [
        { id: 1, name: 'Kinder Lily' },
        { id: 2, name: 'Grade 1 Daisy' },
        { id: 3, name: 'Kinder Rose' },
        { id: 4, name: 'Grade 2 Maple' },
        { id: 5, name: 'Grade 3 Tulip' },
        { id: 6, name: 'Grade 4 Cedar' },
    ];

    // Sample Teacher Data (for modal operations - will be replaced by Firestore data)
    let teachersData = [
        { id: 1, name: 'Ms. Rose', email: 'rose@acadbird.edu', classes: ['Kinder Lily', 'Grade 2 Maple'], status: 'Active' },
        { id: 2, name: 'Mr. David', email: 'david@acadbird.edu', classes: ['Grade 1 Daisy'], status: 'Active' },
        { id: 3, name: 'Mrs. Smith', email: 'smith@acadbird.edu', classes: [], status: 'Inactive' },
    ];

    // =========================================================================================
    // CORE FUNCTIONS
    // =========================================================================================

    // DOM Elements
    const tableBody = document.getElementById('teachers-table-body');
    const searchInput = document.getElementById('search-input');
    const filterStatus = document.getElementById('filter-status');
    const teacherModal = document.getElementById('teacher-modal');
    const teacherForm = document.getElementById('teacher-form');
    const classesTaughtMultiselect = document.getElementById('classes-taught-multiselect');
    const archiveConfirmationModal = document.getElementById('archive-confirmation-modal');
    const archiveTeacherNameSpan = document.getElementById('archive-teacher-name');
    const confirmArchiveBtn = document.getElementById('confirm-archive-btn');
    const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
    const deleteTeacherNameSpan = document.getElementById('delete-teacher-name');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

    // State variables
    let teacherToArchiveId = null;
    let teacherToDeleteId = null;
    let currentTeachersData = [];

    // --- Modal Control Functions ---
    function openModal(modalElement) {
        modalElement.style.display = 'flex';
    }

    function closeModal(modalElement) {
        modalElement.style.display = 'none';
    }

    function closeTeacherModal() {
        closeModal(teacherModal);
        teacherForm.reset();
    }

    function closeArchiveConfirmationModal() {
        closeModal(archiveConfirmationModal);
        teacherToArchiveId = null;
    }

    function closeDeleteConfirmationModal() {
        closeModal(deleteConfirmationModal);
        teacherToDeleteId = null;
    }

    // --- Metrics Update ---
    async function updateMetrics() {
        try {
            // üîπ Total Teachers: Count of users with role == "teacher"
            const teachersQuery = query(collection(db, "users"), where("role", "==", "teacher"));
            const teachersSnap = await getDocs(teachersQuery);
            const totalTeachers = teachersSnap.size;
            
            // üîπ Active Teachers: Teachers who have at least one classroom assigned
            const classroomsSnap = await getDocs(collection(db, "classrooms"));
            
            // Get all teacher IDs that have classrooms assigned (excluding null/unassigned)
            const teachersWithClassrooms = new Set();
            classroomsSnap.forEach(classroomDoc => {
                const classroom = classroomDoc.data();
                if (classroom.teacherId && classroom.teacherId !== "unassigned") {
                    teachersWithClassrooms.add(classroom.teacherId);
                }
            });
            
            const activeTeachers = teachersWithClassrooms.size;
            
            // üîπ Available for Classes: Teachers without classrooms assigned
            const availableForClasses = totalTeachers - activeTeachers;

            // Update the UI
            document.getElementById('metric-active-teachers').textContent = activeTeachers;
            document.getElementById('metric-total-teachers').textContent = totalTeachers;
            document.getElementById('metric-unassigned-teachers').textContent = availableForClasses;

        } catch (err) {
            console.error("Error fetching metrics:", err);
            // Fallback to showing 0 if there's an error
            document.getElementById('metric-active-teachers').textContent = '0';
            document.getElementById('metric-total-teachers').textContent = '0';
            document.getElementById('metric-unassigned-teachers').textContent = '0';
        }
    }

    // --- Rendering Functions ---
 

async function populateClassesMultiselect(container, assignedClasses = [], teacherId = '') {
    console.log('üîç populateClassesMultiselect called with:', {
        container: container.id,
        assignedClasses: assignedClasses,
        teacherId: teacherId
    });
    
    container.innerHTML = '<div class="loading-text">Loading classes...</div>';

    try {
        const classroomsSnap = await getDocs(collection(db, "classrooms"));
        console.log('üìö Total classrooms found:', classroomsSnap.size);
        
        container.innerHTML = '';

        if (classroomsSnap.empty) {
            console.log('‚ùå No classrooms available in database');
            container.innerHTML = '<div class="no-classes-text">No classrooms available</div>';
            return;
        }

        let availableCount = 0;
        let unassignedCount = 0;
        let assignedCount = 0;
        let assignedToThisTeacherCount = 0;

        // Get the current teacher's classrooms to exclude them
        const thisTeachersClassrooms = new Set(assignedClasses);

        classroomsSnap.forEach(classDoc => {
            const classData = classDoc.data();
            const classId = classDoc.id;
            const className = classData.classroomName || "Unnamed Class";
            const teacherIdField = classData.teacherId; // ‚Üê FIXED: Use teacherId (lowercase d)

            console.log(`üè´ Classroom: "${className}", teacherId:`, teacherIdField);

            // Check if this classroom is assigned to the current teacher
            const isAssignedToThisTeacher = thisTeachersClassrooms.has(className);
            
            // ONLY show classrooms that are unassigned AND not already assigned to this teacher
            const isUnassigned = !teacherIdField || teacherIdField === "" || teacherIdField === "unassigned";
            const shouldShow = isUnassigned && !isAssignedToThisTeacher;
            
            if (shouldShow) {
                unassignedCount++;
                
                const isChecked = false; // Always false since we're only showing NEW classrooms to assign
                
                console.log(`‚úÖ Available classroom to assign: "${className}", Checked: ${isChecked}`);

                const option = document.createElement('div');
                option.classList.add('select-option');
                option.innerHTML = `
                    <input type="checkbox" id="class-${classId}" name="classes" value="${className}" ${isChecked ? 'checked' : ''}>
                    <label for="class-${classId}">${className}</label>
                `;
                container.appendChild(option);
                availableCount++;
            } else if (isAssignedToThisTeacher) {
                assignedToThisTeacherCount++;
                console.log(`üìå Classroom "${className}" is already assigned to this teacher, excluding from list`);
            } else {
                assignedCount++;
                console.log(`‚ùå Classroom "${className}" is assigned to another teacher: ${teacherIdField}, skipping`);
            }
        });

        console.log('üìä Classroom Summary:', {
            total: classroomsSnap.size,
            unassigned: unassignedCount,
            assignedToThisTeacher: assignedToThisTeacherCount,
            assignedToOthers: assignedCount,
            availableInList: availableCount
        });

        if (availableCount === 0) {
            console.log('‚ö†Ô∏è No available classrooms to assign');
            container.innerHTML = '<div class="no-classes-text">No available classrooms to assign</div>';
        } else {
            console.log(`‚úÖ Loaded ${availableCount} available classrooms into multiselect`);
        }

    } catch (err) {
        console.error("‚ùå Error loading classes:", err);
        container.innerHTML = '<div class="error-text">Error loading classes</div>';
    }
}
// When assigning classes to teachers, update the classroom documents
// When assigning classes to teachers, update the classroom documents
async function updateClassroomTeacher(classroomId, teacherId) {
    try {
        await updateDoc(doc(db, "classrooms", classroomId), {
            teacherId: teacherId // ‚Üê FIXED: Use teacherId (lowercase d)
        });
    } catch (err) {
        console.error("Error updating classroom:", err);
        throw err;
    }
}
// Update the renderTeacherTable function to handle the new name structure
async function renderTeacherTable() {
    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Loading teachers...</td></tr>';
    
    try {
        // Fetch teachers from Firestore
        const teachersQuery = query(collection(db, "users"), where("role", "==", "teacher"));
        const teachersSnap = await getDocs(teachersQuery);
        
        // Fetch classrooms to determine which teachers have classes
        const classroomsSnap = await getDocs(collection(db, "classrooms"));
        
        // Create a map of teacherId -> classroom names
        const teacherClassroomsMap = new Map();
        classroomsSnap.forEach(classroomDoc => {
            const classroom = classroomDoc.data();
            if (classroom.teacherId && classroom.teacherId !== "unassigned") {
                if (!teacherClassroomsMap.has(classroom.teacherId)) {
                    teacherClassroomsMap.set(classroom.teacherId, []);
                }
                teacherClassroomsMap.get(classroom.teacherId).push(classroom.classroomName || "Unnamed Class");
            }
        });

        tableBody.innerHTML = '';
        currentTeachersData = [];
        
        if (teachersSnap.empty) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No teachers found</td></tr>';
        } else {
            teachersSnap.forEach(docSnap => {
                const teacher = docSnap.data();
                const teacherId = docSnap.id;
                
                // Get teacher's name using the new structure
                const teacherName = teacher.fullName || 
                                  (teacher.firstName && teacher.lastName ? `${teacher.firstName} ${teacher.lastName}` : 
                                  teacher.name || "Unknown Teacher");
                
                // Get teacher's email
                const teacherEmail = teacher.email || "No email";
                
                // Get classes taught (from teacher's data or from classroom assignments)
                const classesFromProfile = teacher.classesTaught || [];
                const classesFromAssignments = teacherClassroomsMap.get(teacherId) || [];
                const classesTaught = [...new Set([...classesFromProfile, ...classesFromAssignments])];
                const classesDisplay = classesTaught.length > 0 ? classesTaught.join(', ') : 'None';
                
                // Determine status
                const status = teacher.status || (classesTaught.length > 0 ? 'Active' : 'Available');
                const statusClass = status === 'Active' ? 'status-active' : 
                                   status === 'Inactive' ? 'status-inactive' : 'status-archived';

                // Store teacher data for filtering
                currentTeachersData.push({
                    id: teacherId,
                    name: teacherName,
                    firstName: teacher.firstName,
                    lastName: teacher.lastName,
                    email: teacherEmail,
                    classes: classesTaught,
                    status: status
                });

                const newRow = tableBody.insertRow();
                newRow.setAttribute('data-id', teacherId);
                
                newRow.innerHTML = `
                    <td>
                        <a href="teacher_profile.html?id=${teacherId}" class="teacher-name-link" data-teacher-id="${teacherId}">
    ${teacherName}
</a>
                    </td>
                    <td>${teacherEmail}</td>
                    <td class="text-sm italic">${classesDisplay}</td>
                    <td><span class="${statusClass}">${status}</span></td>
                    <td class="whitespace-nowrap">
                        <button class="action-btn edit-btn" title="Edit Teacher">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn archive-btn" title="Archive Teacher">
                            <i class="fas fa-archive"></i>
                        </button>
                        <button class="action-btn delete-btn" title="Delete Teacher">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        // Update pagination info
        document.getElementById('pagination-total').textContent = teachersSnap.size;
        
        // Update metrics
        await updateMetrics();
        attachRowEventListeners();
        
    } catch (err) {
        console.error("Error loading teachers:", err);
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-600">Error loading teachers</td></tr>';
    }
}
    // --- Filter and Search Functions ---
    async function applyFiltersAndSearch() {
        const searchTerm = searchInput.value.toLowerCase();
        const filterValue = filterStatus.value;
        
        try {
            // Use cached data for filtering
            let filteredData = currentTeachersData;

            if (searchTerm) {
                filteredData = filteredData.filter(teacher => 
                    teacher.name.toLowerCase().includes(searchTerm) || 
                    teacher.email.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filterValue) {
                filteredData = filteredData.filter(teacher => teacher.status === filterValue);
            }
            
            renderFilteredTable(filteredData);
            
        } catch (err) {
            console.error("Error applying filters:", err);
        }
    }

    function renderFilteredTable(filteredTeachers) {
        tableBody.innerHTML = '';
        
        if (filteredTeachers.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No teachers found</td></tr>';
        } else {
            filteredTeachers.forEach(teacher => {
                const classesDisplay = teacher.classes.length > 0 ? teacher.classes.join(', ') : 'None';
                const statusClass = teacher.status === 'Active' ? 'status-active' : 'status-inactive';

                const newRow = tableBody.insertRow();
                newRow.setAttribute('data-id', teacher.id);
                
                newRow.innerHTML = `
                    <td>
                        <a href="teacher-profile.html?id=${teacher.id}" class="teacher-name-link" data-teacher-id="${teacher.id}">
                            ${teacher.name}
                        </a>
                    </td>
                    <td>${teacher.email}</td>
                    <td class="text-sm italic">${classesDisplay}</td>
                    <td><span class="${statusClass}">${teacher.status}</span></td>
                    <td class="whitespace-nowrap">
                        <button class="action-btn edit-btn" title="Edit Teacher">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn archive-btn" title="Archive Teacher">
                            <i class="fas fa-archive"></i>
                        </button>
                        <button class="action-btn delete-btn" title="Delete Teacher">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        document.getElementById('pagination-total').textContent = filteredTeachers.length;
        attachRowEventListeners();
    }

    // --- Modal Functions ---
    // --- Modal Functions ---
function openTeacherModal(teacherData = null) {
    console.log('üéØ openTeacherModal called with teacherData:', teacherData);
    
    const teacherIdInput = document.getElementById('teacher-id');
    const teacherFirstNameInput = document.getElementById('teacher-first-name');
    const teacherLastNameInput = document.getElementById('teacher-last-name');
    const teacherEmailInput = document.getElementById('teacher-email');
    const teacherModalTitle = document.getElementById('teacher-modal-title');
    const teacherFormSubmitBtn = document.getElementById('teacher-form-submit-btn');

    teacherForm.reset();
    if (teacherData) {
        // Edit Mode
        console.log('‚úèÔ∏è EDIT MODE - Teacher data:', teacherData);
        teacherModalTitle.textContent = `Edit Teacher: ${teacherData.name} üìù`;
        teacherFormSubmitBtn.textContent = 'Save Changes';
        teacherIdInput.value = teacherData.id;
        
        // Split full name into first and last name
        const nameParts = teacherData.name.split(' ');
        teacherFirstNameInput.value = nameParts[0] || '';
        teacherLastNameInput.value = nameParts.slice(1).join(' ') || '';
        
        teacherEmailInput.value = teacherData.email;
        
        console.log('üìã Calling populateClassesMultiselect with assignedClasses:', teacherData.classes);
        // Only show unassigned classrooms (teacherID parameter not needed anymore)
        populateClassesMultiselect(classesTaughtMultiselect, teacherData.classes);
    } else {
        // Add Mode - show only unassigned classrooms
        console.log('‚ûï ADD MODE - Creating new teacher');
        teacherModalTitle.textContent = 'Add New Teacher ‚ûï';
        teacherFormSubmitBtn.textContent = 'Add Teacher';
        teacherIdInput.value = '';
        teacherFirstNameInput.value = '';
        teacherLastNameInput.value = '';
        teacherEmailInput.value = '';
        console.log('üìã Calling populateClassesMultiselect with empty assignedClasses');
        populateClassesMultiselect(classesTaughtMultiselect, []);
    }
    openModal(teacherModal);
}
async function handleTeacherFormSubmission(e) {
    e.preventDefault();
    console.log('üìù Teacher form submitted');
    
    const teacherIdInput = document.getElementById('teacher-id');
    const teacherFirstNameInput = document.getElementById('teacher-first-name');
    const teacherLastNameInput = document.getElementById('teacher-last-name');
    const teacherEmailInput = document.getElementById('teacher-email');

    const firstName = teacherFirstNameInput.value.trim();
    const lastName = teacherLastNameInput.value.trim();
    const email = teacherEmailInput.value.trim();
    
    // Get selected classes from checkboxes
    const selectedClassCheckboxes = classesTaughtMultiselect.querySelectorAll('input[type="checkbox"]:checked');
    const classesTaught = Array.from(selectedClassCheckboxes).map(cb => cb.value);
    
    const isEditMode = !!teacherIdInput.value;
    const teacherId = teacherIdInput.value;
    
    // Basic validation
    if (!firstName || !lastName || !email) {
        alert("Please fill out all required fields.");
        return;
    }

    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert("Please enter a valid email address.");
        return;
    }

    try {
        // Check if email already exists in Firestore (only for new teachers, not for edits)
        if (!isEditMode) {
            const emailCheckQuery = query(collection(db, "users"), where("email", "==", email));
            const emailCheckSnap = await getDocs(emailCheckQuery);
            
            if (!emailCheckSnap.empty) {
                alert("A teacher with this email already exists.");
                return;
            }
        }

        let finalTeacherId = teacherId;
        
        if (isEditMode) {
            // Update existing teacher
            const teacherData = {
                firstName: firstName,
                lastName: lastName,
                fullName: `${firstName} ${lastName}`,
                email: email,
                classesTaught: classesTaught,
                updatedAt: serverTimestamp()
            };

            await updateDoc(doc(db, "users", teacherId), teacherData);
            alert(`SUCCESS: Teacher "${firstName} ${lastName}" updated!`);
        } else {
            // CREATE NEW TEACHER IN FIREBASE AUTHENTICATION
            const password = "TempPassword123!"; // You can generate a random password or set a default
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const authUid = userCredential.user.uid;
            
            // Create teacher data for Firestore
            const teacherData = {
                uid: authUid, // Store the auth UID in Firestore
                firstName: firstName,
                lastName: lastName,
                fullName: `${firstName} ${lastName}`,
                email: email,
                role: "teacher",
                classesTaught: classesTaught,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };

            // Add to Firestore with the same UID as authentication
            await setDoc(doc(db, "users", authUid), teacherData);
            finalTeacherId = authUid;
            
            alert(`SUCCESS: Teacher "${firstName} ${lastName}" created! Account email: ${email}`);
        }
        
        // UPDATE CLASSROOM ASSIGNMENTS
        const classroomsSnap = await getDocs(collection(db, "classrooms"));
        const classroomUpdates = [];
        
        // Process all selected classrooms
        for (const checkbox of selectedClassCheckboxes) {
            const classroomName = checkbox.value;
            
            const classroomDoc = classroomsSnap.docs.find(doc => 
                doc.data().classroomName === classroomName
            );
            
            if (classroomDoc) {
                classroomUpdates.push(
                    updateDoc(doc(db, "classrooms", classroomDoc.id), {
                        teacherId: finalTeacherId,
                        status: "active"
                    })
                );
            }
        }
        
        // Handle unassigning for edit mode
        if (isEditMode) {
            const allClassCheckboxes = classesTaughtMultiselect.querySelectorAll('input[type="checkbox"]');
            const deselectedClasses = Array.from(allClassCheckboxes)
                .filter(cb => !cb.checked)
                .map(cb => cb.value);
            
            for (const classroomName of deselectedClasses) {
                const classroomDoc = classroomsSnap.docs.find(doc => 
                    doc.data().classroomName === classroomName && 
                    doc.data().teacherId === finalTeacherId
                );
                
                if (classroomDoc) {
                    classroomUpdates.push(
                        updateDoc(doc(db, "classrooms", classroomDoc.id), {
                            teacherId: "",
                            status: "pending"
                        })
                    );
                }
            }
        }
        
        if (classroomUpdates.length > 0) {
            await Promise.all(classroomUpdates);
        }
        
        closeTeacherModal();
        await renderTeacherTable();
        
    } catch (err) {
        console.error("Error saving teacher:", err);
        
        // Handle specific authentication errors
        if (err.code === 'auth/email-already-in-use') {
            alert("This email is already registered in the system.");
        } else if (err.code === 'auth/invalid-email') {
            alert("Please enter a valid email address.");
        } else if (err.code === 'auth/weak-password') {
            alert("The password is too weak.");
        } else {
            alert("Failed to save teacher. Please try again.");
        }
    }
}

    function openArchiveConfirmationModal(teacherId, teacherName) {
        teacherToArchiveId = teacherId;
        archiveTeacherNameSpan.textContent = teacherName;
        openModal(archiveConfirmationModal);
    }

    function archiveTeacher(teacherId) {
        // Note: This would need to update Firestore in a real implementation
        const teacherIndex = teachersData.findIndex(t => t.id === teacherId);
        if (teacherIndex !== -1) {
            teachersData[teacherIndex].status = 'Archived';
            alert(`Teacher "${teachersData[teacherIndex].name}" has been archived.`);
            renderTeacherTable(); // Reload from Firestore
        }
        closeArchiveConfirmationModal();
    }

    function openDeleteConfirmationModal(teacherId, teacherName) {
        teacherToDeleteId = teacherId;
        deleteTeacherNameSpan.textContent = teacherName;
        openModal(deleteConfirmationModal);
    }

    function deleteTeacher(teacherId) {
        // Note: This would need to delete from Firestore in a real implementation
        const teacherIndex = teachersData.findIndex(t => t.id === teacherId);
        if (teacherIndex !== -1) {
            const teacherName = teachersData[teacherIndex].name;
            teachersData.splice(teacherIndex, 1);
            alert(`Teacher "${teacherName}" has been deleted.`);
            renderTeacherTable(); // Reload from Firestore
        }
        closeDeleteConfirmationModal();
    }

    // --- Event Listeners ---
    function attachRowEventListeners() {
        // Edit buttons
        tableBody.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const row = e.target.closest('tr');
                const teacherId = row.getAttribute('data-id');
                const teacher = currentTeachersData.find(t => t.id === teacherId);
                if (teacher) {
                    openTeacherModal(teacher);
                }
            });
        });

        // Archive buttons
        tableBody.querySelectorAll('.archive-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const row = e.target.closest('tr');
                const teacherId = row.getAttribute('data-id');
                const teacherName = row.cells[0].querySelector('.teacher-name-link').textContent;
                openArchiveConfirmationModal(teacherId, teacherName);
            });
        });
        
        // Delete buttons
        tableBody.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const row = e.target.closest('tr');
                const teacherId = row.getAttribute('data-id');
                const teacherName = row.cells[0].querySelector('.teacher-name-link').textContent;
                openDeleteConfirmationModal(teacherId, teacherName);
            });
        });
    }

    function init() {
        // Form submission handlers
        teacherForm.addEventListener('submit', handleTeacherFormSubmission);
        
        // Archive confirmation button
        confirmArchiveBtn.addEventListener('click', () => {
            if (teacherToArchiveId) {
                archiveTeacher(teacherToArchiveId);
            }
        });
        
        // Delete confirmation button
        confirmDeleteBtn.addEventListener('click', () => {
            if (teacherToDeleteId) {
                deleteTeacher(teacherToDeleteId);
            }
        });

        // Add Teacher button listeners
        document.getElementById('add-teacher-btn').addEventListener('click', () => openTeacherModal());
        document.getElementById('quick-add-teacher').addEventListener('click', () => openTeacherModal());

        // Modal close buttons
        document.getElementById('close-teacher-modal').addEventListener('click', closeTeacherModal);
        document.getElementById('close-archive-modal').addEventListener('click', closeArchiveConfirmationModal);
        document.getElementById('close-delete-modal').addEventListener('click', closeDeleteConfirmationModal);
        document.getElementById('cancel-teacher').addEventListener('click', closeTeacherModal);
        document.getElementById('cancel-archive').addEventListener('click', closeArchiveConfirmationModal);
        document.getElementById('cancel-delete').addEventListener('click', closeDeleteConfirmationModal);

        // Search and Filter listeners
        searchInput.addEventListener('input', applyFiltersAndSearch);
        filterStatus.addEventListener('change', applyFiltersAndSearch);
        
        // Initial render with real data
        renderTeacherTable();
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', init);
    </script>
    </body>
    </html>