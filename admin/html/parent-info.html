<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AcadBird Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="stylesheet" href="../style/parent-info.css" />
    <style>
      /* Notification badge styles */
      .notification-link {
        position: relative;
        display: inline-block;
      }

      .notification-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: #ff4444;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        font-weight: bold;
        display: none;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* Table styles */
      .students-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .students-table th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e9ecef;
      }

      .students-table td {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
      }

      .students-table tr:last-child td {
        border-bottom: none;
      }

      .students-table tr:hover {
        background: #f8f9fa;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .edit-btn {
        background: #3498db;
        color: white;
      }

      .edit-btn:hover {
        background: #2980b9;
      }

      .delete-btn {
        background: #e74c3c;
        color: white;
      }

      .delete-btn:hover {
        background: #c0392b;
      }

      .parent-info-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .parent-info-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
      }

      .parent-details h1 {
        margin: 0 0 5px 0;
        font-size: 28px;
        color: #333;
      }

      .parent-details p {
        margin: 5px 0;
        color: #666;
        font-size: 16px;
      }

      .parent-status {
        background: #27ae60;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .info-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #3498db;
      }

      .info-item strong {
        display: block;
        margin-bottom: 5px;
        color: #333;
      }

      .info-item span {
        color: #666;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 15px;
      }

      .modal-title {
        margin: 0;
        font-size: 24px;
        color: #333;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
      }

      .close-modal:hover {
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .form-group input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
      }

      .form-group input:focus {
        outline: none;
        border-color: #3498db;
      }

      .class-search-container {
        position: relative;
      }

      .class-search-input {
        width: 100%;
        padding: 12px 40px 12px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }

      .class-search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
      }

      .class-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        display: none;
      }

      .class-result-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      }

      .class-result-item:hover {
        background: #f8f9fa;
      }

      .class-result-item:last-child {
        border-bottom: none;
      }

      .current-class {
        background: #e8f4fd;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 4px solid #3498db;
      }

      .current-class span {
        font-weight: 600;
        color: #3498db;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: #3498db;
        color: white;
      }

      .btn-primary:hover {
        background: #2980b9;
      }

      .btn-secondary {
        background: #95a5a6;
        color: white;
      }

      .btn-secondary:hover {
        background: #7f8c8d;
      }
       .add-student-section {
        margin-bottom: 20px;
        display: flex;
        justify-content: flex-end;
      }

      .add-student-btn {
        background: #27ae60;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .add-student-btn:hover {
        background: #219a52;
      }

      /* Form styles for add student modal */
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .form-group select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
        background: white;
      }

      .form-group select:focus {
        outline: none;
        border-color: #3498db;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <nav class="navbar">
        <div class="logo">
          <img
            src="../../main/img/AcadBird - White no text.png"
            class="logo-img"
            alt="AcadBird Logo"
          />
          <img
            src="../../main/img/AcadBird - White Text.png"
            class="logo-text-img"
            alt="AcadBird Text"
          />Admin
        </div>
        <img
          src="../../main/img/sunhill.png"
          alt="AcadBird"
          class="middle-logo"
        />
        <div class="nav-icons">
          <a href="notification_admin.html" class="notification-link">
            <img
              src="../../main/img/Notification.png"
              alt="Notifications"
              class="icon"
            />
            <span class="notification-badge" id="notification-badge">0</span>
          </a>
          <a href="help_admin.html">
            <img src="../../main/img/Help.png" alt="Help" class="icon" />
          </a>
          <a href="settings_admin.html">
            <div class="account-menu">
              <img
                src="../../main/img/account icon.png"
                alt="User Account"
                class="icon"
              />
            </div>
          </a>
        </div>
      </nav>

      <div class="secondary-header">
        <div class="secondary-header-container">
          <nav class="nav-menu">
            <a href="dashboard_admin.html" class="nav-item">Dashboard</a>
            <a href="classes-management.html" class="nav-item"
              >Class Management</a
            >
            <a href="teacher-management.html" class="nav-item"
              >Teacher Management</a
            >
            <a href="parent-management.html" class="nav-item active" 
              >Parent Management</a
            >
            <a href="calendar.html" class="nav-item">Calendar</a>
            <a href="settings_admin.html" class="nav-item">Settings</a>
          </nav>
        </div>
      </div>

      <div class="main-content">
        <div class="student-info-container">
          <!-- Parent Information Card -->
          <div class="parent-info-card">
            <div class="parent-info-header">
              <div class="parent-details">
                <h1 id="parent-name">Loading...</h1>
                <p id="parent-email">Loading email...</p>
                <p id="parent-id-display">Parent ID: Loading...</p>
              </div>
              <div class="parent-status" id="parent-status">Active</div>
            </div>
            
            <div class="info-grid">
              <div class="info-item">
                <strong>Total Students</strong>
                <span id="total-students">0</span>
              </div>
              <div class="info-item">
                <strong>Account Created</strong>
                <span id="account-created">Loading...</span>
              </div>
              <div class="info-item">
                <strong>Last Updated</strong>
                <span id="last-updated">Loading...</span>
              </div>
            </div>
          </div>

          <div class="table-container">
            <div class="add-student-section">
              <button class="add-student-btn" id="add-student-btn">
                <i class="fas fa-plus"></i>
                Add Student
              </button>
            </div>

          <!-- Students Table -->
          <div class="table-container">
            <h2>Associated Students</h2>
            <table class="students-table">
              <thead>
                <tr>
                  <th>Student Name</th>
                  <th>Student Class</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="students-table-body">
                <!-- Dynamic students will load here -->
                <tr>
                  <td colspan="3" style="text-align: center; padding: 20px;">
                    Loading students...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="edit-student-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Edit Student</h2>
          <button class="close-modal" id="close-edit-modal">&times;</button>
        </div>
        
        <form id="edit-student-form">
          <input type="hidden" id="edit-student-id">
          
          <div class="form-group">
            <label for="edit-first-name">First Name</label>
            <input type="text" id="edit-first-name" required>
          </div>

          <div class="form-group">
            <label for="edit-last-name">Last Name</label>
            <input type="text" id="edit-last-name" required>
          </div>

          <div class="form-group">
            <label for="edit-class">Class</label>
            <div id="current-class-display" class="current-class" style="display: none;">
              Current Class: <span id="current-class-name"></span>
            </div>
            <div class="class-search-container">
              <input 
                type="text" 
                id="edit-class-search" 
                class="class-search-input" 
                placeholder="Search for classes..."
              >
              <i class="fas fa-search class-search-icon"></i>
              <div id="class-results" class="class-results"></div>
            </div>
            <input type="hidden" id="edit-classroom-id">
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancel-edit">Cancel</button>
            <button type="submit" class="btn btn-primary" id="save-student">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

     <div id="add-student-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Add New Student</h2>
          <button class="close-modal" id="close-add-modal">&times;</button>
        </div>
        
        <form id="add-student-form">
          <div class="form-row">
            <div class="form-group">
              <label for="add-first-name">First Name *</label>
              <input type="text" id="add-first-name" required>
            </div>

            <div class="form-group">
              <label for="add-last-name">Last Name *</label>
              <input type="text" id="add-last-name" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="add-age">Age *</label>
              <input type="number" id="add-age" min="1" max="18" required>
            </div>

            <div class="form-group">
              <label for="add-gender">Gender *</label>
              <select id="add-gender" required>
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="add-class">Class</label>
            <div class="class-search-container">
              <input 
                type="text" 
                id="add-class-search" 
                class="class-search-input" 
                placeholder="Search for classes..."
              >
              <i class="fas fa-search class-search-icon"></i>
              <div id="add-class-results" class="class-results"></div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancel-add">Cancel</button>
            <button type="submit" class="btn btn-primary" id="create-student">Create Student</button>
          </div>
        </form>
      </div>
    </div>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
 import {
  getFirestore,
  doc,
  getDoc,
  collection,
  query,
  where,
  getDocs,
  updateDoc,
  addDoc,
  deleteDoc, // Add this import
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  import { firebaseConfig } from "../../main/js/firebaseConfig.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const params = new URLSearchParams(window.location.search);
  const parentId = params.get("id");
  console.log("üîç Parent ID from URL:", parentId);

  // DOM Elements
  const parentNameEl = document.getElementById("parent-name");
  const parentEmailEl = document.getElementById("parent-email");
  const parentIdEl = document.getElementById("parent-id-display");
  const parentStatusEl = document.getElementById("parent-status");
  const totalStudentsEl = document.getElementById("total-students");
  const accountCreatedEl = document.getElementById("account-created");
  const lastUpdatedEl = document.getElementById("last-updated");
  const studentsTableBody = document.getElementById("students-table-body");

  // Modal Elements
  const editStudentModal = document.getElementById("edit-student-modal");
  const editStudentForm = document.getElementById("edit-student-form");
  const editStudentId = document.getElementById("edit-student-id");
  const editFirstName = document.getElementById("edit-first-name");
  const editLastName = document.getElementById("edit-last-name");
  const editClassSearch = document.getElementById("edit-class-search");
  const editClassroomId = document.getElementById("edit-classroom-id");
  const classResults = document.getElementById("class-results");
  const currentClassDisplay = document.getElementById("current-class-display");
  const currentClassName = document.getElementById("current-class-name");
  const closeEditModal = document.getElementById("close-edit-modal");
  const cancelEdit = document.getElementById("cancel-edit");

  // Add Student Modal Elements
  const addStudentModal = document.getElementById("add-student-modal");
  const addStudentForm = document.getElementById("add-student-form");
  const addStudentBtn = document.getElementById("add-student-btn");
  const addFirstName = document.getElementById("add-first-name");
  const addLastName = document.getElementById("add-last-name");
  const addAge = document.getElementById("add-age");
  const addGender = document.getElementById("add-gender");
  const addClassSearch = document.getElementById("add-class-search");
  const addClassResults = document.getElementById("add-class-results");
  const closeAddModal = document.getElementById("close-add-modal");
  const cancelAdd = document.getElementById("cancel-add");

  // State variables
  let allClassrooms = [];
  let currentEditingStudent = null;

  // Loading functions
  function showLoading() {
    console.log("‚è≥ Loading...");
  }

  function hideLoading() {
    console.log("‚úÖ Loading complete");
  }

  // Fetch unread notifications count for the badge
  async function getUnreadNotificationsCount() {
    try {
      showLoading();
      console.log("üì¢ Fetching notifications...");
      const notificationsSnapshot = await getDocs(
        collection(db, "notification_admin"),
      );
      let unreadCount = 0;

      notificationsSnapshot.forEach((doc) => {
        const notification = doc.data();
        if (notification.status === "unread") {
          unreadCount++;
        }
      });

      console.log(`üì¢ Found ${unreadCount} unread notifications`);
      updateNotificationBellBadge(unreadCount);
      hideLoading();
      return unreadCount;
    } catch (error) {
      console.error("‚ùå Error fetching notifications count:", error);
      hideLoading();
      return 0;
    }
  }

  // Update the notification bell badge
  function updateNotificationBellBadge(unreadCount) {
    const notificationBellBadge = document.getElementById("notification-badge");

    if (!notificationBellBadge) {
      console.log("‚ùå Notification badge element not found");
      return;
    }

    if (unreadCount > 0) {
      notificationBellBadge.textContent =
        unreadCount > 99 ? "99+" : unreadCount;
      notificationBellBadge.style.display = "flex";

      if (unreadCount > 0) {
        notificationBellBadge.style.animation = "pulse 2s infinite";
      }
      console.log("üîî Notification badge updated with count:", unreadCount);
    } else {
      notificationBellBadge.style.display = "none";
      console.log("üîî No unread notifications");
    }
  }

  // Update notification badge
  async function updateNotificationBadge() {
    try {
      const currentUser = auth.currentUser;

      if (!currentUser) {
        console.log("‚ùå No current user found");
        return;
      }

      console.log("üë§ Current user:", currentUser.email);
      await getUnreadNotificationsCount();
    } catch (error) {
      console.error("‚ùå Error updating notification badge:", error);
    }
  }

  // Load all active classrooms
  async function loadClassrooms() {
    try {
      console.log("üè´ Loading classrooms...");
      const classroomsRef = collection(db, "classrooms");
      const q = query(classroomsRef, where("status", "==", "active"));
      const snapshot = await getDocs(q);
      
      allClassrooms = [];
      snapshot.forEach((doc) => {
        const classroom = doc.data();
        classroom.id = doc.id;
        allClassrooms.push(classroom);
      });
      
      console.log(`‚úÖ Loaded ${allClassrooms.length} active classrooms:`, allClassrooms);
    } catch (error) {
      console.error("‚ùå Error loading classrooms:", error);
    }
  }

  // Load parent information
  async function loadParent() {
    if (!parentId) {
      console.error("‚ùå No parent ID provided");
      return;
    }

    try {
      console.log(`üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Loading parent with ID: ${parentId}`);
      const parentRef = doc(db, "users", parentId);
      const parentSnap = await getDoc(parentRef);

      if (parentSnap.exists()) {
        const parent = parentSnap.data();
        console.log("‚úÖ Parent data loaded:", parent);
        
        parentNameEl.textContent = parent.fullName || `${parent.firstName} ${parent.lastName}` || "Unknown Parent";
        parentEmailEl.textContent = parent.email || "No email";
        parentIdEl.textContent = `Parent ID: ${parentId}`;
        
        const status = parent.status || "Active";
        parentStatusEl.textContent = status;
        parentStatusEl.style.background = status === "Active" ? "#27ae60" : 
                                        status === "Inactive" ? "#e74c3c" : 
                                        status === "Archived" ? "#95a5a6" : "#3498db";

        const createdDate = parent.createdAt ? 
          parent.createdAt.toDate().toLocaleDateString() : "Unknown";
        const updatedDate = parent.updatedAt ? 
          parent.updatedAt.toDate().toLocaleDateString() : "Unknown";
        
        accountCreatedEl.textContent = createdDate;
        lastUpdatedEl.textContent = updatedDate;

        await loadStudents(parentId);
      } else {
        console.error("‚ùå Parent not found in database");
        parentNameEl.textContent = "Parent not found";
      }
    } catch (error) {
      console.error("‚ùå Error loading parent:", error);
      parentNameEl.textContent = "Error loading parent";
    }
  }

  // Load students associated with this parent
 // Load students associated with this parent
async function loadStudents(parentId) {
  try {
    console.log(`üéì Loading students for parent: ${parentId}`);
    const studentsRef = collection(db, "students");
    const q = query(studentsRef, where("parentId", "==", parentId));
    const snapshot = await getDocs(q);

    studentsTableBody.innerHTML = "";
    
    if (snapshot.empty) {
      console.log("üì≠ No students found for this parent");
      studentsTableBody.innerHTML = `
        <tr>
          <td colspan="3" style="text-align: center; padding: 20px;">
            No students found for this parent
          </td>
        </tr>
      `;
      totalStudentsEl.textContent = "0";
      return;
    }

    let studentCount = 0;
    console.log(`üìö Found ${snapshot.docs.length} students`);
    
    for (const docSnap of snapshot.docs) {
      const student = docSnap.data();
      const studentId = docSnap.id;
      console.log(`üéì Student ${studentCount + 1}:`, student);
      
      let className = "No Class";
      let canEditClassroom = true; // Default to true
      let classroomId = null;
      
      if (student.classroomId) {
        console.log(`üè´ Student has classroom ID: ${student.classroomId}`);
        classroomId = student.classroomId;
        
        // Check if this classroom exists in our loaded classrooms
        const existingClassroom = allClassrooms.find(cls => cls.id === student.classroomId);
        
        if (existingClassroom) {
          className = existingClassroom.classroomName || "No Class";
          console.log(`üè´ Classroom name from cache: ${className}`);
          canEditClassroom = false; // Can't edit if classroom exists and is assigned
        } else {
          // Classroom ID exists but not in our loaded classrooms - try to fetch it
          try {
            const classroomRef = doc(db, "classrooms", student.classroomId);
            const classroomSnap = await getDoc(classroomRef);
            if (classroomSnap.exists()) {
              const classroomData = classroomSnap.data();
              className = classroomData.classroomName || "No Class";
              console.log(`üè´ Classroom name from DB: ${className}`);
              canEditClassroom = false; // Can't edit if classroom exists and is assigned
            } else {
              console.log(`‚ùå Classroom not found for ID: ${student.classroomId}`);
              // Classroom doesn't exist, allow editing
              canEditClassroom = true;
            }
          } catch (error) {
            console.log(`‚ùå Error fetching classroom: ${error}`);
            canEditClassroom = true;
          }
        }
      } else {
        console.log("üè´ Student has no classroom assigned");
        canEditClassroom = true;
      }

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${student.firstName} ${student.lastName}</td>
        <td>
          ${classroomId ? 
            `<a href="class-details.html?id=${classroomId}" class="class-link" style="color: #3498db; text-decoration: none; cursor: pointer; font-weight: 500;">
              ${className}
            </a>` : 
            `<span style="color: #666;">${className}</span>`
          }
        </td>
        <td>
          <div class="action-buttons">
            <button class="action-btn edit-btn" onclick="openEditStudentModal('${studentId}', ${canEditClassroom})">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="action-btn delete-btn" onclick="deleteStudent('${studentId}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </td>
      `;
      
      studentsTableBody.appendChild(row);
      studentCount++;
    }

    totalStudentsEl.textContent = studentCount.toString();
    console.log(`‚úÖ Loaded ${studentCount} students`);

  } catch (error) {
    console.error("‚ùå Error loading students:", error);
    studentsTableBody.innerHTML = `
      <tr>
        <td colspan="3" style="text-align: center; padding: 20px; color: #e74c3c;">
          Error loading students
        </td>
      </tr>
    `;
  }
}
  // Save student changes
  async function saveStudentChanges(e) {
    e.preventDefault();
    console.log("üíæ Saving student changes...");
    
    const studentId = editStudentId.value;
    const firstName = editFirstName.value.trim();
    const lastName = editLastName.value.trim();
    const classroomName = editClassSearch.value.trim();

    console.log("üìù Form data:", { studentId, firstName, lastName, classroomName });

    if (!firstName || !lastName) {
      console.log("‚ùå Validation failed: Missing first name or last name");
      alert("Please fill in first name and last name");
      return;
    }

    try {
      const updateData = {
        firstName: firstName,
        lastName: lastName,
        updatedAt: new Date()
      };

      console.log("üì¶ Base update data:", updateData);

      // Get current student data
      const studentRef = doc(db, "students", studentId);
      const studentSnap = await getDoc(studentRef);
      
      if (studentSnap.exists()) {
        const currentStudent = studentSnap.data();
        console.log("üéì Current student data:", currentStudent);
        
        // Check if classroom editing is allowed (passed as data attribute)
        const canEditClassroom = editStudentModal.getAttribute('data-can-edit-classroom') === 'true';
        console.log(`üè´ Can edit classroom: ${canEditClassroom}`);
        
        // Update classroom only if editing is allowed AND a classroom was selected
        if (canEditClassroom && classroomName) {
          console.log(`üîç Looking for classroom with name: "${classroomName}"`);
          console.log("üè´ Available classrooms:", allClassrooms);
          
          // Find the classroom by name to get its ID
          const selectedClassroom = allClassrooms.find(cls => 
            cls.classroomName === classroomName
          );
          
          if (selectedClassroom) {
            console.log("‚úÖ Classroom found:", selectedClassroom);
            updateData.classroomId = selectedClassroom.id;
            updateData.classroomName = selectedClassroom.classroomName;
            console.log("üì¶ Updated data with classroom:", updateData);
          } else {
            console.log("‚ùå Classroom not found in available classrooms");
            alert("Selected classroom not found. Please choose a valid classroom from the search results.");
            return;
          }
        } else if (!canEditClassroom && classroomName) {
          console.log("üö´ Classroom editing not allowed for this student");
        } else if (!classroomName) {
          console.log("‚ÑπÔ∏è No classroom selected");
        }
      }

      console.log("üî• Final update data to be saved:", updateData);
      await updateDoc(studentRef, updateData);
      
      console.log("‚úÖ Student updated successfully!");
      alert("Student updated successfully!");
      closeEditModalFunc();
      await loadStudents(parentId); // Refresh the table
      
    } catch (error) {
      console.error("‚ùå Error updating student:", error);
      alert("Error updating student");
    }
  }

  // Create new student
  async function createNewStudent(e) {
    e.preventDefault();
    console.log("üë∂ Creating new student...");
    
    const firstName = addFirstName.value.trim();
    const lastName = addLastName.value.trim();
    const age = parseInt(addAge.value);
    const gender = addGender.value;
    const classroomName = addClassSearch.value.trim();

    console.log("üìù Form data:", { firstName, lastName, age, gender, classroomName });

    // Validation
    if (!firstName || !lastName || !age || !gender) {
      console.log("‚ùå Validation failed: Missing required fields");
      alert("Please fill in all required fields (First Name, Last Name, Age, Gender)");
      return;
    }

    if (age < 1 || age > 18) {
      console.log("‚ùå Validation failed: Invalid age");
      alert("Age must be between 1 and 18");
      return;
    }

    try {
      // Get parent data for parentName
      const parentRef = doc(db, "users", parentId);
      const parentSnap = await getDoc(parentRef);
      
      if (!parentSnap.exists()) {
        console.log("‚ùå Parent not found");
        alert("Parent not found");
        return;
      }

      const parent = parentSnap.data();
      const parentName = parent.fullName || `${parent.firstName} ${parent.lastName}`;

      // Prepare student data
      const studentData = {
        firstName: firstName,
        lastName: lastName,
        age: age,
        gender: gender,
        parentId: parentId,
        parentName: parentName,
        status: "active",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      console.log("üì¶ Student data to create:", studentData);

      // Handle classroom assignment if selected
      if (classroomName) {
        console.log(`üîç Looking for classroom with name: "${classroomName}"`);
        const selectedClassroom = allClassrooms.find(cls => 
          cls.classroomName === classroomName
        );
        
        if (selectedClassroom) {
          console.log("‚úÖ Classroom found:", selectedClassroom);
          studentData.classroomId = selectedClassroom.id;
          studentData.classroomName = selectedClassroom.classroomName;
        } else {
          console.log("‚ùå Classroom not found in available classrooms");
          alert("Selected classroom not found. Please choose a valid classroom from the search results.");
          return;
        }
      }

      console.log("üî• Final student data to be created:", studentData);
      
      // Add student to Firestore
      await addDoc(collection(db, "students"), studentData);
      
      console.log("‚úÖ Student created successfully!");
      alert("Student created successfully!");
      closeAddModalFunc();
      await loadStudents(parentId); // Refresh the table
      
    } catch (error) {
      console.error("‚ùå Error creating student:", error);
      alert("Error creating student");
    }
  }

  // Select a classroom from search results (for both modals)
  function selectClassroom(classroom, isAddModal = false) {
    console.log("üéØ Classroom selected:", classroom);
    if (isAddModal) {
      addClassSearch.value = classroom.classroomName;
      addClassResults.style.display = 'none';
    } else {
      editClassSearch.value = classroom.classroomName;
      classResults.style.display = 'none';
      currentClassDisplay.style.display = 'none';
    }
  }

  // Filter classrooms based on search input (for both modals)
  function filterClassrooms(searchTerm, isAddModal = false) {
    console.log(`üîç Filtering classrooms with search term: "${searchTerm}"`);
    const filtered = allClassrooms.filter(classroom => 
      classroom.classroomName.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    console.log(`üìã Found ${filtered.length} matching classrooms`);
    displayClassResults(filtered, isAddModal);
  }

  // Display classroom search results (for both modals)
  function displayClassResults(classrooms, isAddModal = false) {
    const targetResults = isAddModal ? addClassResults : classResults;
    console.log("üìú Displaying classroom results:", classrooms);
    targetResults.innerHTML = '';
    
    if (classrooms.length === 0) {
      console.log("üì≠ No classrooms match the search");
      targetResults.style.display = 'none';
      return;
    }
    
    classrooms.forEach(classroom => {
      const item = document.createElement('div');
      item.className = 'class-result-item';
      item.textContent = classroom.classroomName;
      item.addEventListener('click', () => {
        selectClassroom(classroom, isAddModal);
      });
      targetResults.appendChild(item);
    });
    
    targetResults.style.display = 'block';
    console.log("‚úÖ Classroom results displayed");
  }

  // Open edit student modal
  async function openEditStudentModal(studentId, canEditClassroom = true) {
    try {
      console.log(`üìù Opening edit modal for student: ${studentId}`);
      console.log(`üè´ Classroom editing allowed: ${canEditClassroom}`);
      
      const studentRef = doc(db, "students", studentId);
      const studentSnap = await getDoc(studentRef);

      if (studentSnap.exists()) {
        const student = studentSnap.data();
        currentEditingStudent = studentId;
        console.log("üéì Student data for editing:", student);
        
        // Store whether classroom editing is allowed
        editStudentModal.setAttribute('data-can-edit-classroom', canEditClassroom.toString());
        
        // Fill form with current data
        editStudentId.value = studentId;
        editFirstName.value = student.firstName || '';
        editLastName.value = student.lastName || '';
        
        // Handle classroom selection based on whether editing is allowed
        editClassSearch.value = '';
        currentClassDisplay.style.display = 'none';
        
        if (student.classroomId && !canEditClassroom) {
          console.log("üè´ Student has a valid classroom, loading classroom data...");
          // Student has a valid classroom - show current class and make it non-editable
          try {
            const classroomRef = doc(db, "classrooms", student.classroomId);
            const classroomSnap = await getDoc(classroomRef);
            if (classroomSnap.exists()) {
              const classroom = classroomSnap.data();
              console.log("üè´ Current classroom:", classroom);
              currentClassName.textContent = classroom.classroomName;
              currentClassDisplay.style.display = 'block';
              editClassSearch.disabled = true;
              editClassSearch.placeholder = "Class cannot be changed (student already enrolled)";
              console.log("‚úÖ Current classroom displayed, editing disabled");
            }
          } catch (error) {
            console.log("‚ùå Error loading classroom, allowing editing");
            editClassSearch.disabled = false;
            editClassSearch.placeholder = "Search for classes...";
          }
        } else {
          console.log("üè´ Student has no classroom or classroom editing is allowed");
          // Student has no class or classroom is invalid - allow class selection
          editClassSearch.disabled = false;
          editClassSearch.placeholder = "Search for classes...";
          
          // If student has a classroom name but no valid ID, show it
          if (student.classroomName) {
            currentClassName.textContent = student.classroomName;
            currentClassDisplay.style.display = 'block';
          }
        }
        
        // Show modal
        editStudentModal.style.display = 'flex';
        console.log("‚úÖ Edit modal opened successfully");
      } else {
        console.log("‚ùå Student not found for editing");
      }
    } catch (error) {
      console.error("‚ùå Error loading student data:", error);
      alert("Error loading student data");
    }
  }

  // Open add student modal
  function openAddStudentModal() {
    console.log("‚ûï Opening add student modal");
    addStudentModal.style.display = 'flex';
    // Reset form
    addStudentForm.reset();
    addClassSearch.value = '';
    addClassResults.style.display = 'none';
  }

  function closeEditModalFunc() {
    console.log("üö™ Closing edit modal");
    editStudentModal.style.display = 'none';
    editStudentForm.reset();
    currentEditingStudent = null;
    classResults.style.display = 'none';
    currentClassDisplay.style.display = 'none';
    editClassSearch.disabled = false;
    editClassSearch.placeholder = "Search for classes...";
    // Remove the data attribute
    editStudentModal.removeAttribute('data-can-edit-classroom');
  }

  function closeAddModalFunc() {
    console.log("üö™ Closing add modal");
    addStudentModal.style.display = 'none';
    addStudentForm.reset();
    addClassResults.style.display = 'none';
  }

  // Student action functions
async function deleteStudent(studentId) {
  console.log("üóëÔ∏è Delete student requested:", studentId);
  
  if (confirm("Are you sure you want to delete this student? This action cannot be undone.")) {
    console.log("‚úÖ Delete confirmed for student:", studentId);
    
    try {
      // Delete the student document from Firestore
      const studentRef = doc(db, "students", studentId);
      await deleteDoc(studentRef);
      
      console.log("‚úÖ Student deleted successfully from Firestore");
      alert("Student deleted successfully!");
      
      // Refresh the students table
      await loadStudents(parentId);
      
    } catch (error) {
      console.error("‚ùå Error deleting student:", error);
      alert("Error deleting student. Please try again.");
    }
  } else {
    console.log("‚ùå Delete cancelled");
  }
}
  // Make functions global for onclick handlers
  window.openEditStudentModal = openEditStudentModal;
  window.deleteStudent = deleteStudent;

  // Event listeners
  editClassSearch.addEventListener('input', (e) => {
    const searchTerm = e.target.value;
    console.log(`‚å®Ô∏è Classroom search input: "${searchTerm}"`);
    if (searchTerm.length > 0) {
      filterClassrooms(searchTerm, false);
    } else {
      console.log("üì≠ Search term empty, hiding results");
      classResults.style.display = 'none';
    }
  });

  addClassSearch.addEventListener('input', (e) => {
    const searchTerm = e.target.value;
    console.log(`‚å®Ô∏è Add modal classroom search input: "${searchTerm}"`);
    if (searchTerm.length > 0) {
      filterClassrooms(searchTerm, true);
    } else {
      console.log("üì≠ Search term empty, hiding results");
      addClassResults.style.display = 'none';
    }
  });

  editStudentForm.addEventListener('submit', saveStudentChanges);
  addStudentForm.addEventListener('submit', createNewStudent);
  
  closeEditModal.addEventListener('click', closeEditModalFunc);
  cancelEdit.addEventListener('click', closeEditModalFunc);
  
  closeAddModal.addEventListener('click', closeAddModalFunc);
  cancelAdd.addEventListener('click', closeAddModalFunc);
  
  addStudentBtn.addEventListener('click', openAddStudentModal);

  // Close modals when clicking outside
  editStudentModal.addEventListener('click', (e) => {
    if (e.target === editStudentModal) {
      console.log("üëÜ Clicked outside edit modal, closing");
      closeEditModalFunc();
    }
  });

  addStudentModal.addEventListener('click', (e) => {
    if (e.target === addStudentModal) {
      console.log("üëÜ Clicked outside add modal, closing");
      closeAddModalFunc();
    }
  });

  // Close search results when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.class-search-container')) {
      console.log("üëÜ Clicked outside search container, hiding results");
      classResults.style.display = 'none';
      addClassResults.style.display = 'none';
    }
  });

  // Initialize page
  async function initializePage() {
    console.log("üöÄ Initializing page...");
    await loadClassrooms(); // Load classrooms first
    await loadParent();
    await updateNotificationBadge();
    console.log("‚úÖ Page initialization complete");
  }

  // Wait for auth state before updating badge
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      console.log("üîê User authenticated:", user.email);
      await initializePage();
    } else {
      console.log("üîê No user authenticated");
    }
  });
</script>
  </body>
</html>