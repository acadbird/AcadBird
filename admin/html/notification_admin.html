<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AcadBird Admin - Notifications</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <!-- Include Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="../style/notification_admin.css">
    <style>
        /* Notification badge styles */
        .notification-badge-container {
            position: relative;
            display: inline-block;
        }
        
        .notification-bell-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #2c3e50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Make the bell icon container position relative */
        .nav-icons a[title="Notifications"] {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Navbar -->
        <div class="navbar">
            <div class="navbar-container">
                <div class="logo">
                     <img src="../../main/img/AcadBird - White no text.png" alt="AcadBird" class="logo-img" />
                     <img src="../../main/img/AcadBird - White Text.png" class="logo-text-img" alt="AcadBird Text">
                </div>
                 <img src="../../main/img/sunhill.png" alt="AcadBird" class="middle-logo" />
                <div class="nav-icons">
                    <a href="notification_admin.html" title="Notifications" class="notification-badge-container">
                        <i class="fas fa-bell icon"></i>
                        <span class="notification-bell-badge" id="notification-bell-badge" style="display: none;">0</span>
                    </a>
                    <a href="help_admin.html" title="Help">
                        <i class="fas fa-question-circle icon"></i>
                    </a>
                    <a href="settings_admin.html" title="Settings">
                        <div class="account-menu">
                            <i class="fas fa-user-circle icon"></i>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <div id="loading-overlay">

<div class="loader-3">
    <div class="circle"></div>
    <div class="circle"></div>
    <div class="circle"></div>
    <div class="circle"></div>
    <div class="circle"></div>
</div>
</div>
        
        <!-- Secondary Header -->
        <div class="secondary-header">
           <div class="secondary-header-container">
               <nav class="nav-menu">
                    <a href="dashboard_admin.html" class="nav-item">Dashboard</a>
                    <a href="classes-management.html" class="nav-item">Class Management</a> 
                    <a href="teacher-management.html" class="nav-item">Teacher Management</a>
                    <a href="calendar.html" class="nav-item">Calendar</a>
                    <a href="settings_admin.html" class="nav-item ">Settings</a>
               </nav>
           </div>
        </div>
        
        <div class="separator"></div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="admin-card">
                    <h2>Admin 1</h2>
                    <div>
                        <span>Sunhill Academy</span>
                    </div>
                </div>

                <div class="admin-card">
                    <h2>Notification Stats</h2>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Unread</span>
                            <span id="unread-count" style="font-weight: 700;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Today</span>
                            <span id="today-count" style="font-weight: 700;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>This Week</span>
                            <span id="week-count" style="font-weight: 700;">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div class="notifications-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2><i class="fas fa-bell"></i> Notifications</h2>
                        <button class="mark-all-read-btn" id="mark-all-read">
                            <i class="fas fa-check-double"></i> Mark All as Read
                        </button>
                    </div>
                    
                    <div class="notification-filters">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="unread">Unread</button>
                        <button class="filter-btn" data-filter="teachers">Teachers</button>
                        <button class="filter-btn" data-filter="classes">Classes</button>
                    </div>
                    
                    <div id="notifications-list">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading notifications...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7gwN-3GVlJ-a_MTBxqVnc7Oltq5wSvHQ",
            authDomain: "acadbird-379e3.firebaseapp.com",
            projectId: "acadbird-379e3",
            storageBucket: "acadbird-379e3.firebasestorage.app",
            messagingSenderId: "575491576951",
            appId: "1:575491576951:web:70f86aba1e33b871f8a272",
            measurementId: "G-N6Z672SXWJ"
        };

        console.log('Initializing Firebase...');
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log('Firebase initialized successfully');
        const loadingOverlay = document.getElementById("loading-overlay");

   function showLoading() {
  loadingOverlay.style.display = "flex";
}

// Hide overlay
function hideLoading() {
  loadingOverlay.style.display = "none";
}



        // DOM elements
        const notificationsList = document.getElementById('notifications-list');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const unreadCount = document.getElementById('unread-count');
        const todayCount = document.getElementById('today-count');
        const weekCount = document.getElementById('week-count');
        const markAllReadBtn = document.getElementById('mark-all-read');
        const notificationBellBadge = document.getElementById('notification-bell-badge');

        // Global notifications array
        let notifications = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, fetching notifications...');
            fetchNotifications();
            setupEventListeners();
        });

        // Fetch notifications from Firestore
        async function fetchNotifications() {
            try {
                 showLoading();
                console.log('Starting to fetch notifications...');
                
                // Fetch all teachers from users collection
                console.log('Fetching teachers from users collection...');
                const teachersSnapshot = await db.collection('users')
                    .where('role', '==', 'teacher')
                    .get();
                
                console.log(`Found ${teachersSnapshot.size} teachers in users collection`);
                
                // Fetch existing notifications from notification_admin collection
                console.log('Fetching existing notifications from notification_admin collection...');
                const existingNotificationsSnapshot = await db.collection('notification_admin')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                console.log(`Found ${existingNotificationsSnapshot.size} existing notifications`);
                
                notifications = [];
                
                // Process teachers to create notifications
                const batch = db.batch();
                let newNotificationsCreated = false;
                
                teachersSnapshot.forEach(doc => {
                    const teacherData = doc.data();
                    const teacherName = teacherData.fullName || `${teacherData.firstName} ${teacherData.lastName}`;
                    const teacherId = doc.id;
                    
                    // Create a unique ID for the teacher notification
                    const notificationId = `teacher_${teacherId}`;
                    
                    // Check if this teacher notification already exists
                    const existingNotification = existingNotificationsSnapshot.docs.find(
                        notificationDoc => notificationDoc.id === notificationId
                    );
                    
                    if (existingNotification) {
                        // Use existing notification
                        const notificationData = existingNotification.data();
                        console.log('Using existing notification for teacher:', teacherName);
                        notifications.push({
                            id: notificationId,
                            title: notificationData.title,
                            message: notificationData.message,
                            time: formatTimeAgo(notificationData.timestamp),
                            type: notificationData.type,
                            category: notificationData.category,
                            status: notificationData.status,
                            timestamp: notificationData.timestamp,
                            teacherId: teacherId,
                            redirectTo: "teacher-management.html"
                        });
                    } else {
                        // Create new notification for teacher
                        console.log('Creating new notification for teacher:', teacherName);
                        const notification = {
                            id: notificationId,
                            title: "New Teacher Joined",
                            message: `${teacherName} has registered as a new teacher`,
                            time: formatTimeAgo(teacherData.createdAt),
                            type: "success",
                            category: "teachers",
                            status: "unread",
                            timestamp: teacherData.createdAt || new Date(),
                            teacherId: teacherId,
                            redirectTo: "teacher-management.html"
                        };
                        
                        notifications.push(notification);
                        
                        // Add to batch to save to notification_admin collection
                        const notificationRef = db.collection('notification_admin').doc(notificationId);
                        batch.set(notificationRef, notification);
                        newNotificationsCreated = true;
                    }
                });
                
                // Process existing classroom notifications
                existingNotificationsSnapshot.forEach(doc => {
                    const notificationData = doc.data();
                    // Only add classroom notifications (not teacher notifications we already processed)
                    if (notificationData.category === 'classes') {
                        console.log('Adding classroom notification:', doc.id);
                        notifications.push({
                            id: doc.id,
                            title: notificationData.title,
                            message: notificationData.message,
                            time: formatTimeAgo(notificationData.timestamp),
                            type: notificationData.type,
                            category: notificationData.category,
                            status: notificationData.status,
                            timestamp: notificationData.timestamp,
                            classroomId: notificationData.classroomId,
                            redirectTo: "classes-management.html"
                        });
                    }
                });
                
                // Commit batch if new notifications were created
                if (newNotificationsCreated) {
                    console.log('Saving new teacher notifications to database...');
                    await batch.commit();
                    console.log('New teacher notifications saved successfully');
                }
                
                console.log('Total notifications loaded:', notifications.length);
                
                // Log breakdown by category
                const teachersCount = notifications.filter(n => n.category === 'teachers').length;
                const classesCount = notifications.filter(n => n.category === 'classes').length;
                console.log(`Notifications by category - Teachers: ${teachersCount}, Classes: ${classesCount}`);
                
                // Render notifications and update stats
                console.log('Rendering notifications...');
                renderNotifications('all');
                updateStats();
                
            } catch (error) {
                console.error("Error fetching notifications:", error);
                notificationsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error loading notifications</h3>
                        <p>Please try again later.</p>
                    </div>
                `;
                  hideLoading(); // Add this line in error case too
            }
              hideLoading(); // Add this line in error case too
        }

        // Format timestamp to relative time
        function formatTimeAgo(timestamp) {
            if (!timestamp) return "Unknown time";
            
            let notificationTime;
            
            try {
                // Handle different timestamp formats
                if (timestamp instanceof Date) {
                    notificationTime = timestamp;
                } else if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                    // Firestore Timestamp object
                    notificationTime = timestamp.toDate();
                } else if (typeof timestamp === 'string') {
                    // String timestamp
                    notificationTime = new Date(timestamp);
                } else if (timestamp.seconds) {
                    // Firestore timestamp with seconds and nanoseconds
                    notificationTime = new Date(timestamp.seconds * 1000);
                } else {
                    // Fallback - try to parse as Date
                    notificationTime = new Date(timestamp);
                }
                
                // Check if the date is valid
                if (isNaN(notificationTime.getTime())) {
                    console.warn("Invalid timestamp:", timestamp);
                    return "Unknown time";
                }
                
                const now = new Date();
                const diffMs = now - notificationTime;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffMins < 1) return "Just now";
                if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                
                return notificationTime.toLocaleDateString();
                
            } catch (error) {
                console.error('Error formatting timestamp:', error);
                return "Unknown time";
            }
        }

        // Render notifications based on filter
        function renderNotifications(filter) {
            console.log('Rendering notifications with filter:', filter);
            console.log('Total notifications available:', notifications.length);
            
            notificationsList.innerHTML = '';
            
            let filteredNotifications = notifications;
            
            if (filter !== 'all') {
                if (filter === 'unread') {
                    filteredNotifications = notifications.filter(notification => notification.status === 'unread');
                    console.log('Unread notifications count:', filteredNotifications.length);
                } else {
                    filteredNotifications = notifications.filter(notification => notification.category === filter);
                    console.log(`Notifications for category ${filter}:`, filteredNotifications.length);
                }
            }
            
            if (filteredNotifications.length === 0) {
                console.log('No notifications found for filter:', filter);
                notificationsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No notifications found</h3>
                        <p>There are no notifications matching your current filter.</p>
                    </div>
                `;
                return;
            }
            
            console.log(`Rendering ${filteredNotifications.length} notifications`);
            
            // Sort by timestamp (newest first)
            filteredNotifications.sort((a, b) => {
                const timeA = new Date(a.timestamp);
                const timeB = new Date(b.timestamp);
                return timeB - timeA;
            });
            
            filteredNotifications.forEach((notification, index) => {
                console.log(`Creating notification ${index + 1}:`, notification.title);
                
                const notificationElement = document.createElement('div');
                notificationElement.className = `notification-item ${notification.status === 'unread' ? 'unread' : 'read'}`;
                notificationElement.dataset.id = notification.id;
                notificationElement.dataset.redirectTo = notification.redirectTo;
                
                let iconClass = 'info';
                if (notification.type === 'warning') iconClass = 'warning';
                else if (notification.type === 'alert') iconClass = 'alert';
                else if (notification.type === 'success') iconClass = 'success';
                
                // Determine envelope icon based on read status
                const envelopeIcon = notification.status === 'unread' ? 'fa-envelope' : 'fa-envelope-open';
                const envelopeTitle = notification.status === 'unread' ? 'Mark as read' : 'Mark as unread';
                
                // Determine redirect text based on category
                let redirectText = "Click to view";
                if (notification.category === 'classes') {
                    redirectText = "Click to view class";
                } else if (notification.category === 'teachers') {
                    redirectText = "Click to view teacher";
                }
                
                notificationElement.innerHTML = `
                    <div class="notification-icon ${iconClass}">
                        <i class="fas ${getIconForType(notification.type)}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${notification.time}</div>
                    </div>
                    <div class="notification-actions">
                        <button class="notification-action mark-read" title="${envelopeTitle}">
                            <i class="fas ${envelopeIcon}"></i>
                        </button>
                    </div>
                    <div class="click-indicator">
                        <i class="fas fa-external-link-alt"></i> ${redirectText}
                    </div>
                    ${notification.status === 'unread' ? `<div class="notification-badge">New</div>` : ''}
                `;
                
                notificationsList.appendChild(notificationElement);
            });
            console.log('Finished rendering notifications');
        }

        // Get appropriate icon for notification type
        function getIconForType(type) {
            switch(type) {
                case 'warning': return 'fa-exclamation-triangle';
                case 'alert': return 'fa-exclamation-circle';
                case 'success': return 'fa-check-circle';
                default: return 'fa-info-circle';
            }
        }

        // Update notification statistics
        function updateStats() {
            console.log('Updating notification statistics...');
            const unread = notifications.filter(n => n.status === 'unread').length;
            
            // Calculate today's notifications (created in the last 24 hours)
            const today = notifications.filter(n => {
                try {
                    const notificationTime = new Date(n.timestamp);
                    const now = new Date();
                    const diffMs = now - notificationTime;
                    return diffMs < (24 * 60 * 60 * 1000);
                } catch (error) {
                    return false;
                }
            }).length;
            
            // Calculate this week's notifications (created in the last 7 days)
            const week = notifications.filter(n => {
                try {
                    const notificationTime = new Date(n.timestamp);
                    const now = new Date();
                    const diffMs = now - notificationTime;
                    return diffMs < (7 * 24 * 60 * 60 * 1000);
                } catch (error) {
                    return false;
                }
            }).length;
            
            console.log('Stats - Unread:', unread, 'Today:', today, 'This Week:', week);
            
            unreadCount.textContent = unread;
            todayCount.textContent = today;
            weekCount.textContent = week;
            
            // Update the notification bell badge
            updateNotificationBellBadge(unread);
        }

        // Update the notification bell badge
        function updateNotificationBellBadge(unreadCount) {
            console.log('Updating notification bell badge with count:', unreadCount);
            
            if (unreadCount > 0) {
                notificationBellBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                notificationBellBadge.style.display = 'flex';
                
                // Add pulse animation for new notifications
                if (unreadCount > 0) {
                    notificationBellBadge.style.animation = 'pulse 2s infinite';
                }
            } else {
                notificationBellBadge.style.display = 'none';
            }
        }

        // Mark notification as read/unread in Firestore
        async function updateNotificationStatus(notificationId, status) {
            try {
                console.log(`Updating notification ${notificationId} status to:`, status);
                await db.collection('notification_admin').doc(notificationId).update({
                    status: status
                });
                
                // Update local notification status
                const notification = notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.status = status;
                }
                
                console.log('Notification status updated successfully');
                return true;
            } catch (error) {
                console.error("Error updating notification status:", error);
                return false;
            }
        }

        // Handle notification click - mark as read and redirect
        async function handleNotificationClick(notificationId, redirectTo) {
            console.log('Handling notification click:', notificationId, redirectTo);
            const notification = notifications.find(n => n.id === notificationId);
            
            // If notification is unread, mark it as read first
            if (notification && notification.status === 'unread') {
                console.log('Marking notification as read before redirect');
                await updateNotificationStatus(notificationId, 'read');
                updateStats();
            }
            
            // Redirect to the appropriate page
            console.log('Redirecting to:', redirectTo);
            window.location.href = redirectTo;
        }

        // Mark all notifications as read
        async function markAllAsRead() {
            try {
                console.log('Marking all notifications as read');
                const batch = db.batch();
                
                notifications.forEach(notification => {
                    if (notification.status === 'unread') {
                        const notificationRef = db.collection('notification_admin').doc(notification.id);
                        batch.update(notificationRef, { status: 'read' });
                        notification.status = 'read';
                    }
                });
                
                await batch.commit();
                console.log('All notifications marked as read');
                
                // Re-render notifications and update stats
                renderNotifications(document.querySelector('.filter-btn.active').dataset.filter);
                updateStats();
                
            } catch (error) {
                console.error("Error marking all as read:", error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners');
            
            // Filter buttons
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    console.log('Filter button clicked:', this.dataset.filter);
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    renderNotifications(this.dataset.filter);
                });
            });
            
            // Mark as read buttons (using event delegation)
            notificationsList.addEventListener('click', function(e) {
                const notificationItem = e.target.closest('.notification-item');
                if (!notificationItem) return;
                
                const notificationId = notificationItem.dataset.id;
                const redirectTo = notificationItem.dataset.redirectTo;
                const notification = notifications.find(n => n.id === notificationId);
                
                console.log('Notification item clicked:', notificationId, redirectTo);
                
                // If clicking the envelope icon, just toggle read status
                if (e.target.closest('.mark-read')) {
                    console.log('Envelope icon clicked');
                    e.stopPropagation(); // Prevent card click from triggering
                    const newStatus = notification.status === 'unread' ? 'read' : 'unread';
                    updateNotificationStatus(notificationId, newStatus).then(success => {
                        if (success) {
                            renderNotifications(document.querySelector('.filter-btn.active').dataset.filter);
                            updateStats();
                        }
                    });
                } 
                // If clicking anywhere else on the card, mark as read and redirect
                else {
                    console.log('Notification card clicked, will redirect to:', redirectTo);
                    handleNotificationClick(notificationId, redirectTo);
                }
            });
            
            // Mark all as read button
            markAllReadBtn.addEventListener('click', markAllAsRead);
            console.log('Event listeners setup completed');
        }
    </script>
</body>
</html>