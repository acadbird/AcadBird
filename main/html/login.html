<!doctype html>
<html lang="en">
  <head>
    <link rel="icon" type="image/png" href="img/AcadBird - White no text.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ACADBIRD Login</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../style/login_signup.css" />
  </head>
  <body>
    <div class="container">
      <div class="card">
        <!-- Left panel -->
        <div class="left-panel">
          <div class="logo-box">
            <img
              src="../img/AcadBird - White no text.png"
              alt="ACADBIRD Logo"
              class="logo"
            />
          </div>
          <h1 class="brand">ACADBIRD</h1>
          <p class="tagline">Your Trusted Wings in Shared Learning Journeys</p>
        </div>

        <!-- Right panel -->
        <div class="right-panel">
          <div class="welcome">
            <h2>Welcome!</h2>
            <p>Please login to your account</p>
          </div>

          <form class="login-form">
            <div class="form-group">
              <label for="email">Email</label>
              <input
                type="email"
                id="email"
                placeholder="Enter your email"
                required
              />
            </div>

            <div class="form-group">
              <label for="password">Password</label>
              <input
                type="password"
                id="password"
                placeholder="Enter your password"
                required
              />
            </div>

            <a href="#" class="forgot-password" id="forgotPasswordLink"
              >Forgot Password?</a
            >

            <p
              id="errorMessage"
              style="color: red; text-align: center; margin-top: 10px"
            ></p>
            <p
              id="successMessage"
              style="color: green; text-align: center; margin-top: 10px"
            ></p>

            <button type="submit" class="btn" id="loginButton">Login</button>
          </form>

          <div class="signup-link">
            <span>No Account?</span>
            <a href="signup_p.html">Sign Up as Parent</a> |
            <a href="signup_t.html">Sign Up as Teacher</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase Login Logic -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        sendPasswordResetEmail,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        collection,
        query,
        where,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB7gwN-3GVlJ-a_MTBxqVnc7Oltq5wSvHQ",
        authDomain: "acadbird-379e3.firebaseapp.com",
        projectId: "acadbird-379e3",
        storageBucket: "acadbird-379e3.appspot.com",
        messagingSenderId: "575491576951",
        appId: "1:575491576951:web:70f86aba1e33b871f8a272",
        measurementId: "G-N6Z672SXWJ",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      document.addEventListener("DOMContentLoaded", () => {
        const loginButton = document.getElementById("loginButton");
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");
        const errorMessageDisplay = document.getElementById("errorMessage");
        const successMessageDisplay = document.getElementById("successMessage");
        const forgotPasswordLink =
          document.getElementById("forgotPasswordLink");

        // LOGIN FUNCTION
        loginButton.addEventListener("click", async (event) => {
          event.preventDefault();
          errorMessageDisplay.textContent = "";
          successMessageDisplay.textContent = "";

          try {
            const userCredential = await signInWithEmailAndPassword(
              auth,
              emailInput.value.trim(),
              passwordInput.value.trim(),
            );

            const user = userCredential.user;
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists()) throw new Error("No profile found");

            const userData = userDoc.data();
            localStorage.setItem(
              "user",
              JSON.stringify({ id: user.uid, ...userData }),
            );

            switch (userData.role) {
              case "teacher":
                window.location.href =
                  "../../teachers/html/homepage-teachers.html";
                break;
              case "parent":
                window.location.href =
                  "../../parents/html/homepage_parents.html";
                break;
              case "admin":
                window.location.href = "../../admin/html/dashboard_admin.html";
                break;
            }
          } catch (err) {
            console.error("Login error:", err);
            errorMessageDisplay.textContent = "Invalid email or password.";
          }
        });

        // FORGOT PASSWORD FUNCTION
        // FORGOT PASSWORD FUNCTION with Firestore check
        forgotPasswordLink.addEventListener("click", async (event) => {
          event.preventDefault();
          errorMessageDisplay.textContent = "";
          successMessageDisplay.textContent = "";

          const email = emailInput.value.trim();
          if (!email) {
            errorMessageDisplay.textContent = "Please enter your email first.";
            return;
          }

          try {
            console.log("üîç Checking email in Firestore:", email);

            // ‚úÖ Check Firestore users collection for the email
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
              console.log("‚ö†Ô∏è Email not found in Firestore:", email);
              errorMessageDisplay.textContent =
                "No account found with this email.";
              return;
            }

            console.log(
              "‚úÖ Email found in Firestore, sending reset email:",
              email,
            );

            // ‚úÖ Send password reset email if user exists in Firestore
            await sendPasswordResetEmail(auth, email);
            successMessageDisplay.textContent =
              "Password reset email sent! Check your inbox.";
            console.log("üì© Password reset email sent successfully to:", email);
          } catch (err) {
            console.error("‚ùå Password reset error:", err);
            errorMessageDisplay.textContent =
              "Error sending reset email. Please try again.";
          }
        });
      });
    </script>
  </body>
</html>
