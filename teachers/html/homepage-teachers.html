<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AcadBird - Homepage</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../style/homepage-teachers.css" />
  </head>
  <body>
    <div class="container">
      <div class="navbar">
        <div class="logo">
          <img
            src="../../main/img/AcadBird - White no text.png"
            class="logo-img"
            alt="AcadBird Logo"
          />
          <img
            src="../../main/img/AcadBird - White Text.png"
            class="logo-text-img"
            alt="AcadBird Text"
          />
        </div>
        <img
          src="../../main/img/sunhill.png"
          alt="AcadBird"
          class="middle-logo"
        />
        <div class="nav-icons">
          <a href="notification_teacher.html" target="_blank">
            <img
              src="../../main/img/Notification.png"
              alt="Notifications"
              class="icon"
            />
          </a>
          <a href="help_teacher.html" target="_blank">
            <img src="../../main/img/Help.png" alt="Help" class="icon" />
          </a>
          <a href="settings_teacher.html" target="_blank">
            <div class="account-menu">
              <img
                src="../../main/img/account icon.png"
                alt="User Account"
                class="icon"
              />
            </div>
          </a>
        </div>
      </div>

      <div class="secondary-header">
        <div class="secondary-header-content">
          <div class="teacher-name-header" id="teacher-name-header">
            Loading Classes...
          </div>
        </div>
      </div>

      <div
        id="loading-spinner"
        style="text-align: center; padding: 50px; margin-top: 50px"
      >
        <div class="spinner"></div>
        <p style="color: #000; font-weight: 600">Loading Application Data...</p>
      </div>

      <div id="main-content-wrapper" style="display: none">
        <main>
          <div class="sidebar">
            <h2
              class="section-title"
              style="border-bottom: none; margin-bottom: 5px"
            >
              Teacher Profile
            </h2>
            <div class="teacher-card">
              <img
                src="../../main/img/teacher.png"
                alt="Teacher Avatar"
                class="teacher-avatar"
                id="teacher-avatar"
              />
              <div class="teacher-name" id="teacher-name"></div>
              <div class="teacher-role" id="teacher-role"></div>
              <div class="school-name" id="school-name"></div>
            </div>
          </div>
          <div class="main-content">
            <h1 class="section-title">My Classes</h1>
            <div class="class-grid" id="class-grid">
              <div class="new-class-card green" id="new-class-link">
                <i class="fas fa-plus-circle"></i>
                New Class
              </div>
            </div>
            <a href="homepage_archive-teacher.html" class="archived-link"
              >Your Archived Classes ></a
            >
          </div>
        </main>
      </div>
    </div>

    <div id="new-class-modal" class="modal-overlay">
      <div class="modal-box new-class-modal-box">
        <a href="#" class="close-btn" onclick="hideModal('new-class-modal')"
          ><i class="fas fa-times"></i
        ></a>
        <p class="modal-title">Add New Class:</p>
        <div class="modal-input-group">
          <label for="new-class-name">Name:</label>
          <input
            type="text"
            id="new-class-name"
            class="modal-input"
            placeholder="e.g., Kinder Violet"
          />
        </div>

        <div class="modal-input-group">
          <label for="new-class-students">No. of Students:</label>
          <input
            type="number"
            id="new-class-students"
            class="modal-input"
            placeholder="e.g., 25"
            min="1"
          />
        </div>

        <div class="modal-buttons">
          <a href="#" class="btn btn-yes" id="add-class-btn">Add</a>
          <a href="#" class="btn btn-no" onclick="hideModal('new-class-modal')"
            >Cancel</a
          >
        </div>
      </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
      <div class="modal-box edit-modal-box">
        <a href="#" class="close-btn" onclick="hideModal('edit-modal')"
          ><i class="fas fa-times"></i
        ></a>
        <p class="modal-title">Edit Class:</p>
        <div class="modal-input-group">
          <label for="edit-class-name">Name:</label>
          <input type="text" id="edit-class-name" class="modal-input" />
        </div>
        <div class="modal-input-group">
          <label for="edit-class-number">Class Number:</label>
          <input
            type="text"
            id="edit-class-number"
            class="modal-input"
            placeholder="e.g., 101"
          />
        </div>
        <div class="modal-buttons">
          <a href="#" class="btn btn-yes" id="save-edit-btn">Save</a>
          <a href="#" class="btn btn-no" onclick="hideModal('edit-modal')"
            >Cancel</a
          >
        </div>
      </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-content">
          <p id="confirm-modal-text"></p>
        </div>
        <div class="modal-buttons">
          <a href="#" class="btn btn-yes" id="confirm-yes-btn">Yes</a>
          <a href="#" class="btn btn-no" id="confirm-no-btn">No</a>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
      // 1. YOUR FIREBASE CONFIGURATION
      // **IMPORTANT: Replace the placeholder values with your actual Firebase project configuration.**
      const firebaseConfig = {
        apiKey: "AIzaSyB7gwN-3GVlJ-a_MTBxqVnc7Oltq5wSvHQ",
        authDomain: "acadbird-379e3.firebaseapp.com",
        projectId: "acadbird-379e3",
        storageBucket: "acadbird-379e3.firebasestorage.app",
        messagingSenderId: "575491576951",
        appId: "1:575491576951:web:70f86aba1e33b871f8a272",
        measurementId: "G-N6Z672SXWJ",
      };

      // 2. Initialize Firebase App and Services
      firebase.initializeApp(firebaseConfig);

      window.auth = firebase.auth();
      window.db = firebase.firestore();

      console.log("Firebase initialized and global variables (auth, db) set!");

      // Helper function for modals used in the global onclick attributes
      window.hideModal = function (modalId) {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
          modalElement.classList.remove("show");
        }
      };
    </script>

    <script type="module">
      // File: homepage-teachers.js

      // Global variables initialized in the HTML script block
      // window.auth = firebase.auth();
      // window.db = firebase.firestore();
      // window.hideModal = function(id) { ... };
      console.log("LocalStorage user:", localStorage.getItem("user"));

      // --- DOM References and Global State ---
      const classGrid = document.getElementById("class-grid");
      const newClassLink = document.getElementById("new-class-link");
      const newClassNameInput = document.getElementById("new-class-name");
      const addClassBtn = document.getElementById("add-class-btn");
      const newClassStudentsInput =
        document.getElementById("new-class-students");

      const teacherNameHeader = document.getElementById("teacher-name-header");
      const teacherNameProfile = document.getElementById("teacher-name");
      const teacherRoleProfile = document.getElementById("teacher-role");
      const schoolNameProfile = document.getElementById("school-name");
      const teacherAvatar = document.getElementById("teacher-avatar");

      const newClassModal = document.getElementById("new-class-modal");
      const editModal = document.getElementById("edit-modal");
      const confirmModal = document.getElementById("confirm-modal");
      const confirmModalText = document.getElementById("confirm-modal-text");
      const confirmYesBtn = document.getElementById("confirm-yes-btn");
      const confirmNoBtn = document.getElementById("confirm-no-btn");
      const editClassNameInput = document.getElementById("edit-class-name");
      const editClassNumberInput = document.getElementById("edit-class-number");
      const saveEditBtn = document.getElementById("save-edit-btn");

      const mainContentWrapper = document.getElementById(
        "main-content-wrapper",
      );
      const loadingSpinner = document.getElementById("loading-spinner");

      let currentTeacherUid = null;
      let currentClasses = [];

      // --- Helper Functions ---

      function showModal(modalElement) {
        modalElement?.classList.add("show");
      }

      // Function to get a random class color
      const CLASS_COLORS = ["yellow", "green", "blue", "pink"];
      function getRandomColor() {
        return CLASS_COLORS[Math.floor(Math.random() * CLASS_COLORS.length)];
      }

      // Function to create a class card element
      async function createClassCard(classObj) {
        const card = document.createElement("div");
        card.className = `class-card ${classObj.color || getRandomColor()}`;
        card.setAttribute("data-class-id", classObj.id);

        // ✅ Get actual student count from Firestore - ONLY ACTIVE STUDENTS
        const studentCount = await getStudentCountForClass(classObj.id);
        console.log(
          `Class "${classObj.name}" has ${studentCount} active students.`,
        ); // Debug

        card.innerHTML = `
        <div class="card-icons">
            <a href="#" class="card-icon archive-icon"><i class="fas fa-archive"></i></a>
            <a href="#" class="card-icon edit-icon"><i class="fas fa-pencil-alt"></i></a>
           
        </div>
        <div class="class-name">${classObj.name}</div>
        <div class="student-count">${studentCount} students</div>
    `;

        card.addEventListener("click", (e) => {
          if (e.target.closest(".card-icons")) return;
          localStorage.setItem("selectedClassId", classObj.id);
          localStorage.setItem("selectedClassName", classObj.name);
          window.location.href = "homepage-classroom_teacher.html";
        });

        return card;
      }

      // Function to get student count for a class - ONLY ACTIVE STUDENTS
      async function getStudentCountForClass(classId) {
        try {
          const snapshot = await db
            .collection("students")
            .where("classroomId", "==", classId)
            .where("status", "==", "active") // ✅ Only count active students
            .get();
          return snapshot.size; // number of ACTIVE students in this class
        } catch (err) {
          console.error(
            "Failed to count active students for class",
            classId,
            err,
          );
          return 0;
        }
      }

      // Function to render all classes
      async function renderClasses() {
        const newClassCard = classGrid.querySelector(".new-class-card");
        classGrid.innerHTML = "";

        for (const c of currentClasses) {
          const card = await createClassCard(c); // ✅ wait for async student count
          classGrid.appendChild(card);
        }

        if (newClassCard) classGrid.appendChild(newClassCard);
      }

      // Function to load and display classrooms using a real-time listener
      function setupClassListener(uid) {
        const classesRef = db
          .collection("classrooms")
          .where("teacherId", "==", uid)
          .where("status", "==", "active");

        classesRef.onSnapshot((snapshot) => {
          currentClasses = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            currentClasses.push({
              id: doc.id,
              name: data.classroomName || "Unnamed Class",
              classNumber: data.classNumber || "", // Store class number
            });
          });

          console.log("Classes loaded:", currentClasses); // Debug
          renderClasses(); // Will now fetch ACTIVE student count per class
        });
      }

      // --- Firebase Data Functions ---

      // Function to load and display teacher profile data
      async function loadTeacherProfile(uid) {
        const userRef = db.collection("users").doc(uid);
        let data;

        try {
          const doc = await userRef.get();

          if (doc.exists) {
            data = doc.data();
          } else {
            // Create a placeholder profile if the teacher doesn't exist yet
            const placeholderData = {
              firstName: "Your",
              lastName: "Name",
              name: "Your Name",
              photoURL: "../../main/img/teacher.png", // ✅ default teacher photo
              role: "Teacher",
              school: "Your School",
            };
            await userRef.set(placeholderData);
            data = placeholderData;
          }

          // ✅ Build full name (firstName + lastName)
          const firstName = data.firstName || "";
          const lastName = data.lastName || "";
          const teacherName =
            (firstName + " " + lastName).trim() || "Your Name";

          const teacherRole = data.role || "Teacher";
          const schoolName = data.school || "Your School";
          const photoURL = data.photoURL || "../../main/img/teacher.png"; // ✅ fallback

          // ✅ Update UI
          teacherNameHeader.textContent = `${teacherName}'s Classes`;
          teacherNameProfile.textContent = teacherName;
          teacherRoleProfile.textContent = teacherRole;
          schoolNameProfile.textContent = schoolName;
          teacherAvatar.src = photoURL;

          // Hide spinner and show the main content
          if (loadingSpinner) {
            loadingSpinner.style.display = "none";
          }
          if (mainContentWrapper) {
            mainContentWrapper.style.display = "flex";
          }
        } catch (error) {
          console.error("Error fetching user profile:", error);
          alert(
            "Failed to load profile data. Check console and security rules.",
          );
          if (loadingSpinner) loadingSpinner.style.display = "none";
          if (mainContentWrapper) mainContentWrapper.style.display = "flex";
        }
      }

      // --- Firebase Authentication & Initialization ---

      const currentUser = JSON.parse(localStorage.getItem("user"));

      if (!currentUser || currentUser.role !== "teacher") {
        window.location.href = "../../main/html/login.html";
      } else {
        currentTeacherUid = currentUser.id; // ✅ Set the global UID
        loadTeacherProfile(currentUser.id);
        setupClassListener(currentUser.id);
      }

      // --- EVENT LISTENERS (CRUD Operations) ---

      // 1. Open New Class Modal
      newClassLink.addEventListener("click", (e) => {
        e.preventDefault();
        showModal(newClassModal);
      });

      addClassBtn.addEventListener("click", async (e) => {
        e.preventDefault();

        const name = newClassNameInput.value.trim();
        const studentCount = parseInt(newClassStudentsInput.value.trim(), 10);

        if (!name || !currentTeacherUid) {
          return alert(
            "Please wait for the application to load before adding a class.",
          );
        }

        if (isNaN(studentCount) || studentCount <= 0) {
          return alert("Please enter a valid number of students.");
        }

        const newClassData = {
          teacherId: currentTeacherUid,
          classroomName: name,
          noOfStudents: studentCount, // ✅ added field
          created_at: firebase.firestore.FieldValue.serverTimestamp(),
          status: "active",
        };

        try {
          await db.collection("classrooms").add(newClassData);
          window.hideModal("new-class-modal");
          newClassNameInput.value = "";
          newClassStudentsInput.value = ""; // ✅ clear input after saving
          console.log(
            `Class "${name}" added successfully with ${studentCount} students.`,
          );
        } catch (error) {
          console.error("Error adding class:", error);
          alert("Failed to add class. Check console for details.");
        }
      });

      // 3. Edit, Archive, Delete listeners (Delegated event handling)
      classGrid.addEventListener("click", (e) => {
        const classCard = e.target.closest(".class-card");
        if (!classCard) return;

        const classId = classCard.dataset.classId;
        const classObj = currentClasses.find((c) => c.id === classId);

        if (!classId || !classObj) return;

        const cardIcon = e.target.closest(".card-icon");

        if (cardIcon) {
          // Handle icon clicks
          e.preventDefault();
          e.stopPropagation();

          if (cardIcon.classList.contains("edit-icon")) {
            editClassNameInput.value = classObj.name;
            editClassNumberInput.value = classObj.classNumber || "";
            saveEditBtn.dataset.classId = classId;
            showModal(editModal);
          } else if (cardIcon.classList.contains("archive-icon")) {
            confirmModalText.textContent = `Are you sure you want to archive "${classObj.name}"?`;
            showModal(confirmModal);
            confirmYesBtn.onclick = () => archiveClass(classId);
            confirmNoBtn.onclick = () => window.hideModal("confirm-modal");
          }
        } else {
          // Clicked the card itself, not an icon → select class
          localStorage.setItem("selectedClassId", classId);
          window.location.href = "homepage-classroom_teacher.html";
        }
      });

      // 4. Save edited class name and number
      saveEditBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        const classId = saveEditBtn.dataset.classId;
        const newName = editClassNameInput.value.trim();
        const newClassNumber = editClassNumberInput.value.trim();

        if (!classId || !newName) return;

        try {
          const classRef = db.collection("classrooms").doc(classId);
          console.log("Updating path:", classRef.path);

          // Update both class name and class number
          const updateData = {
            classroomName: newName,
          };

          // Only add classNumber if it's provided
          if (newClassNumber) {
            updateData.classNumber = newClassNumber;
          }

          await classRef.update(updateData);
          console.log(
            `Class ${classId} renamed to "${newName}" with class number "${newClassNumber}".`,
          );
          window.hideModal("edit-modal");
        } catch (error) {
          console.error("Error updating class:", error);
          alert("Failed to save changes. Check console for details.");
        }
      });

      // 5. Archive class
      async function archiveClass(classId) {
        if (!classId) return;

        try {
          await db.collection("classrooms").doc(classId).update({
            status: "archived",
            archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });
          console.log(`Class ${classId} archived successfully.`);
          window.hideModal("confirm-modal");
        } catch (error) {
          console.error("Error archiving class:", error);
          alert("Failed to archive class. Check console for details.");
        }
      }
    </script>
  </body>
</html>
