<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AcadBird Dashboard</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../style/studentlistpage_teacher.css" />
  </head>
  <body>
    <div class="container">
      <nav class="navbar">
        <div class="logo">
          <img
            src="../../main/img/AcadBird - White no text.png"
            class="logo-img"
            alt="AcadBird Logo"
          />
          <img
            src="../../main/img/AcadBird - White Text.png"
            class="logo-text-img"
            alt="AcadBird Text"
          />Teacher
        </div>
        <img
          src="../../main/img/sunhill.png"
          alt="AcadBird"
          class="middle-logo"
        />
        <div class="nav-icons">
          <a href="notification_teacher.html" class="notification-link">
            <img
              src="../../main/img/Notification.png"
              alt="Notifications"
              class="icon"
            />
            <span class="notification-badge" id="notification-badge">0</span>
          </a>
          <a href="help_teacher.html">
            <img src="../../main/img/Help.png" alt="Help" class="icon" />
          </a>
          <a href="settings_teacher.html">
            <div class="account-menu">
              <img
                src="../../main/img/account icon.png"
                alt="User Account"
                class="icon"
              />
            </div>
          </a>
        </div>
      </nav>

      <div class="secondary-header">
        <div class="nav-menu">
          <a href="homepage-teachers.html" class="nav-item">Home</a>
          <a href="homepage-classroom_teacher.html" class="nav-item"
            >Classroom</a
          >
          <a href="participationoverview_teacher.html" class="nav-item"
            >Performance Log</a
          >
          <a href="activitylog_teacher.html" class="nav-item">Announcements</a>
          <a href="resources_teacher.html" class="nav-item">Resources</a>
          <a href="messages_teacher.html" class="nav-item">Messages</a>
          <a href="studentlistpage_teacher.html" class="nav-item active"
            >Student List</a
          >
        </div>
      </div>

      <div class="separator"></div>

      <div class="main-content">
        <div class="content-wrapper">
          <div class="student-section">
            <div class="section-header">
              <h2 class="section-title">Loading class...</h2>
              <select id="status-filter" class="status-filter">
                <option value="all">All Students</option>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
              </select>
            </div>
            <p class="section-subtitle">Kindergarten</p>

            <!-- Student grid without "Add Student" card -->
            <div class="student-grid" id="student-grid">
              <!-- Student cards will be dynamically added here -->
            </div>
          </div>

          <div id="loading-overlay">
            <div class="loader-3">
              <div class="circle"></div>
              <div class="circle"></div>
              <div class="circle"></div>
              <div class="circle"></div>
              <div class="circle"></div>
            </div>
          </div>

          <div class="sidebar">
            <div class="sidebar-box">
              <h3 id="student-count">0 Students</h3>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

      // Firebase Initialization
      import { firebaseConfig } from "../../main/js/firebaseConfig.js";

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const loadingOverlay = document.getElementById("loading-overlay");

      // Global Variables
      let students = [];

      function showLoading() {
        loadingOverlay.style.display = "flex";
      }

      function hideLoading() {
        loadingOverlay.style.display = "none";
      }

      // Notification badge functionality
      async function getTeacherClassrooms(teacherId) {
        try {
          const classroomsRef = collection(db, "classrooms");
          const q = query(classroomsRef, where("teacherId", "==", teacherId));
          const snapshot = await getDocs(q);

          const teacherClassrooms = {};
          snapshot.forEach((doc) => {
            teacherClassrooms[doc.id] = doc.data();
          });

          return teacherClassrooms;
        } catch (error) {
          console.error("Error getting teacher classrooms:", error);
          return {};
        }
      }

      async function getClassroomCapacity(classroomId) {
        try {
          const classRef = doc(db, "classrooms", classroomId);
          const classSnap = await getDoc(classRef);

          if (classSnap.exists()) {
            const data = classSnap.data();
            return {
              maxStudents: data.noOfStudents || data.maxStudents || 30,
            };
          }
          return { maxStudents: 30 };
        } catch (error) {
          console.error("Error getting classroom capacity:", error);
          return { maxStudents: 30 };
        }
      }

      async function loadClassroom(
        classroomId,
        classroomNameEl,
        classroomGradeEl,
      ) {
        const storedClassName = localStorage.getItem("selectedClassName");
        classroomNameEl.textContent = storedClassName || "Classroom";

        if (!classroomId) return;

        try {
          const classRef = doc(db, "classrooms", classroomId);
          const classSnap = await getDoc(classRef);

          if (classSnap.exists()) {
            const data = classSnap.data();
            classroomNameEl.textContent =
              data.classroomName || storedClassName || "Classroom";
            classroomGradeEl.textContent = data.grade || "";

            // Count actual students for display
            try {
              const q = query(
                collection(db, "students"),
                where("classroomId", "==", classroomId),
              );
              const snapshot = await getDocs(q);
              const currentStudentCount = snapshot.size;

              const capacity = await getClassroomCapacity(classroomId);
              const maxStudents = capacity.maxStudents || 30;

              const studentCountEl = document.getElementById("student-count");
              if (studentCountEl) {
                studentCountEl.textContent = `${currentStudentCount}/${maxStudents} Students`;
              }
            } catch (error) {
              console.error("Error counting students:", error);
              const studentCountEl = document.getElementById("student-count");
              if (studentCountEl) {
                studentCountEl.textContent = "Students";
              }
            }
          }
        } catch (err) {
          console.error("Failed to load classroom:", err);
          classroomNameEl.textContent =
            storedClassName || "Classroom (offline)";
        }
      }

      async function getReadNotifications(teacherId) {
        try {
          const notificationsRef = collection(db, "notification_teacher");
          const q = query(
            notificationsRef,
            where("teacherID", "==", teacherId),
            where("status", "==", "read"),
          );
          const snapshot = await getDocs(q);
          const readNotifications = {};
          snapshot.forEach((doc) => {
            const data = doc.data();
            const key = `${data.type}_${data.notificationID}`;
            readNotifications[key] = true;
          });
          return readNotifications;
        } catch (error) {
          console.error("Error getting read notifications:", error);
          return {};
        }
      }

      async function countUnreadNotifications(teacherId) {
        try {
          console.log(
            "ðŸ” Counting unread notifications for teacher:",
            teacherId,
          );

          // Get all calendar events
          const calendarRef = collection(db, "calendar");
          const calendarSnapshot = await getDocs(calendarRef);
          console.log("ðŸ“… Total calendar events:", calendarSnapshot.size);

          // Get teacher's classrooms
          const teacherClassrooms = await getTeacherClassrooms(teacherId);
          const teacherClassroomIds = Object.keys(teacherClassrooms);
          console.log("ðŸ« Teacher classroom IDs:", teacherClassroomIds);

          // Get all students with status "active" in teacher's classrooms
          let studentsSnapshot;
          if (teacherClassroomIds.length > 0) {
            const studentsRef = collection(db, "students");
            const studentsQuery = query(
              studentsRef,
              where("status", "==", "active"),
              where("classroomId", "in", teacherClassroomIds),
            );
            studentsSnapshot = await getDocs(studentsQuery);
            console.log(
              "ðŸ‘¥ Active students in classrooms:",
              studentsSnapshot.size,
            );
          } else {
            studentsSnapshot = { docs: [] };
            console.log("âŒ No classrooms found for teacher");
          }

          // Get all read notifications
          const readNotifications = await getReadNotifications(teacherId);
          console.log(
            "ðŸ“– Read notifications count:",
            Object.keys(readNotifications).length,
          );

          // Count unread calendar notifications - ONLY CURRENT AND FUTURE EVENTS
          const currentDate = new Date();
          currentDate.setHours(0, 0, 0, 0);

          let unreadCount = 0;
          calendarSnapshot.forEach((doc) => {
            const eventData = doc.data();
            const eventDate = new Date(eventData.date);
            eventDate.setHours(0, 0, 0, 0);

            // Only count if event is today or in the future
            if (eventDate >= currentDate) {
              const key = `calendar_${doc.id}`;
              if (!readNotifications[key]) {
                unreadCount++;
              }
            }
          });
          console.log("ðŸ“† Unread calendar notifications:", unreadCount);

          // Count unread student join notifications
          let studentUnreadCount = 0;
          studentsSnapshot.forEach((doc) => {
            const key = `student_${doc.id}`;
            if (!readNotifications[key]) {
              studentUnreadCount++;
            }
          });
          console.log("ðŸ‘¤ Unread student notifications:", studentUnreadCount);

          unreadCount += studentUnreadCount;
          console.log("ðŸ”¢ Total unread notifications:", unreadCount);

          return unreadCount;
        } catch (error) {
          console.error("âŒ Error counting unread notifications:", error);
          return 0;
        }
      }

      async function updateNotificationBadge() {
        try {
          const currentUser = auth.currentUser;

          if (!currentUser) {
            console.log("âŒ No current user found");
            return;
          }

          console.log(
            "ðŸ”„ Updating notification badge for user:",
            currentUser.uid,
          );
          const unreadCount = await countUnreadNotifications(currentUser.uid);
          const badge = document.getElementById("notification-badge");

          if (badge) {
            badge.textContent = unreadCount;

            // Hide badge if count is 0
            if (unreadCount === 0) {
              badge.style.display = "none";
              console.log("âœ… Badge hidden (no unread notifications)");
            } else {
              badge.style.display = "flex";
              console.log("âœ… Badge shown with count:", unreadCount);
            }
          } else {
            console.log("âŒ Badge element not found!");
          }
        } catch (error) {
          console.error("âŒ Error updating notification badge:", error);
        }
      }

      // Wait for auth state before updating badge
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          console.log("ðŸ‘¤ User authenticated:", user.uid);
          await updateNotificationBadge();
        } else {
          console.log("âŒ User not authenticated");
        }
      });

      // Create student card
      // Create student card - REMOVE STATUS TEXT
      function createStudentCard(student, studentGrid) {
        // Create card
        const card = document.createElement("div");
        card.classList.add("student-card");

        // Store student ID for navigation
        card.dataset.studentId = student.id;

        // Student name
        const nameEl = document.createElement("h3");
        nameEl.textContent = `${student.firstName} ${student.lastName}`;

        // Parent name
        const parentEl = document.createElement("p");
        parentEl.textContent = `Parent: ${student.parentName}`;

        // Append children (REMOVED STATUS ELEMENT)
        card.appendChild(nameEl);
        card.appendChild(parentEl);

        // Add click event to go to student info page
        card.addEventListener("click", () => {
          window.location.href = `studentlistpage_studentinfo.html?studentId=${student.id}`;
        });

        // Insert into student grid
        studentGrid.appendChild(card);
      }

      // Load Students from Firestore
      async function loadStudents(classroomId, studentGrid, studentCountEl) {
        if (!classroomId) return;

        try {
          const q = query(
            collection(db, "students"),
            where("classroomId", "==", classroomId),
          );
          const snapshot = await getDocs(q);

          students = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          renderStudents(studentGrid, studentCountEl);

          console.log(
            `âœ… Loaded ${students.length} students for classroom ${classroomId}`,
          );
        } catch (err) {
          console.error("âŒ Error loading students:", err);
        }
      }

      function renderStudents(studentGrid, studentCountEl) {
        const filterValue = document.getElementById("status-filter").value;

        // Clear old cards
        studentGrid
          .querySelectorAll(".student-card")
          .forEach((card) => card.remove());

        // Filter students
        let filtered = students;
        if (filterValue !== "all") {
          filtered = students.filter((s) => s.status === filterValue);
        }

        // Render cards
        filtered.forEach((student) => {
          createStudentCard(student, studentGrid);
        });

        // Update student count
        studentCountEl.textContent = `${filtered.length} Students`;
      }
      // Main Initialization
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("ðŸš€ DOM Content Loaded - Initializing student list page");

        // Update notification badge when page loads
        try {
          await updateNotificationBadge();
        } catch (error) {
          console.error("Error initializing notification badge:", error);
        }

        showLoading();

        let classroomId = new URLSearchParams(window.location.search).get(
          "classroomId",
        );

        const classroomNameEl = document.querySelector(".section-title");
        const classroomGradeEl = document.querySelector(".section-subtitle");
        const studentGrid = document.getElementById("student-grid");
        const studentCountEl = document.getElementById("student-count");

        if (!classroomId) {
          classroomId = localStorage.getItem("selectedClassId");
        }

        // Load classroom and students
        try {
          await loadClassroom(classroomId, classroomNameEl, classroomGradeEl);
          await loadStudents(classroomId, studentGrid, studentCountEl);
        } catch (err) {
          console.error("Error during initialization:", err);
        } finally {
          hideLoading();
        }

        // Add event listener for status filter
        document
          .getElementById("status-filter")
          .addEventListener("change", () => {
            renderStudents(studentGrid, studentCountEl);
          });
      });
    </script>
  </body>
</html>
