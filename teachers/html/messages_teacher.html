<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AcadBird - Messages</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="../style/messages_teacher.css">
</head>
<body>
    <div class="page-wrapper">
        <!-- Navbar -->
        <div class="navbar">
            <div class="navbar-container">
                <div class="logo">
                     <img src="../../main/img/AcadBird - White no text.png" alt="AcadBird" class="logo-img" />
                    <img src="../../main/img/AcadBird - White Text.png" class="logo-text-img" alt="AcadBird Text">
                </div>
                <img src="../../main/img/sunhill.png" alt="AcadBird" class="middle-logo" />
                <div class="nav-icons">
                       <a href="notification_teacher.html" title="Notifications" class="notification-link">
        <i class="fas fa-bell icon"></i>
        <span class="notification-badge" id="notification-badge">0</span>
    </a>
                    <a href="help_teacher.html" title="Help">
                        <i class="fas fa-question-circle icon"></i>
                    </a>
                    <a href="settings_teacher.html" title="Settings">
                        <div class="account-menu">
                            <i class="fas fa-user-circle icon"></i>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Secondary Header -->
        <div class="secondary-header">
           <div class="secondary-header-container">
               <nav class="nav-menu">
                    <a href="homepage-teachers.html" class="nav-item">Home</a>
                    <a href="homepage-classroom_teacher.html" class="nav-item">Classroom</a>
                    <a href="activitylog_teacher.html" class="nav-item">Activity Logs</a>
                    <a href="resources_teacher.html" class="nav-item">Resources</a>
                    <a href="messages_teacher.html" class="nav-item active">Messages</a>
                    <a href="studentlistpage_teacher.html" class="nav-item">Student List</a>
               </nav>
           </div>
        </div>
        
        <div class="separator"></div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="messages-container">
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="sidebar-header">
                        <div class="sidebar-title">Messages</div>
                        <button class="new-message-btn" id="new-message-btn">
                            <i class="fas fa-plus"></i> New Message
                        </button>
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Search conversations...">
                        </div>
                    </div>
                    
                    <div class="chat-section-title">Recent Conversations</div>
                    <ul class="chat-list" id="chat-list">
                        <!-- Dynamic content will be loaded here -->
                        <div class="loading-chats">Loading conversations...</div>
                    </ul>
                </div>

                <!-- Chat Window -->
                <div class="chat-window">
                    <div class="chat-header">
                        <div class="chat-user-info">
                            <div class="chat-user-avatar" id="chat-user-avatar">?</div>
                            <div class="chat-user-details">
                                <div class="chat-user-name" id="chat-user-name">Select a conversation</div>
                                <div class="chat-user-student" id="chat-user-student">Choose a parent to start messaging</div>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="chat-action-btn" title="Video call">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="chat-action-btn" title="Phone call">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="chat-action-btn" title="More options">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="chat-body" id="chat-body">
                        <div class="welcome-message">
                            <div class="welcome-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h3>Welcome to Messages</h3>
                            <p>Select a parent from the sidebar to start a conversation, or create a new message.</p>
                        </div>
                    </div>
                    
                    <div class="chat-input-container" style="display: none;" id="chat-input-container">
                        <button class="attachment-btn" title="Attach file">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="text" class="chat-input" id="message-input" placeholder="Type a message...">
                        <button class="send-btn" id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Message Modal -->
    <div id="new-message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">New Message</div>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="loading-recipients" id="loading-recipients">Loading parents...</div>
                <ul class="recipient-list" id="recipient-list">
                    <!-- Dynamic content will be loaded here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Add Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB7gwN-3GVlJ-a_MTBxqVnc7Oltq5wSvHQ",
        authDomain: "acadbird-379e3.firebaseapp.com",
        projectId: "acadbird-379e3",
        storageBucket: "acadbird-379e3.appspot.com",
        messagingSenderId: "575491576951",
        appId: "1:575491576951:web:70f86aba1e33b871f8a272",
        measurementId: "G-N6Z672SXWJ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Global variables
    let currentTeacher = null;
    let currentClassroomId = null;
    let currentChatId = null;
    let unsubscribeMessages = null;

    // Initialize the messaging system
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("üöÄ Initializing messages system");
        
        try {
            // Wait for authentication
            const user = await new Promise((resolve) => {
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    unsubscribe();
                    resolve(user);
                });
            });

            if (!user) {
                console.error("‚ùå No user authenticated");
                showErrorMessage("Please log in to access messages");
                return;
            }

            currentTeacher = user;
            console.log("üë§ Teacher authenticated:", currentTeacher.uid);

            // Get teacher's classroom
            await getTeacherClassroom();
            
            // Load parents and initialize messaging
            await initializeMessagingSystem();
            
            // Update notification badge
            await updateNotificationBadge();

        } catch (error) {
            console.error("‚ùå Error initializing messaging system:", error);
            showErrorMessage("Error loading messages. Please refresh the page.");
        }
    });

    // Show error message
    function showErrorMessage(message) {
        const chatList = document.getElementById('chat-list');
        chatList.innerHTML = `<div class="error-message">${message}</div>`;
    }

    // Get teacher's classroom
    async function getTeacherClassroom() {
        try {
            const snapshot = await db.collection('classrooms')
                .where('teacherId', '==', currentTeacher.uid)
                .limit(1)
                .get();

            if (snapshot.empty) {
                console.error("‚ùå No classroom found for teacher");
                showErrorMessage("No classroom assigned to you yet.");
                return;
            }

            const classroomDoc = snapshot.docs[0];
            currentClassroomId = classroomDoc.id;
            console.log("üè´ Classroom found:", currentClassroomId);

        } catch (error) {
            console.error("‚ùå Error getting teacher classroom:", error);
            throw error;
        }
    }

    // Load parents from the same classroom
    async function loadParents() {
        try {
            console.log("üë• Loading parents for classroom:", currentClassroomId);
            
            const parentsSnapshot = await db.collection('users')
                .where('role', '==', 'parent')
                .get();

            const parents = [];
            
            for (const parentDoc of parentsSnapshot.docs) {
                const parentData = parentDoc.data();
                
                // Check if parent has students in this classroom
                const studentsSnapshot = await db.collection('students')
                    .where('parentId', '==', parentDoc.id)
                    .where('classroomId', '==', currentClassroomId)
                    .get();

                if (!studentsSnapshot.empty) {
                    const student = studentsSnapshot.docs[0].data();
                    parents.push({
                        id: parentDoc.id,
                        name: `${parentData.firstName} ${parentData.lastName}`,
                        studentName: student.name,
                        studentId: studentsSnapshot.docs[0].id
                    });
                }
            }

            console.log("‚úÖ Parents loaded:", parents.length);
            return parents;

        } catch (error) {
            console.error("‚ùå Error loading parents:", error);
            return [];
        }
    }

    // Initialize the messaging system
    async function initializeMessagingSystem() {
        try {
            // Update loading state
            document.querySelector('.loading-chats').textContent = 'Loading parents...';

            // Load parents
            const parents = await loadParents();
            
            if (parents.length === 0) {
                showNoParentsMessage();
                return;
            }

            // Populate sidebar with parents
            populateChatList(parents);
            
            // Set up event listeners
            setupEventListeners();

            console.log("‚úÖ Messaging system initialized");

        } catch (error) {
            console.error("‚ùå Error initializing messaging system:", error);
            throw error;
        }
    }

    // Show no parents message
    function showNoParentsMessage() {
        const chatList = document.getElementById('chat-list');
        chatList.innerHTML = `
            <div class="no-parents-message">
                <i class="fas fa-users"></i>
                <h4>No Parents Found</h4>
                <p>There are no parents with students in your classroom yet.</p>
            </div>
        `;
    }

    // Populate chat list in sidebar
    function populateChatList(parents) {
        const chatList = document.getElementById('chat-list');
        chatList.innerHTML = '<div class="chat-section-title">Parents in Your Classroom</div>';

        parents.forEach(parent => {
            const chatItem = createChatItem(parent);
            chatList.appendChild(chatItem);
        });
    }

    // Create chat list item
    function createChatItem(parent) {
        const chatItem = document.createElement('li');
        chatItem.className = 'chat-item';
        chatItem.dataset.parentId = parent.id;
        chatItem.dataset.parentName = parent.name;
        chatItem.dataset.studentName = parent.studentName;

        const initials = parent.name.split(' ').map(n => n[0]).join('');

        chatItem.innerHTML = `
            <div class="avatar">${initials}</div>
            <div class="chat-info">
                <div class="chat-header">
                    <div class="chat-name">${parent.name}</div>
                    <div class="chat-time"></div>
                </div>
                <div class="chat-preview">Click to start conversation</div>
            </div>
            <div class="unread-badge" style="display: none;">0</div>
        `;

        // Add click event
        chatItem.addEventListener('click', () => openChat(parent));

        return chatItem;
    }

    // Open chat with parent
// Open chat with parent
// Open chat with parent - SIMPLIFIED VERSION
async function openChat(parent) {
    try {
        console.log("üí¨ Opening chat with:", parent.name);

        // Close previous real-time listener
        if (unsubscribeMessages) {
            unsubscribeMessages();
        }

        // Update UI
        updateChatHeader(parent);
        
        // Clear active states
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Set current chat active
        const chatItem = document.querySelector(`.chat-item[data-parent-id="${parent.id}"]`);
        if (chatItem) {
            chatItem.classList.add('active');
        }

        // Show chat interface
        document.getElementById('chat-input-container').style.display = 'flex';
        
        const welcomeMessage = document.querySelector('.welcome-message');
        if (welcomeMessage) {
            welcomeMessage.style.display = 'none';
        }

        // Get or create chat document
        currentChatId = await getOrCreateChat(parent.id);
        
        // Show loading state
        const chatBody = document.getElementById('chat-body');
        chatBody.innerHTML = '<div class="message-date">Loading messages...</div>';

        // Set up real-time listener ONLY - this handles both existing and new messages
        setupMessageListener(currentChatId);

        // Close modal if open
        document.getElementById('new-message-modal').style.display = 'none';

    } catch (error) {
        console.error("‚ùå Error opening chat:", error);
        alert('Error opening chat. Please try again.');
    }
}

// Set up real-time message listener - SIMPLIFIED VERSION
function setupMessageListener(chatId) {
    let initialLoad = true;

    unsubscribeMessages = db.collection('chats')
        .doc(chatId)
        .collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot((snapshot) => {
            const chatBody = document.getElementById('chat-body');
            
            // Clear chat body on initial load
            if (initialLoad) {
                chatBody.innerHTML = '';
                initialLoad = false;
            }

            // If no messages
            if (snapshot.empty && chatBody.innerHTML === '') {
                chatBody.innerHTML = '<div class="message-date">No messages yet. Start the conversation!</div>';
                return;
            }

            // Process all messages (both existing and new)
            snapshot.forEach(doc => {
                const message = doc.data();
                displayNewMessage(message);
                
                // Update chat preview for the last message
                if (doc === snapshot.docs[snapshot.docs.length - 1]) {
                    updateChatPreview(message);
                }
            });

        }, (error) => {
            console.error("‚ùå Error in message listener:", error);
            const chatBody = document.getElementById('chat-body');
            chatBody.innerHTML = '<div class="error-message">Error loading messages</div>';
        });
}

// Display new message with duplicate prevention
function displayNewMessage(message) {
    const chatBody = document.getElementById('chat-body');
    
    // Create a unique ID for the message to prevent duplicates
    const messageId = `msg-${message.timestamp?.toMillis() || Date.now()}-${message.senderId}`;
    
    // Check if message already exists
    if (document.getElementById(messageId)) {
        return; // Skip if already displayed
    }

    const messageDiv = createMessageElement(message);
    messageDiv.id = messageId;
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
}

async function getOrCreateChat(parentId) {
        try {
            // Try to find existing chat
            const existingChat = await db.collection('chats')
                .where('teacherId', '==', currentTeacher.uid)
                .where('parentId', '==', parentId)
                .limit(1)
                .get();

            if (!existingChat.empty) {
                console.log("‚úÖ Found existing chat");
                return existingChat.docs[0].id;
            }

            // Create new chat
            const newChat = {
                teacherId: currentTeacher.uid,
                parentId: parentId,
                classroomId: currentClassroomId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessage: '',
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
            };

            const docRef = await db.collection('chats').add(newChat);
            console.log("‚úÖ Created new chat:", docRef.id);
            
            return docRef.id;

        } catch (error) {
            console.error("‚ùå Error getting/creating chat:", error);
            throw error;
        }
    }

    // Load messages for a chat
    async function loadMessages(chatId) {
        try {
            const chatBody = document.getElementById('chat-body');
            chatBody.innerHTML = '<div class="message-date">Loading messages...</div>';

            const messagesSnapshot = await db.collection('chats')
                .doc(chatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .get();

            chatBody.innerHTML = '';

            if (messagesSnapshot.empty) {
                chatBody.innerHTML = '<div class="message-date">No messages yet. Start the conversation!</div>';
                return;
            }

            let currentDate = '';
            
            messagesSnapshot.forEach(doc => {
                const message = doc.data();
                const messageDate = message.timestamp?.toDate().toLocaleDateString();
                
                // Add date separator if date changed
                if (messageDate !== currentDate) {
                    currentDate = messageDate;
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'message-date';
                    dateDiv.textContent = messageDate;
                    chatBody.appendChild(dateDiv);
                }

                const messageDiv = createMessageElement(message);
                chatBody.appendChild(messageDiv);
            });

            chatBody.scrollTop = chatBody.scrollHeight;

        } catch (error) {
            console.error("‚ùå Error loading messages:", error);
            chatBody.innerHTML = '<div class="error-message">Error loading messages</div>';
        }
    }

    // Set up real-time message listener
function setupMessageListener(chatId) {
    // Clear the chat body first
    const chatBody = document.getElementById('chat-body');
    chatBody.innerHTML = '<div class="message-date">Loading messages...</div>';

    let initialLoad = true;
    let hasMessages = false;

    unsubscribeMessages = db.collection('chats')
        .doc(chatId)
        .collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot((snapshot) => {
            // Clear loading message on first load
            if (initialLoad && !snapshot.empty) {
                chatBody.innerHTML = '';
                initialLoad = false;
            }

            snapshot.docChanges().forEach((change) => {
                if (change.type === 'added') {
                    const message = change.doc.data();
                    
                    // Skip if this is the initial load and we're processing existing messages
                    // The real-time listener will handle new messages only
                    if (!initialLoad || !hasMessages) {
                        displayNewMessage(message);
                        hasMessages = true;
                        
                        // Update chat preview if this is the active chat
                        if (currentChatId === chatId) {
                            updateChatPreview(message);
                        }
                    }
                }
            });

            // If no messages after initial load
            if (initialLoad && snapshot.empty) {
                chatBody.innerHTML = '<div class="message-date">No messages yet. Start the conversation!</div>';
                initialLoad = false;
            }

        }, (error) => {
            console.error("‚ùå Error in message listener:", error);
            chatBody.innerHTML = '<div class="error-message">Error loading messages</div>';
        });
}
    // Create message element
    function createMessageElement(message) {
        const messageDiv = document.createElement('div');
        const isSent = message.senderId === currentTeacher.uid;
        
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        
        const time = message.timestamp?.toDate().toLocaleTimeString([], { 
            hour: '2-digit', minute: '2-digit' 
        }) || 'Just now';

        messageDiv.innerHTML = `
            ${message.text}
            <div class="message-time">${time}</div>
        `;

        return messageDiv;
    }

    // Display new message
    function displayNewMessage(message) {
        const chatBody = document.getElementById('chat-body');
        const messageDiv = createMessageElement(message);
        chatBody.appendChild(messageDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    // Update chat header
    function updateChatHeader(parent) {
        document.getElementById('chat-user-name').textContent = parent.name;
        document.getElementById('chat-user-student').textContent = `Parent of ${parent.studentName}`;
        document.getElementById('chat-user-avatar').textContent = 
            parent.name.split(' ').map(n => n[0]).join('');
    }

    // Update chat preview in sidebar
    function updateChatPreview(message) {
        const chatItem = document.querySelector('.chat-item.active');
        if (chatItem) {
            const preview = chatItem.querySelector('.chat-preview');
            const time = chatItem.querySelector('.chat-time');
            
            preview.textContent = message.text.length > 30 
                ? message.text.substring(0, 30) + '...' 
                : message.text;
            
            time.textContent = message.timestamp?.toDate().toLocaleTimeString([], { 
                hour: '2-digit', minute: '2-digit' 
            }) || 'Now';
        }
    }

    // Send message
    async function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const text = messageInput.value.trim();

        if (!text || !currentChatId) {
            return;
        }

        try {
            const message = {
                text: text,
                senderId: currentTeacher.uid,
                senderName: currentTeacher.displayName || 'Teacher',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            };

            // Add message to Firestore
            await db.collection('chats')
                .doc(currentChatId)
                .collection('messages')
                .add(message);

            // Update last message in chat document
            await db.collection('chats')
                .doc(currentChatId)
                .update({
                    lastMessage: text,
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                });

            // Clear input
            messageInput.value = '';

            console.log("‚úÖ Message sent");

        } catch (error) {
            console.error("‚ùå Error sending message:", error);
            alert('Error sending message. Please try again.');
        }
    }

    // Load recipients for modal
    async function loadRecipientsForModal() {
        try {
            const loadingElement = document.getElementById('loading-recipients');
            const recipientList = document.getElementById('recipient-list');
            
            loadingElement.style.display = 'block';
            recipientList.innerHTML = '';

            const parents = await loadParents();
            
            loadingElement.style.display = 'none';

            if (parents.length === 0) {
                recipientList.innerHTML = '<div class="no-recipients">No parents available</div>';
                return;
            }

            parents.forEach(parent => {
                const recipientItem = document.createElement('li');
                recipientItem.className = 'recipient-item';
                recipientItem.dataset.parentId = parent.id;
                recipientItem.dataset.parentName = parent.name;
                recipientItem.dataset.studentName = parent.studentName;

                const initials = parent.name.split(' ').map(n => n[0]).join('');

                recipientItem.innerHTML = `
                    <div class="recipient-avatar">${initials}</div>
                    <div class="recipient-info">
                        <div class="recipient-name">${parent.name}</div>
                        <div class="recipient-student">Parent of ${parent.studentName}</div>
                    </div>
                `;

                recipientItem.addEventListener('click', () => {
                    openChat(parent);
                    document.getElementById('new-message-modal').style.display = 'none';
                });
                recipientList.appendChild(recipientItem);
            });

        } catch (error) {
            console.error("‚ùå Error loading recipients:", error);
            document.getElementById('loading-recipients').textContent = 'Error loading parents';
        }
    }

    // Set up event listeners
    function setupEventListeners() {
        const sendBtn = document.getElementById('send-btn');
        const messageInput = document.getElementById('message-input');
        const newMessageBtn = document.getElementById('new-message-btn');
        const newMessageModal = document.getElementById('new-message-modal');
        const modalCloseBtn = document.querySelector('.close-btn');
        const searchInput = document.querySelector('.search-input');

        // Send message events
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        // Modal events
        newMessageBtn.addEventListener('click', () => {
            loadRecipientsForModal();
            newMessageModal.style.display = 'block';
        });
        
        modalCloseBtn.addEventListener('click', () => {
            newMessageModal.style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === newMessageModal) {
                newMessageModal.style.display = 'none';
            }
        });

        // Search functionality
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-item');
            
            chatItems.forEach(item => {
                const name = item.dataset.parentName.toLowerCase();
                const student = item.dataset.studentName.toLowerCase();
                
                if (name.includes(searchTerm) || student.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }

    // Keep your existing notification badge functions here...
    async function getTeacherClassrooms(teacherId) {
        try {
            const snapshot = await db.collection('classrooms')
                .where('teacherId', '==', teacherId)
                .get();
            
            const teacherClassrooms = {};
            snapshot.forEach(doc => {
                teacherClassrooms[doc.id] = doc.data();
            });
            
            return teacherClassrooms;
        } catch (error) {
            console.error("Error getting teacher classrooms:", error);
            return {};
        }
    }

    async function getReadNotifications(teacherId) {
        try {
            const snapshot = await db.collection('notification_teacher')
                .where('teacherID', '==', teacherId)
                .where('status', '==', 'read')
                .get();
                
            const readNotifications = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                const key = `${data.type}_${data.notificationID}`;
                readNotifications[key] = true;
            });
            return readNotifications;
        } catch (error) {
            console.error("Error getting read notifications:", error);
            return {};
        }
    }

    async function countUnreadNotifications(teacherId) {
        try {
            console.log("üîç Counting unread notifications for teacher:", teacherId);
            
            // Get all calendar events
            const calendarSnapshot = await db.collection('calendar').get();
            console.log("üìÖ Total calendar events:", calendarSnapshot.size);
            
            // Get teacher's classrooms
            const teacherClassrooms = await getTeacherClassrooms(teacherId);
            const teacherClassroomIds = Object.keys(teacherClassrooms);
            console.log("üè´ Teacher classroom IDs:", teacherClassroomIds);
            
            // Get all students with status "active" in teacher's classrooms
            let studentsSnapshot;
            if (teacherClassroomIds.length > 0) {
                studentsSnapshot = await db.collection('students')
                    .where('status', '==', 'active')
                    .where('classroomId', 'in', teacherClassroomIds)
                    .get();
                console.log("üë• Active students in classrooms:", studentsSnapshot.size);
            } else {
                studentsSnapshot = { docs: [] };
                console.log("‚ùå No classrooms found for teacher");
            }
            
            // Get all read notifications
            const readNotifications = await getReadNotifications(teacherId);
            console.log("üìñ Read notifications count:", Object.keys(readNotifications).length);
            
            // Count unread calendar notifications
            let unreadCount = 0;
            calendarSnapshot.forEach(doc => {
                const key = `calendar_${doc.id}`;
                if (!readNotifications[key]) {
                    unreadCount++;
                }
            });
            console.log("üìÜ Unread calendar notifications:", unreadCount);
            
            // Count unread student join notifications
            let studentUnreadCount = 0;
            studentsSnapshot.forEach(doc => {
                const key = `student_${doc.id}`;
                if (!readNotifications[key]) {
                    studentUnreadCount++;
                }
            });
            console.log("üë§ Unread student notifications:", studentUnreadCount);
            
            unreadCount += studentUnreadCount;
            console.log("üî¢ Total unread notifications:", unreadCount);
            
            return unreadCount;
        } catch (error) {
            console.error("‚ùå Error counting unread notifications:", error);
            return 0;
        }
    }

    async function updateNotificationBadge() {
        try {
            const currentUser = auth.currentUser;
            
            if (!currentUser) {
                console.log("‚ùå No current user found");
                return;
            }
            
            console.log("üîÑ Updating notification badge for user:", currentUser.uid);
            const unreadCount = await countUnreadNotifications(currentUser.uid);
            const badge = document.getElementById('notification-badge');
            
            if (badge) {
                badge.textContent = unreadCount;
                
                // Hide badge if count is 0
                if (unreadCount === 0) {
                    badge.style.display = 'none';
                    console.log("‚úÖ Badge hidden (no unread notifications)");
                } else {
                    badge.style.display = 'flex';
                    console.log("‚úÖ Badge shown with count:", unreadCount);
                }
            } else {
                console.log("‚ùå Badge element not found!");
            }
        } catch (error) {
            console.error("‚ùå Error updating notification badge:", error);
        }
    }
</script>

<style>
    /* Additional styles for loading states */
    .loading-chats, .loading-recipients {
        text-align: center;
        padding: 20px;
        color: #666;
        font-style: italic;
    }

    .error-message {
        text-align: center;
        padding: 20px;
        color: #e74c3c;
        background: #ffeaea;
        border-radius: 8px;
        margin: 10px;
    }

    .no-parents-message, .no-recipients {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }

    .no-parents-message i, .no-recipients i {
        font-size: 3rem;
        color: #bdc3c7;
        margin-bottom: 15px;
    }

    .no-parents-message h4, .no-recipients h4 {
        margin-bottom: 10px;
        color: #2c3e50;
    }

    .welcome-message {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }

    .welcome-icon {
        font-size: 4rem;
        color: #3498db;
        margin-bottom: 20px;
    }

    .welcome-message h3 {
        margin-bottom: 10px;
        color: #2c3e50;
    }

    .modal-body {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
</body>
</html>