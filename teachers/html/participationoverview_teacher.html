<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Activity Participation Overview</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="stylesheet" href="../style/participationoverview_teacher.css" />
  </head>
  <body>
    <div class="container">
      <div class="navbar">
        <div class="logo">
          <img
            src="../../main/img/AcadBird - White no text.png"
            alt="AcadBird"
            class="logo-img"
          />
          <img
            src="../../main/img/AcadBird - White Text.png"
            class="logo-text-img"
            alt="AcadBird Text"
          />Teacher
        </div>
        <img
          src="../../main/img/sunhill.png"
          alt="AcadBird"
          class="middle-logo"
        />
        <div class="nav-icons">
          <img
            src="../../main/img/Notification.png"
            alt="Notifications"
            class="icon"
          />
          <img src="../../main/img/Help.png" alt="Help" class="icon" />
          <div class="account-menu">
            <img
              src="../../main/img/account icon.png"
              alt="User Account"
              class="icon"
            />
          </div>
        </div>
      </div>
      <div class="secondary-header">
        <nav class="nav-menu">
          <a href="homepage-teachers.html" class="nav-item">Home</a>
          <a href="homepage-classroom_teacher.html" class="nav-item"
            >Classroom</a
          >
          <a href="participationoverview_teacher.html" class="nav-item active"
            >Performance Log</a
          >
          <a href="activitylog_teacher.html" class="nav-item">Announcements</a>
          <a href="resources_teacher.html" class="nav-item">Resources</a>
          <a href="messages_teacher.html" class="nav-item">Messages</a>
          <a href="studentlistpage_teacher.html" class="nav-item"
            >Student List</a
          >
        </nav>
      </div>
      <div class="separator"></div>

      <main class="main-content">
        <div class="overview-container">
          <header class="overview-header">
            <h1>Activity Participation Overview</h1>
            <div class="header-actions">
              <button class="action-btn add-activity-btn" id="addActivityBtn">
                Add Activity
              </button>
              <button class="action-btn quick-log-btn" id="quickLogBtn">
                Quick Activity Participation Log
              </button>
            </div>
          </header>

          <section class="student-participation-level">
            <h2 id="participation-class-title">
              Student Participation Level (Loading Class Name)
            </h2>

            <div class="participation-chart">
              <div class="chart-legend">
                <span class="legend-item"
                  ><span class="legend-color full"></span>Full</span
                >
                <span class="legend-item"
                  ><span class="legend-color partial"></span>Partial</span
                >
                <span class="legend-item"
                  ><span class="legend-color none"></span>None</span
                >
              </div>
              <div class="chart-container" id="participationChart"></div>
              <p class="chart-label">Total Participation Score</p>
            </div>
          </section>

          <div class="week-selector-container">
            <div class="week-selector">
              <div class="dropdown">
                <button class="dropdown-toggle">
                  Week of April 1 - 5
                  <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu hidden"></div>
              </div>
            </div>
            <div class="week-info">
              <span class="week-icon">üìö</span>
              <span class="date-icon">üóìÔ∏è</span>
            </div>
          </div>

          <section
            class="activity-participation-section"
            id="activityCardsContainer"
          ></section>
        </div>
      </main>
    </div>

    <div id="loading-overlay">
      <div class="loader-3">
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
      </div>
    </div>

    <div class="modal-overlay hidden" id="addActivityModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add Activity</h2>
          <button class="close-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div id="addActivityForm">
            <div class="form-group">
              <label for="add-activity-title">Activity Title:</label>
              <input
                type="text"
                id="add-activity-title"
                placeholder="e.g., Identifying the colors of the flag"
              />
            </div>
            <p class="participation-label">Participation:</p>
            <table class="participation-table" id="addActivityTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Full</th>
                  <th>Partial</th>
                  <th>None</th>
                  <th>Note</th>
                </tr>
                <tr>
                  <th>
                    <label
                      ><input type="checkbox" id="addSelectAllCheckbox" />
                      Select All</label
                    >
                  </th>
                  <td>
                    <input type="radio" name="add-select-all" value="full" />
                  </td>
                  <td>
                    <input type="radio" name="add-select-all" value="partial" />
                  </td>
                  <td>
                    <input type="radio" name="add-select-all" value="none" />
                  </td>
                  <td></td>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="modal-actions">
              <button class="action-btn log-participation-btn" id="addLogBtn">
                Log Participation
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-overlay hidden" id="quickLogModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Quick Activity Participation Log</h2>
          <button class="close-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="quick-activity-input">Activity:</label>
            <input
              type="text"
              id="quick-activity-input"
              placeholder="Enter activity title"
            />
          </div>
          <p class="participation-label">Participation:</p>
          <table class="participation-table" id="quickLogTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Full</th>
                <th>Partial</th>
                <th>None</th>
              </tr>
              <tr>
                <th>
                  <label
                    ><input type="checkbox" id="quickSelectAllCheckbox" />
                    Select All</label
                  >
                </th>
                <td>
                  <input type="radio" name="quick-select-all" value="full" />
                </td>
                <td>
                  <input type="radio" name="quick-select-all" value="partial" />
                </td>
                <td>
                  <input type="radio" name="quick-select-all" value="none" />
                </td>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="quick-log-actions">
            <button class="copy-previous-btn" id="copyPreviousBtn">
              Copy Participation from Previous Activity
            </button>
            <button class="log-participation-btn" id="quickLogBtnSubmit">
              Log Participation
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-overlay hidden" id="editActivityModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Activity</h2>
          <button class="close-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
          <div id="editActivityForm">
            <div class="form-group">
              <label for="edit-activity-title">Activity Title:</label>
              <input
                type="text"
                id="edit-activity-title"
                placeholder="e.g., Identifying the colors of the flag"
              />
            </div>
            <p class="participation-label">Participation:</p>
            <table class="participation-table" id="editActivityTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Full</th>
                  <th>Partial</th>
                  <th>None</th>
                  <th>Note</th>
                  <th>Action</th>
                </tr>
                <tr>
                  <th>
                    <label
                      ><input type="checkbox" id="editSelectAllCheckbox" />
                      Select All</label
                    >
                  </th>
                  <td>
                    <input type="radio" name="edit-select-all" value="full" />
                  </td>
                  <td>
                    <input
                      type="radio"
                      name="edit-select-all"
                      value="partial"
                    />
                  </td>
                  <td>
                    <input type="radio" name="edit-select-all" value="none" />
                  </td>
                  <td></td>
                  <td></td>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="modal-actions">
              <button
                class="action-btn log-participation-btn"
                id="updateActivityBtn"
              >
                Update Activity
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="confirmation-modal hidden" id="deleteConfirmationModal">
      <div class="confirmation-content">
        <h3 id="confirmationTitle">Confirm Deletion</h3>
        <p id="confirmationMessage">Are you sure you want to delete this?</p>
        <div class="confirmation-actions">
          <button class="confirm-btn" id="confirmDeleteBtn">Delete</button>
          <button class="cancel-btn" id="cancelDeleteBtn">Cancel</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay hidden" id="noteModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Student Note</h2>
          <button class="close-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
          <p id="noteText">This is a note</p>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        query,
        where,
        addDoc,
        updateDoc,
        deleteDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

      import { firebaseConfig } from "../../main/js/firebaseConfig.js";

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth();

      let teacherID = null;
      let STUDENTS = [];
      let activitiesData = [];
      let studentParticipationScores = [];
      const loadingOverlay = document.getElementById("loading-overlay");
      const COLOR_MAP = { high: "#79de87", medium: "#ffc107", low: "#ff5757" };

      let currentEditingActivity = null;
      let currentDeletingItem = null;
      let activityDocuments = {};

      onAuthStateChanged(auth, async (user) => {
        if (!user) return console.log("No user signed in.");
        teacherID = user.uid;

        showLoading();

        try {
          await fetchStudentsFromFirestore();
          await fetchActivitiesFromFirestore();
          generateWeeks();
          renderAll();

          const addActivityTableBody = document.querySelector(
            "#addActivityTable tbody",
          );
          populateStudentTables(addActivityTableBody);

          const quickLogTableBody = document.querySelector(
            "#quickLogTable tbody",
          );
          populateStudentTables(quickLogTableBody);

          initializeEditDeleteListeners();
        } catch (err) {
          console.error("Error loading data:", err);
        } finally {
          hideLoading();
        }
      });

      async function fetchStudentsFromFirestore() {
        try {
          const classroomID = localStorage.getItem("selectedClassId");
          if (!classroomID) return;

          const snapshot = await getDocs(
            query(
              collection(db, "students"),
              where("classroomId", "==", classroomID),
            ),
          );

          STUDENTS = snapshot.docs.map((doc) => {
            const data = doc.data();
            return {
              id: doc.id,
              fullName: `${data.firstName} ${data.lastName}`,
            };
          });

          STUDENTS.sort((a, b) => a.fullName.localeCompare(b.fullName));
        } catch (err) {
          console.error("Error fetching students:", err);
        }
      }

      let weeksData = [];

      function generateWeeks() {
        if (!activitiesData.length) return;

        const dates = activitiesData.map((a) => a.created_at.toDate());
        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));

        weeksData = [];
        let currentStart = new Date(minDate);
        currentStart.setHours(0, 0, 0, 0);

        let weekNum = 1;
        while (currentStart <= maxDate) {
          const currentEnd = new Date(currentStart);
          currentEnd.setDate(currentEnd.getDate() + 6);

          weeksData.push({
            weekLabel: `Week ${weekNum}: ${currentStart.toLocaleDateString()} - ${currentEnd.toLocaleDateString()}`,
            start: new Date(currentStart),
            end: new Date(currentEnd),
          });

          currentStart.setDate(currentStart.getDate() + 7);
          weekNum++;
        }

        populateWeekDropdown();
      }

      const weekInfoContainer = document.querySelector(".week-info");

      function updateWeekInfo(selectedWeek) {
        if (!selectedWeek.start || !selectedWeek.end) {
          weekInfoContainer.innerHTML = `
            <span class="week-icon">üìö</span>
            <p><strong>${selectedWeek.weekLabel}</strong></p>
          `;
        } else {
          weekInfoContainer.innerHTML = `
            <span class="week-icon">üìö</span>
            <p><strong>${selectedWeek.weekLabel}</strong></p>
            <span class="date-icon">üóìÔ∏è</span>
            <p>${selectedWeek.start.toLocaleDateString()} ‚Äì ${selectedWeek.end.toLocaleDateString()}</p>
          `;
        }
      }

      function recalculateAllScores() {
        studentParticipationScores = calculateScores(activitiesData);
      }

      function populateWeekDropdown() {
        const menu = document.querySelector(".dropdown-menu");
        if (!weeksData.length) return;

        const allWeeksOption = `<div class="dropdown-item" data-idx="-1">All Weeks</div>`;

        menu.innerHTML =
          allWeeksOption +
          weeksData
            .map(
              (week, idx) =>
                `<div class="dropdown-item" data-idx="${idx}">${week.weekLabel}</div>`,
            )
            .join("");

        const dropdownToggle = document.querySelector(".dropdown-toggle");
        dropdownToggle.innerHTML = `All Weeks <i class="fas fa-chevron-down"></i>`;

        renderActivityCards(activitiesData);
        updateWeekInfo({ weekLabel: "All Weeks", start: null, end: null });

        menu.querySelectorAll(".dropdown-item").forEach((item) => {
          item.addEventListener("click", (e) => {
            const idx = parseInt(e.target.dataset.idx);
            dropdownToggle.innerHTML = `${e.target.textContent} <i class="fas fa-chevron-down"></i>`;
            menu.classList.add("hidden");

            if (idx === -1) {
              renderActivityCards(activitiesData);
              const scores = calculateScores(activitiesData);
              renderParticipationChart(scores);
              updateWeekInfo({
                weekLabel: "All Weeks",
                start: null,
                end: null,
              });
            } else {
              const selectedWeek = weeksData[idx];
              const filteredActivities = activitiesData.filter((a) => {
                const createdDate = a.created_at.toDate();
                return (
                  createdDate >= selectedWeek.start &&
                  createdDate <= selectedWeek.end
                );
              });
              renderActivityCards(filteredActivities);
              const scores = calculateScores(filteredActivities);
              renderParticipationChart(scores);
              updateWeekInfo(selectedWeek);
            }
          });
        });
      }

      async function fetchActivitiesFromFirestore() {
        try {
          const classroomID = localStorage.getItem("selectedClassId");
          if (!classroomID) return;

          const q = query(
            collection(db, "activity"),
            where("classroomID", "==", classroomID),
          );
          const snapshot = await getDocs(q);

          activityDocuments = {};
          const rawActivities = snapshot.docs.map((doc) => {
            const data = doc.data();

            if (!activityDocuments[data.activityNo]) {
              activityDocuments[data.activityNo] = [];
            }
            activityDocuments[data.activityNo].push({
              docId: doc.id,
              studentID: data.studentID,
            });

            return {
              activityNumber: data.activityNo,
              description: data.activityName,
              participants: {
                [data.studentID]: {
                  level: data.activityScore,
                  note: data.note || "",
                },
              },
              created_at: data.created_at,
            };
          });

          const merged = {};
          rawActivities.forEach((a) => {
            if (!merged[a.activityNumber])
              merged[a.activityNumber] = { ...a, participants: {} };
            Object.assign(
              merged[a.activityNumber].participants,
              a.participants,
            );
          });

          activitiesData = Object.values(merged);
          recalculateAllScores();
          renderAll();
        } catch (err) {
          console.error("Error fetching activities:", err);
        }
      }

      function showLoading() {
        loadingOverlay.style.display = "flex";
      }

      function hideLoading() {
        loadingOverlay.style.display = "none";
      }

      function calculateScores(filteredActivities) {
        return STUDENTS.map((student) => {
          let totalScore = 0;
          let count = 0;

          filteredActivities.forEach((act) => {
            if (act.participants[student.id]) {
              const level =
                typeof act.participants[student.id] === "object"
                  ? act.participants[student.id].level
                  : act.participants[student.id];
              const points =
                level === "full" ? 100 : level === "partial" ? 50 : 0;
              totalScore += points;
              count++;
            }
          });

          const avgScore = count > 0 ? totalScore / count : 0;
          return { name: student.fullName, score: avgScore };
        });
      }

      const getBarColor = (score) =>
        score >= 70
          ? COLOR_MAP.high
          : score >= 30
            ? COLOR_MAP.medium
            : COLOR_MAP.low;

      const renderParticipationChart = (
        scores = studentParticipationScores,
      ) => {
        const participationChart =
          document.getElementById("participationChart");
        if (!participationChart) return;
        participationChart.innerHTML = "";

        scores
          .slice()
          .sort((a, b) => b.score - a.score)
          .forEach((student) => {
            const bar = document.createElement("div");
            bar.className = "chart-bar";

            const label = document.createElement("div");
            label.className = "chart-bar-label";
            label.textContent = student.name;

            const barBg = document.createElement("div");
            barBg.className = "bar-bg";

            const barFill = document.createElement("div");
            barFill.className = "bar-fill";
            barFill.style.width = `${student.score}%`;
            barFill.style.backgroundColor = getBarColor(student.score);

            const scoreDisplay = document.createElement("span");
            scoreDisplay.textContent = student.score.toFixed(0) + "%";
            scoreDisplay.style.position = "absolute";
            scoreDisplay.style.right = "5px";

            barBg.appendChild(barFill);
            bar.appendChild(label);
            bar.appendChild(barBg);
            bar.appendChild(scoreDisplay);

            participationChart.appendChild(bar);
          });
      };

      const renderActivityCards = (data = activitiesData) => {
        const activityCardsContainer = document.getElementById(
          "activityCardsContainer",
        );
        if (!activityCardsContainer) return;
        activityCardsContainer.innerHTML = "";

        data
          .slice()
          .reverse()
          .forEach((act) => {
            const card = document.createElement("div");
            card.className = "activity-card";
            const rowsHtml = Object.keys(act.participants)
              .map((id) => {
                const student = STUDENTS.find((s) => s.id === id);
                if (!student) return "";
                const participant = act.participants[id];
                const level =
                  typeof participant === "object"
                    ? participant.level
                    : participant;
                const note =
                  typeof participant === "object" ? participant.note || "" : "";
                return `<tr>
            <td>${student.fullName}</td>
            <td style="text-align:center;"><div class="participation-dot dot-${level}"></div></td>
            <td><i class="fas fa-eye view-note" data-note="${note}" title="View Note"></i></td>
          </tr>`;
              })
              .join("");

            card.innerHTML = `
        <div class="activity-card-header">
          <p>Activity ${act.activityNumber}</p>
          <p>${act.description}</p>
        </div>
        <table class="activity-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Participation Level</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
        <div class="activity-actions">
          <button class="edit-activity-btn" data-activity="${act.activityNumber}">Edit Activity</button>
          <button class="delete-activity-btn" data-activity="${act.activityNumber}">Delete Activity</button>
        </div>
      `;
            activityCardsContainer.appendChild(card);
          });

        initializeEditDeleteListeners();
      };
      const renderAll = () => {
        recalculateAllScores();
        renderParticipationChart();
        renderActivityCards();
      };

      const populateStudentTables = (tableBody, initialParticipants = {}) => {
        tableBody.innerHTML = "";
        STUDENTS.forEach((student) => {
          const level = initialParticipants[student.id] || "none";
          const note = initialParticipants[student.id + "_note"] || "";
          const nameSlug = student.fullName
            .replace(/\s/g, "-")
            .replace(/[^\w-]/g, "");

          const row = document.createElement("tr");
          row.dataset.studentId = student.id;

          row.innerHTML = `
            <td>${student.fullName}</td>
            <td><input type="radio" name="student-${nameSlug}" value="full" ${level === "full" ? "checked" : ""}></td>
            <td><input type="radio" name="student-${nameSlug}" value="partial" ${level === "partial" ? "checked" : ""}></td>
            <td><input type="radio" name="student-${nameSlug}" value="none" ${level === "none" ? "checked" : ""}></td>
            <td><input type="text" class="note-input" placeholder="Add note" value="${note}"></td>
          `;

          tableBody.appendChild(row);
        });
      };

      function initializeEditDeleteListeners() {
        // Edit activity buttons
        document.querySelectorAll(".edit-activity-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const activityNumber = parseInt(e.target.dataset.activity);
            openEditActivityModal(activityNumber);
          });
        });

        // Delete activity buttons
        document.querySelectorAll(".delete-activity-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const activityNumber = parseInt(e.target.dataset.activity);
            showDeleteConfirmation("activity", activityNumber);
          });
        });

        // Note: Removed delete-score-btn listeners since we removed that column
      }
      async function openEditActivityModal(activityNumber) {
        const activity = activitiesData.find(
          (a) => a.activityNumber === activityNumber,
        );
        if (!activity) return;

        currentEditingActivity = activity;

        document.getElementById("edit-activity-title").value =
          activity.description;

        const editActivityTableBody = document.querySelector(
          "#editActivityTable tbody",
        );
        editActivityTableBody.innerHTML = "";

        STUDENTS.forEach((student) => {
          const participant = activity.participants[student.id] || {
            level: "none",
            note: "",
          };
          const level =
            typeof participant === "object" ? participant.level : participant;
          const note =
            typeof participant === "object" ? participant.note || "" : "";
          const nameSlug = student.fullName
            .replace(/\s/g, "-")
            .replace(/[^\w-]/g, "");

          const row = document.createElement("tr");
          row.dataset.studentId = student.id;
          row.innerHTML = `
            <td>${student.fullName}</td>
            <td><input type="radio" name="student-${nameSlug}" value="full" ${level === "full" ? "checked" : ""}></td>
            <td><input type="radio" name="student-${nameSlug}" value="partial" ${level === "partial" ? "checked" : ""}></td>
            <td><input type="radio" name="student-${nameSlug}" value="none" ${level === "none" ? "checked" : ""}></td>
            <td><input type="text" class="note-input" placeholder="Add note" value="${note}"></td>
            <td><button class="delete-score-btn" data-student="${student.id}" title="Delete Score"><i class="fas fa-trash"></i></button></td>
          `;
          editActivityTableBody.appendChild(row);
        });

        setupEditSelectAllLogic();
        document.getElementById("editActivityModal").classList.remove("hidden");
      }

      function setupEditSelectAllLogic() {
        const editSelectAllCheckbox = document.getElementById(
          "editSelectAllCheckbox",
        );
        const editSelectAllRadios = document.querySelectorAll(
          'input[name="edit-select-all"]',
        );
        const editActivityTableBody = document.querySelector(
          "#editActivityTable tbody",
        );

        editSelectAllCheckbox.addEventListener("change", () => {
          if (editSelectAllCheckbox.checked) {
            const selectedRadio = Array.from(editSelectAllRadios).find(
              (radio) => radio.checked,
            );
            const levelToApply = selectedRadio ? selectedRadio.value : "none";
            applySelectAll(levelToApply, editActivityTableBody);
          } else {
            applySelectAll("none", editActivityTableBody);
          }
        });

        editSelectAllRadios.forEach((r) =>
          r.addEventListener("change", () => {
            if (editSelectAllCheckbox.checked) {
              applySelectAll(r.value, editActivityTableBody);
            }
          }),
        );

        editActivityTableBody
          .querySelectorAll(".delete-score-btn")
          .forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const studentId = e.target.closest("button").dataset.student;
              showDeleteConfirmation("score", {
                activityNumber: currentEditingActivity.activityNumber,
                studentId,
                inEditModal: true,
              });
            });
          });
      }

      function showDeleteConfirmation(type, data) {
        currentDeletingItem = { type, data };

        const modal = document.getElementById("deleteConfirmationModal");
        const title = document.getElementById("confirmationTitle");
        const message = document.getElementById("confirmationMessage");

        if (type === "activity") {
          const activity = activitiesData.find(
            (a) => a.activityNumber === data,
          );
          title.textContent = "Delete Activity";
          message.textContent = `Are you sure you want to delete "${activity.description}"? This action cannot be undone.`;
        } else if (type === "score") {
          const student = STUDENTS.find((s) => s.id === data.studentId);
          const activity = activitiesData.find(
            (a) => a.activityNumber === data.activityNumber,
          );
          title.textContent = "Delete Score";
          message.textContent = `Are you sure you want to delete ${student.fullName}'s score for "${activity.description}"?`;
        }

        modal.classList.remove("hidden");
      }

      async function handleDeletion() {
        if (!currentDeletingItem) return;

        const { type, data } = currentDeletingItem;

        try {
          if (type === "activity") {
            const activityIndex = activitiesData.findIndex(
              (a) => a.activityNumber === data,
            );
            if (activityIndex !== -1) {
              if (activityDocuments[data]) {
                for (const docInfo of activityDocuments[data]) {
                  await deleteDoc(doc(db, "activity", docInfo.docId));
                }
                delete activityDocuments[data];
              }

              activitiesData.splice(activityIndex, 1);
              recalculateAllScores();
              renderAll();
            }
          } else if (type === "score") {
            const activity = activitiesData.find(
              (a) => a.activityNumber === data.activityNumber,
            );
            if (activity && activity.participants[data.studentId]) {
              if (activityDocuments[data.activityNumber]) {
                const docToDelete = activityDocuments[data.activityNumber].find(
                  (docInfo) => docInfo.studentID === data.studentId,
                );
                if (docToDelete) {
                  await deleteDoc(doc(db, "activity", docToDelete.docId));
                  activityDocuments[data.activityNumber] = activityDocuments[
                    data.activityNumber
                  ].filter((docInfo) => docInfo.studentID !== data.studentId);
                }
              }

              delete activity.participants[data.studentId];
              recalculateAllScores();
              renderAll();

              if (data.inEditModal) {
                openEditActivityModal(data.activityNumber);
              }
            }
          }
        } catch (error) {
          console.error("Error deleting:", error);
          alert("There was an error deleting the item. Please try again.");
        } finally {
          currentDeletingItem = null;
          document
            .getElementById("deleteConfirmationModal")
            .classList.add("hidden");
        }
      }

      async function updateActivity() {
        if (!currentEditingActivity) return;

        const title = document
          .getElementById("edit-activity-title")
          .value.trim();
        if (!title) {
          alert("Enter activity title");
          return;
        }

        currentEditingActivity.description = title;

        const editActivityTableBody = document.querySelector(
          "#editActivityTable tbody",
        );
        const classroomID = localStorage.getItem("selectedClassId");

        for (const row of editActivityTableBody.querySelectorAll("tr")) {
          const studentId = row.dataset.studentId;
          const name = row.querySelector("td:first-child").textContent;
          const checked = row.querySelector(
            `input[name="student-${name.replace(/\s/g, "-").replace(/[^\w-]/g, "")}"]:checked`,
          );
          const noteInput = row.querySelector(".note-input");
          const note = noteInput ? noteInput.value.trim() : "";

          if (checked) {
            const newLevel = checked.value;

            currentEditingActivity.participants[studentId] = {
              level: newLevel,
              note: note,
            };

            try {
              if (activityDocuments[currentEditingActivity.activityNumber]) {
                const existingDoc = activityDocuments[
                  currentEditingActivity.activityNumber
                ].find((docInfo) => docInfo.studentID === studentId);

                if (existingDoc) {
                  await updateDoc(doc(db, "activity", existingDoc.docId), {
                    activityName: title,
                    activityScore: newLevel,
                    note: note,
                  });
                } else {
                  const newDocRef = await addDoc(collection(db, "activity"), {
                    activityName: title,
                    activityNo: currentEditingActivity.activityNumber,
                    activityScore: newLevel,
                    note: note,
                    classroomID,
                    created_at: new Date(),
                    studentID: studentId,
                    teacherID,
                  });

                  activityDocuments[currentEditingActivity.activityNumber].push(
                    {
                      docId: newDocRef.id,
                      studentID: studentId,
                    },
                  );
                }
              }
            } catch (error) {
              console.error("Error updating activity:", error);
            }
          } else if (currentEditingActivity.participants[studentId]) {
            delete currentEditingActivity.participants[studentId];

            if (activityDocuments[currentEditingActivity.activityNumber]) {
              const docToDelete = activityDocuments[
                currentEditingActivity.activityNumber
              ].find((docInfo) => docInfo.studentID === studentId);
              if (docToDelete) {
                await deleteDoc(doc(db, "activity", docToDelete.docId));
                activityDocuments[currentEditingActivity.activityNumber] =
                  activityDocuments[
                    currentEditingActivity.activityNumber
                  ].filter((docInfo) => docInfo.studentID !== studentId);
              }
            }
          }
        }

        recalculateAllScores();
        renderAll();
        document.getElementById("editActivityModal").classList.add("hidden");
        currentEditingActivity = null;
      }

      function applySelectAll(level, tableBody) {
        tableBody.querySelectorAll("tr").forEach((row) => {
          const studentName = row.querySelector("td:first-child").textContent;
          const nameSlug = studentName
            .replace(/\s/g, "-")
            .replace(/[^\w-]/g, "");
          row
            .querySelectorAll(`input[name="student-${nameSlug}"]`)
            .forEach((radio) => {
              radio.checked = radio.value === level;
            });
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const participationChart =
          document.getElementById("participationChart");
        const activityCardsContainer = document.getElementById(
          "activityCardsContainer",
        );
        const participationClassTitle = document.getElementById(
          "participation-class-title",
        );
        participationClassTitle.textContent = `Student Participation Level (${localStorage.getItem("selectedClassName") || "No class selected"})`;

        const addActivityModal = document.getElementById("addActivityModal");
        const quickLogModal = document.getElementById("quickLogModal");
        const editActivityModal = document.getElementById("editActivityModal");
        const addActivityBtn = document.getElementById("addActivityBtn");
        const quickLogBtn = document.getElementById("quickLogBtn");
        const closeButtons = document.querySelectorAll(".close-modal-btn");

        const addActivityTitleInput =
          document.getElementById("add-activity-title");
        const addActivityTableBody = document.querySelector(
          "#addActivityTable tbody",
        );
        const addSelectAllCheckbox = document.getElementById(
          "addSelectAllCheckbox",
        );
        const addSelectAllRadios = document.querySelectorAll(
          'input[name="add-select-all"]',
        );
        const addLogBtnSubmit = document.getElementById("addLogBtn");

        const quickActivityInput = document.getElementById(
          "quick-activity-input",
        );
        const quickLogTableBody = document.querySelector(
          "#quickLogTable tbody",
        );
        const quickSelectAllCheckbox = document.getElementById(
          "quickSelectAllCheckbox",
        );
        const quickSelectAllRadios = document.querySelectorAll(
          'input[name="quick-select-all"]',
        );
        const copyPreviousBtn = document.getElementById("copyPreviousBtn");
        const quickLogBtnSubmit = document.getElementById("quickLogBtnSubmit");

        const openModal = (modal) => modal.classList.remove("hidden");
        const closeModal = (modal) => modal.classList.add("hidden");

        closeButtons.forEach((btn) => {
          btn.addEventListener("click", function () {
            const modal = this.closest(".modal-overlay");
            closeModal(modal);
          });
        });

        document.addEventListener("click", (e) => {
          if (e.target.classList.contains("modal-overlay")) {
            closeModal(e.target);
          }
        });

        const dropdownToggle = document.querySelector(".dropdown-toggle");
        const dropdownMenu = document.querySelector(".dropdown-menu");

        dropdownToggle.addEventListener("click", () => {
          dropdownMenu.classList.toggle("hidden");
        });

        const noteModal = document.getElementById("noteModal");
        const noteText = document.getElementById("noteText");
        const noteCloseBtn = noteModal.querySelector(".close-modal-btn");

        activityCardsContainer.addEventListener("click", (e) => {
          const target = e.target;
          if (target.classList.contains("view-note")) {
            const note = target.dataset.note;
            noteText.textContent =
              note || "No note available for this student.";
            openModal(noteModal);
          }
        });

        noteCloseBtn.addEventListener("click", () => closeModal(noteModal));

        document
          .querySelector("#editActivityModal .close-modal-btn")
          .addEventListener("click", () => {
            document
              .getElementById("editActivityModal")
              .classList.add("hidden");
            currentEditingActivity = null;
          });

        document
          .getElementById("confirmDeleteBtn")
          .addEventListener("click", handleDeletion);
        document
          .getElementById("cancelDeleteBtn")
          .addEventListener("click", () => {
            document
              .getElementById("deleteConfirmationModal")
              .classList.add("hidden");
            currentDeletingItem = null;
          });

        document
          .getElementById("updateActivityBtn")
          .addEventListener("click", updateActivity);

        dropdownMenu.querySelectorAll(".dropdown-item").forEach((item) => {
          item.addEventListener("click", (e) => {
            const idx = parseInt(e.target.dataset.idx);
            dropdownToggle.innerHTML = `${e.target.textContent} <i class="fas fa-chevron-down"></i>`;
            dropdownMenu.classList.add("hidden");

            let filteredActivities = [];

            if (idx === -1) {
              filteredActivities = activitiesData;
              updateWeekInfo({
                weekLabel: "All Weeks",
                start: null,
                end: null,
              });
            } else {
              const selectedWeek = weeksData[idx];
              filteredActivities = activitiesData.filter((a) => {
                const createdDate = a.created_at.toDate();
                return (
                  createdDate >= selectedWeek.start &&
                  createdDate <= selectedWeek.end
                );
              });
              updateWeekInfo(selectedWeek);
            }

            const scores = calculateScores(filteredActivities);
            renderParticipationChart(scores);
            renderActivityCards(filteredActivities);
          });
        });

        document.addEventListener("click", (e) => {
          if (
            !dropdownToggle.contains(e.target) &&
            !dropdownMenu.contains(e.target)
          ) {
            dropdownMenu.classList.add("hidden");
          }
        });

        const setupSelectAllLogic = (checkbox, radios, tableBody) => {
          checkbox.addEventListener("change", () => {
            if (checkbox.checked) {
              const selectedRadio = Array.from(radios).find(
                (radio) => radio.checked,
              );
              const levelToApply = selectedRadio ? selectedRadio.value : "none";
              applySelectAll(levelToApply, tableBody);
            } else {
              applySelectAll("none", tableBody);
            }
          });

          radios.forEach((r) =>
            r.addEventListener("change", () => {
              if (checkbox.checked) {
                applySelectAll(r.value, tableBody);
              }
            }),
          );
        };

        setupSelectAllLogic(
          addSelectAllCheckbox,
          addSelectAllRadios,
          addActivityTableBody,
        );
        setupSelectAllLogic(
          quickSelectAllCheckbox,
          quickSelectAllRadios,
          quickLogTableBody,
        );

        addActivityBtn.addEventListener("click", async () => {
          await fetchStudentsFromFirestore();
          populateStudentTables(addActivityTableBody);
          addSelectAllCheckbox.checked = false;
          addActivityTitleInput.value = "";
          openModal(addActivityModal);
        });

        addLogBtnSubmit.addEventListener("click", async () => {
          const title = addActivityTitleInput.value.trim();
          if (!title) {
            alert("Enter activity title");
            return;
          }
          const classroomID = localStorage.getItem("selectedClassId");
          if (!classroomID) {
            alert("No classroom selected");
            return;
          }

          const participants = {};
          addActivityTableBody.querySelectorAll("tr").forEach((row) => {
            const id = row.dataset.studentId;
            const name = row.querySelector("td:first-child").textContent;
            const checked = row.querySelector(
              `input[name="student-${name.replace(/\s/g, "-").replace(/[^\w-]/g, "")}"]:checked`,
            );
            const noteInput = row.querySelector(".note-input");
            const note = noteInput ? noteInput.value.trim() : "";

            if (checked) {
              participants[id] = {
                level: checked.value,
                note: note,
              };
            }
          });

          // Calculate the next activity number
          const nextActivityNumber =
            activitiesData.length > 0
              ? Math.max(...activitiesData.map((a) => a.activityNumber)) + 1
              : 1;

          const newAct = {
            activityNumber: nextActivityNumber,
            description: title,
            participants,
            created_at: new Date(),
          };

          // Initialize activity documents for this new activity
          activityDocuments[nextActivityNumber] = [];

          // Save each participant to Firestore
          try {
            for (const id in participants) {
              const p = participants[id];
              const docRef = await addDoc(collection(db, "activity"), {
                activityName: title,
                activityNo: nextActivityNumber,
                activityScore: p.level,
                note: p.note || "",
                classroomID: classroomID,
                created_at: new Date(),
                studentID: id,
                teacherID: teacherID,
              });

              // Store document reference
              activityDocuments[nextActivityNumber].push({
                docId: docRef.id,
                studentID: id,
              });
            }

            // Add to local data
            activitiesData.push(newAct);
            recalculateAllScores();
            renderAll();
            closeModal(addActivityModal);

            // Show success message
            alert("Activity successfully added!");
          } catch (error) {
            console.error("Error adding activity:", error);
            alert("There was an error adding the activity. Please try again.");
          }
        });
        quickLogBtn.addEventListener("click", async () => {
          await fetchStudentsFromFirestore();
          populateStudentTables(quickLogTableBody);
          quickSelectAllCheckbox.checked = false;
          quickActivityInput.value = "";
          openModal(quickLogModal);
        });

        quickLogBtnSubmit.addEventListener("click", async () => {
          const title = quickActivityInput.value.trim();
          if (!title) {
            alert("Enter activity title");
            return;
          }
          const classroomID = localStorage.getItem("selectedClassId");
          if (!classroomID) {
            alert("No classroom selected");
            return;
          }

          const participants = {};
          quickLogTableBody.querySelectorAll("tr").forEach((row) => {
            const id = row.dataset.studentId;
            const name = row.querySelector("td:first-child").textContent;
            const checked = row.querySelector(
              `input[name="student-${name.replace(/\s/g, "-").replace(/[^\w-]/g, "")}"]:checked`,
            );
            participants[id] = checked ? checked.value : "none";
          });

          const newActivityNumber = activitiesData.length + 1;
          const newAct = {
            activityNumber: newActivityNumber,
            description: title,
            participants,
            created_at: new Date(),
          };
          activitiesData.push(newAct);

          activityDocuments[newActivityNumber] = [];

          for (const id in newAct.participants) {
            const level = newAct.participants[id];
            const docRef = await addDoc(collection(db, "activity"), {
              activityName: newAct.description,
              activityNo: newAct.activityNumber,
              activityScore: level,
              classroomID,
              created_at: new Date(),
              studentID: id,
              teacherID,
            });

            activityDocuments[newActivityNumber].push({
              docId: docRef.id,
              studentID: id,
            });
          }

          recalculateAllScores();
          renderAll();
          closeModal(quickLogModal);
        });

        copyPreviousBtn.addEventListener("click", () => {
          if (activitiesData.length === 0) {
            alert("No previous activity to copy from.");
            return;
          }

          const previousActivity = activitiesData[activitiesData.length - 1];
          let copiedCount = 0;

          quickLogTableBody.querySelectorAll("tr").forEach((row) => {
            const studentId = row.dataset.studentId;
            const name = row.querySelector("td:first-child").textContent;
            const nameSlug = name.replace(/\s/g, "-").replace(/[^\w-]/g, "");

            row
              .querySelectorAll(`input[name="student-${nameSlug}"]`)
              .forEach((radio) => {
                radio.checked = false;
              });

            if (previousActivity.participants[studentId]) {
              const previousLevel =
                typeof previousActivity.participants[studentId] === "object"
                  ? previousActivity.participants[studentId].level
                  : previousActivity.participants[studentId];

              const radioToCheck = row.querySelector(
                `input[name="student-${nameSlug}"][value="${previousLevel}"]`,
              );
              if (radioToCheck) {
                radioToCheck.checked = true;
                copiedCount++;
              }
            }
          });

          updateSelectAllCheckboxState(
            quickSelectAllCheckbox,
            quickLogTableBody,
          );
          alert(
            `Copied participation data for ${copiedCount} students from the previous activity!`,
          );
        });

        function updateSelectAllCheckboxState(checkbox, tableBody) {
          const rows = tableBody.querySelectorAll("tr");
          let allSame = true;
          let firstLevel = null;

          rows.forEach((row) => {
            const name = row.querySelector("td:first-child").textContent;
            const nameSlug = name.replace(/\s/g, "-").replace(/[^\w-]/g, "");
            const checkedRadio = row.querySelector(
              `input[name="student-${nameSlug}"]:checked`,
            );

            if (checkedRadio) {
              if (firstLevel === null) {
                firstLevel = checkedRadio.value;
              } else if (checkedRadio.value !== firstLevel) {
                allSame = false;
              }
            } else {
              allSame = false;
            }
          });

          if (allSame && firstLevel !== null) {
            checkbox.checked = true;
            const correspondingRadio = document.querySelector(
              `input[name="quick-select-all"][value="${firstLevel}"]`,
            );
            if (correspondingRadio) {
              correspondingRadio.checked = true;
            }
          } else {
            checkbox.checked = false;
          }
        }

        renderAll();
      });
    </script>
  </body>
</html>
