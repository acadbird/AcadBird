<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AcadBird Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="stylesheet" href="../style/homepage_parents.css" />
  </head>
  <body>
    <div class="container">
      <div class="navbar">
        <div class="logo">
          <img
            src="../../main/img/AcadBird - White no text.png"
            alt="AcadBird"
            class="logo-img"
          />
          <img
            src="../../main/img/AcadBird - White Text.png"
            class="logo-text-img"
            alt="AcadBird Text"
          />
        </div>

        <img
          src="../../main/img/sunhill.png"
          alt="AcadBird"
          class="middle-logo"
        />
        <div class="nav-icons">
          <a href="notification_parent.html" target="_blank">
            <img
              src="../../main/img/Notification.png"
              alt="Notifications"
              class="icon"
            />
          </a>
          <a href="help_parent.html" target="_blank">
            <img src="../../main/img/Help.png" alt="Help" class="icon" />
          </a>
          <a href="account_parent.html" target="_blank">
            <div class="account-menu">
              <img
                src="../../main/img/account icon.png"
                alt="User Account"
                class="icon"
              />
            </div>
          </a>
        </div>
      </div>
    </div>
    <div class="secondary-header">
      <div class="secondary-header-content">
        <div class="parent-name" id="parent-name">Loading...</div>
      </div>
    </div>
    <div class="separator"></div>

    <div class="main-content">
      <div class="content-panel left-panel">
        <div class="classes-box">
          <span class="section-title">Classes</span>
          <div class="class-list-container" id="class-list-container"></div>
        </div>
      </div>
      <div class="content-panel right-panel">
        <div id="student-list-container"></div>
        <div class="student-card add-card" id="add-student-card">
          <div class="add-card-content">
            <i class="fas fa-plus-circle"></i>
            <p>Add Student</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add a Child Through a Class Code:</h2>
          <span class="close-btn" id="close-modal-btn">&times;</span>
        </div>
        <label for="classCode">Code:</label>
        <input type="text" id="classCode" placeholder="Code" />
        <div class="modal-buttons">
          <button id="add-student-btn" class="btn-add">Add</button>
          <button id="cancel-btn" class="btn-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        query,
        where,
        doc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

      // ‚úÖ Firebase config
      import { firebaseConfig } from "../../main/js/firebaseConfig.js";

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      console.log("[Init] Firebase initialized", {
        projectId: firebaseConfig.projectId,
      });

      const studentListContainer = document.getElementById(
        "student-list-container",
      );
      const classListContainer = document.getElementById(
        "class-list-container",
      );
      const modal = document.getElementById("modal");
      const addStudentCard = document.getElementById("add-student-card");
      const parentNameEl = document.getElementById("parent-name");
      let studentsData = [];
      let activeStudentId = null;

      // üü¢ Auth listener
      onAuthStateChanged(auth, async (user) => {
        console.log("[AuthStateChanged] Triggered. User =", user);

        if (user) {
          const parentId = user.uid;
          console.log("[Auth] Logged in as:", parentId);

          // Save for debugging, but don‚Äôt *use* it again
          localStorage.setItem("DEBUG_parentId", parentId);

          // üü¢ Fetch parent profile from Firestore
          // üü¢ Fetch parent profile from "users" collection instead of "parents"
          try {
            const userRef = doc(db, "users", parentId); // <-- document ID = auth.uid
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
              const userData = userSnap.data();
              console.log("[User Data]", userData);

              const fullName =
                `${userData.firstName || ""} ${userData.lastName || ""}`.trim();
              parentNameEl.textContent = fullName || "Unnamed Parent";
            } else {
              parentNameEl.textContent = "Parent User";
            }
          } catch (err) {
            console.error("‚ùå Error fetching user profile:", err);
            parentNameEl.textContent = "Parent User";
          }

          loadStudents(parentId);
        } else {
          console.warn("[Auth] No user is logged in.");
          studentListContainer.innerHTML = `<p>Please log in to see your students.</p>`;
          classListContainer.innerHTML = "";
          parentNameEl.textContent = "Guest";
        }
      });

      addStudentCard.addEventListener("click", () => {
        console.log("[UI] Add student card clicked");
        modal.style.display = "flex";
      });
      function openModal() {
        console.log("[UI] Opening modal");
        modal.style.display = "flex"; // make sure your CSS uses "flex" or "block"
      }

      function closeModal() {
        console.log("[UI] Closing modal");
        modal.style.display = "none";
      }

      // üü¢ Load students by parentId (only ACTIVE students) with classroom validation
      async function loadStudents(parentId) {
        console.log("[loadStudents] called with parentId:", parentId);

        try {
          const q = query(
            collection(db, "students"),
            where("parentId", "==", parentId),
          );
          console.log("[loadStudents] Firestore query created");

          const snapshot = await getDocs(q);
          console.log(
            `[loadStudents] getDocs finished ‚Äî snapshot.size = ${snapshot.size}`,
          );

          if (snapshot.empty) {
            console.log(
              "[loadStudents] snapshot is empty ‚Äî no documents for this parentId",
            );
            studentListContainer.innerHTML = `<p style="padding:20px; color:#555; font-weight:600;">You are not in a classroom.</p>`;
            classListContainer.innerHTML = "";
            return;
          }

          snapshot.docs.forEach((docSnap) => {
            console.log("[loadStudents] raw doc:", {
              id: docSnap.id,
              data: docSnap.data(),
            });
          });

          // Check classroom existence for each student
          studentsData = [];
          for (const docSnap of snapshot.docs) {
            const data = docSnap.data();
            const student = { id: docSnap.id, ...data };

            // Check if classroom exists for this student
            const isActive = await validateStudentClassroom(student);

            if (isActive) {
              studentsData.push(student);
            } else {
              console.log(
                `[loadStudents] student ${student.id} has invalid classroom, filtering out`,
              );
            }
          }

          console.log(
            "[loadStudents] studentsData AFTER classroom validation:",
            studentsData,
          );

          if (studentsData.length === 0) {
            console.log(
              "[loadStudents] No active students with valid classrooms after filtering",
            );
            studentListContainer.innerHTML = `<p style="padding:20px; color:#555; font-weight:600;">No active students available.</p>`;
            classListContainer.innerHTML = "";
            return;
          }

          activeStudentId = studentsData[0].id;
          console.log(
            "[loadStudents] setting activeStudentId to:",
            activeStudentId,
          );

          renderStudentList();
        } catch (err) {
          console.error("‚ùå Error loading students:", err);
          studentListContainer.innerHTML = `<p style="padding:20px; color:red;">Error loading students.</p>`;
        }
      }

      // üü¢ Validate if student's classroom exists and update status if needed
      async function validateStudentClassroom(student) {
        try {
          // If student has no classroomId, mark as inactive
          if (!student.classroomId) {
            console.log(
              `[validateStudentClassroom] Student ${student.id} has no classroomId`,
            );
            if (student.status === "active") {
              await updateStudentStatus(student.id, "inactive");
            }
            return false;
          }

          // Check if classroom exists
          const classRef = doc(db, "classrooms", student.classroomId);
          const classSnap = await getDoc(classRef);

          if (!classSnap.exists()) {
            console.log(
              `[validateStudentClassroom] Classroom ${student.classroomId} not found for student ${student.id}`,
            );
            // Classroom doesn't exist, update student status to inactive
            if (student.status === "active") {
              await updateStudentStatus(student.id, "inactive");
            }
            return false;
          }

          // Classroom exists and is active
          const classData = classSnap.data();
          if (classData.status !== "active") {
            console.log(
              `[validateStudentClassroom] Classroom ${student.classroomId} is not active`,
            );
            if (student.status === "active") {
              await updateStudentStatus(student.id, "inactive");
            }
            return false;
          }

          // Student is properly active with valid classroom
          console.log(
            `[validateStudentClassroom] Student ${student.id} has valid classroom`,
          );
          return student.status === "active";
        } catch (error) {
          console.error(
            `‚ùå Error validating classroom for student ${student.id}:`,
            error,
          );
          // In case of error, assume classroom is invalid
          if (student.status === "active") {
            await updateStudentStatus(student.id, "inactive");
          }
          return false;
        }
      }

      // üü¢ Update student status in Firestore
      async function updateStudentStatus(studentId, newStatus) {
        try {
          const studentRef = doc(db, "students", studentId);
          await updateDoc(studentRef, {
            status: newStatus,
            lastUpdated: new Date(),
          });
          console.log(
            `[updateStudentStatus] Student ${studentId} status updated to ${newStatus}`,
          );
        } catch (error) {
          console.error(
            `‚ùå Error updating student ${studentId} status:`,
            error,
          );
        }
      }
      async function createClassCard(student) {
        console.log("[createClassCard] student:", student);
        const card = document.createElement("div");
        card.id = "class-card-" + student.id;
        card.className = "class-card active-class";

        let classroomText = "Classroom: Unassigned";
        let teacherText = "Unknown Teacher";
        let cardStyle = "";

        if (student.classroomId) {
          try {
            const classRef = doc(db, "classrooms", student.classroomId);
            const classSnap = await getDoc(classRef);

            if (classSnap.exists()) {
              const classData = classSnap.data();
              classroomText = `Classroom: ${classData.classroomName || "Unnamed"}`;

              if (classData.teacherId) {
                try {
                  const teacherRef = doc(db, "users", classData.teacherId);
                  const teacherSnap = await getDoc(teacherRef);

                  if (teacherSnap.exists()) {
                    const teacherData = teacherSnap.data();
                    teacherText =
                      `Teacher: ${teacherData.firstName || ""} ${teacherData.lastName || ""}`.trim();
                  }
                } catch (err) {
                  console.error("‚ùå Error fetching teacher data:", err);
                }
              }
            } else {
              // Classroom not found
              classroomText = "Classroom: Not Available";
              teacherText = "This classroom is no longer available";
              cardStyle = "style='opacity: 0.6; background-color: #f8f9fa;'";
            }
          } catch (err) {
            console.error("‚ùå Error fetching classroom:", err);
            classroomText = "Classroom: Error Loading";
            teacherText = "Unable to load classroom information";
            cardStyle = "style='opacity: 0.6; background-color: #f8f9fa;'";
          }
        }

        card.innerHTML = `
    <span class="child-name">${student.firstName} ${student.lastName}'s Class</span>
    <h3 style="margin:6px 0; font-size:1.05rem;">${classroomText}</h3>
    <p style="margin:0; font-size:0.95rem;">${teacherText}</p>
  `;

        if (cardStyle) {
          card.setAttribute(
            "style",
            cardStyle.replace("style='", "").replace("'", ""),
          );
        }

        // ‚úÖ Redirect on click only if classroom is valid
        card.onclick = () => {
          if (student.classroomId) {
            localStorage.setItem("selectedStudentId", student.id);
            window.location.href = "dashboard_parents.html";
          } else {
            alert("This student is not currently enrolled in any classroom.");
          }
        };

        return card;
      }
      function createStudentCard(student) {
        console.log("[createStudentCard] student:", student);
        const card = document.createElement("div");
        card.id = student.id;
        card.className = "student-card";
        if (student.id === activeStudentId) card.classList.add("active");

        card.innerHTML = `
    <i class="fas fa-user-circle" style="font-size:36px; margin-bottom:8px;"></i>
    <h4 style="margin:6px 0;">${student.firstName} ${student.lastName}</h4>
    <p style="margin:4px 0; font-size:0.9rem;">Status: 
      <span style="color:${student.status === "active" ? "green" : "gray"}">${student.status}</span>
    </p>
  `;
        card.onclick = () => selectStudent(student.id);
        return card;
      }

      async function renderClassList() {
        console.log("[renderClassList] activeStudentId:", activeStudentId);
        classListContainer.innerHTML = "";
        const student = studentsData.find((s) => s.id === activeStudentId);
        console.log("[renderClassList] student found:", student);
        if (student) {
          const card = await createClassCard(student); // <- wait for async function
          classListContainer.appendChild(card);
        }
      }

      async function renderStudentList() {
        console.log("[renderStudentList] count =", studentsData.length);
        studentListContainer.innerHTML = "";
        studentsData.forEach((student) => {
          studentListContainer.appendChild(createStudentCard(student));
        });
        await renderClassList(); // <- await here
      }

      function selectStudent(studentId) {
        console.log("[selectStudent] clicked:", studentId);
        activeStudentId = studentId;
        renderStudentList();
      }

      // üü¢ Add student
      async function addStudent() {
        const codeInput = document.getElementById("classCode");
        const code = codeInput.value.trim().toUpperCase();
        console.log("[addStudent] code entered:", code);

        if (!code || code.length !== 6) {
          alert("Please enter a valid 6-digit student code.");
          return;
        }

        if (!auth.currentUser) {
          alert("You must be logged in to add a student.");
          return;
        }

        const parentId = auth.currentUser.uid;
        console.log("[addStudent] parentId from auth:", parentId);

        try {
          const q = query(
            collection(db, "students"),
            where("parentId", "==", parentId),
            where("studentCode", "==", code),
          );
          console.log("[addStudent] query:", q);

          const snap = await getDocs(q);
          console.log("[addStudent] snap.size =", snap.size);

          if (snap.empty) {
            alert("Invalid code or student not linked to your account.");
            return;
          }

          const studentDoc = snap.docs[0];
          const studentRef = doc(db, "students", studentDoc.id);
          console.log("[addStudent] studentRef to update:", studentRef.id);

          await updateDoc(studentRef, { status: "active" });
          console.log("[addStudent] student updated to active");

          alert("Student successfully activated!");
          closeModal();

          loadStudents(parentId);
        } catch (err) {
          console.error("‚ùå Error activating student:", err);
          alert("Failed to activate student. Try again.");
        }
      }

      // =====================
      // Modal Functions
      // =====================

      // =====================
      // Attach Event Listeners
      // =====================
      document.addEventListener("DOMContentLoaded", () => {
        // Replace with real parentId from auth/localStorage in production

        // üîó Hook modal buttons
        document
          .getElementById("add-student-btn")
          .addEventListener("click", addStudent);
        document
          .getElementById("cancel-btn")
          .addEventListener("click", closeModal);
        document
          .getElementById("close-modal-btn")
          .addEventListener("click", closeModal);

        // Also hook the "Add Student" card to open modal
        document
          .getElementById("add-student-card")
          .addEventListener("click", openModal);
      });

      // üü¢ Remove DOMContentLoaded fallback
      // All logic happens only in onAuthStateChanged now
    </script>
  </body>
</html>
